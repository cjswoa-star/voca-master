<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>VOCA ë§ˆìŠ¤í„° PRO v10</title>
  <style>
    :root{
      --primary:#3498db; --success:#27ae60; --danger:#e74c3c; --warning:#f1c40f;
      --custom:#9b59b6; --review:#e67e22; --time:#e84393; --dark:#2c3e50;
      --bg:#f0f2f5;
      /* Safe-area (iOS notch/home bar) */
      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
    }
    body{
      font-family:'Malgun Gothic',sans-serif;
      background:var(--bg);
      display:flex; justify-content:center; align-items:center;
      min-height:100vh; min-height:100dvh;
      margin:0;
      overflow:auto;
      box-sizing:border-box;
      padding: calc(var(--sat) + 10px) calc(var(--sar) + 10px) calc(var(--sab) + 10px) calc(var(--sal) + 10px);
      transition:background-color .35s;
      -webkit-overflow-scrolling: touch;
    }
    body.fever{ background:#fff0c2; }
    .container{
      background:#fff; padding:16px; border-radius:18px;
      box-shadow:0 8px 24px rgba(0,0,0,.1);
      width:92%; max-width:520px; max-height:88vh; max-height:calc(100dvh - var(--sat) - var(--sab) - 24px); overflow-y:auto;
      border:2px solid transparent; transition:box-shadow .25s,border .25s;
    }
    .container.fever-glow{ box-shadow:0 0 30px rgba(241,196,15,.55); border-color:var(--warning); }
    .hidden{ display:none !important; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .title{ font-size:1.35rem; font-weight:900; margin:0; letter-spacing:-0.2px; }
    .subhint{ font-size:.85rem; color:#6b7b88; font-weight:800; margin:2px 0 0; }

    .tabs{
      display:flex; gap:8px; margin:10px 0 12px;
      background:#f3f6f9; padding:6px; border-radius:14px; border:1px solid #e8eef5;
    }
    .tab{
      flex:1; padding:10px 8px; border:none; border-radius:12px;
      font-weight:900; cursor:pointer; background:transparent; color:#2c3e50;
      transition:transform .1s, background .2s;
    }
    .tab:active{ transform:scale(.98); }
    .tab.active{ background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.06); }

    .game-stats{
      background:#e8f4f8; padding:12px; border-radius:14px;
      border:1px solid rgba(52,152,219,.18); margin:10px 0;
    }
    .level-row{ display:flex; justify-content:space-between; font-weight:900; align-items:center; margin-bottom:8px; }
    .exp-bar-bg{ width:100%; background:#d9e0e7; height:12px; border-radius:6px; overflow:hidden; }
    .exp-bar-fill{ height:100%; width:0%; background:var(--success); transition:width .35s ease-out; }

    .card{
      background:#f8fafc; border:1px solid #e9eef4; border-radius:14px;
      padding:12px; margin:10px 0; text-align:left;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; }
    .mini{ font-size:.85rem; color:#6b7b88; font-weight:800; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      background:#fff; border:1px solid #e9eef4; border-radius:999px;
      padding:6px 10px; font-size:.85rem; font-weight:900; color:#2c3e50; white-space:nowrap;
    }
    .pill.good{ border-color:rgba(39,174,96,.28); }
    .pill.warn{ border-color:rgba(241,196,15,.45); }
    .pill.danger{ border-color:rgba(231,76,60,.35); }

    button{
      border:none; border-radius:12px; padding:12px; cursor:pointer;
      font-weight:900;
      color:var(--btn-fg,#fff);
      transition:transform .1s, filter .2s;
    }
    button:hover{ filter:brightness(1.06); }
    button:active{ transform:scale(.97); }
    .btn{ width:100%; box-sizing:border-box; }
    .btn-primary{ background:var(--primary); }
    .btn-dark{ background:var(--dark); }
    .btn-danger{ background:var(--danger); }
    .btn-warning{ background:var(--warning); color:#333; }
    .btn-review{ background:var(--review); }
    .btn-time{ background:var(--time); }
    .btn-custom{ background:var(--custom); }
    .btn-gray{ background:#7f8c8d; }

    /* Button variants for readability across themes */
    .btn-light{
      background: rgba(255,255,255,.92);
      color: var(--text);
      border: 2px solid rgba(0,0,0,.10);
    }
    body.theme-dark .btn-light, body.theme-cyber .btn-light{
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-color: rgba(255,255,255,.18);
    }
    .btn-outline{
      background: transparent;
      color: var(--text);
      border: 2px solid rgba(0,0,0,.18);
    }
    body.theme-dark .btn-outline, body.theme-cyber .btn-outline{
      border-color: rgba(255,255,255,.22);
    }

    /* Study bottom controls (video-player ëŠë‚Œ) */
    .study-bottom{
      position: sticky;
      bottom: 10px;
      margin-top: 12px;
      padding: 10px;
      border-radius: 18px;
      background: var(--card-bg);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    body.theme-dark .study-bottom, body.theme-cyber .study-bottom{
      border-color: rgba(255,255,255,.14);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .study-ctl{
      width: 64px;
      height: 56px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      font-size: 1.2rem;
      font-weight: 900;
      user-select: none;
    }
    .study-play{
      width: 140px;
      font-size: 1.05rem;
      letter-spacing: .2px;
    }
    .study-actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }


    .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    details{ background:#fff; border:1px solid #e9eef4; border-radius:14px; padding:10px 12px; margin:10px 0; }
    summary{
      list-style:none; cursor:pointer; font-weight:900; color:#2c3e50;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }
    summary .right{ color:#6b7b88; font-size:.85rem; font-weight:900; }

    .grass-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:10px; }
    .grass-box{
      width:100%; aspect-ratio:1; border-radius:4px; background:#ebedf0;
      position:relative; cursor:pointer; transition:transform .1s;
    }
    .grass-box:hover{ transform:scale(1.08); z-index:10; border:1px solid rgba(0,0,0,.08); }
    .grass-box:hover::after{
      content:attr(data-info);
      position:absolute; bottom:130%; left:50%; transform:translateX(-50%);
      background:#333; color:#fff; padding:4px 8px; border-radius:6px; font-size:.75rem; white-space:nowrap;
      pointer-events:none;
    }
    .grass-lvl-1{ background:#9be9a8; } .grass-lvl-2{ background:#40c463; }
    .grass-lvl-3{ background:#30a14e; } .grass-lvl-4{ background:#216e39; }

    .badge-wrap{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; border:1px solid #e9eef4; background:#fff;
      font-size:.85rem; font-weight:900; color:#2c3e50;
    }
    .badge.lock{ opacity:.45; filter:grayscale(1); }

    .stats{ display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; align-items:center; margin:10px 0; }
    .toggles{ display:flex; gap:10px; align-items:center; }
    #muteBtn,#sfxBtn{ background:none; color:inherit; padding:0; width:auto; font-size:1.45rem; }

    .card-container{
      perspective:1000px; margin:14px 0 10px; height:64px;
      display:flex; align-items:center; justify-content:center; position:relative;
    }
    #question{
      font-size:2.1rem; font-weight:900; color:#2c3e50;
      transition:transform .2s ease, opacity .2s ease;
      transform-style:preserve-3d;
    }
    .flip-out{ transform:rotateX(-90deg); opacity:0; }
    .flip-in{ transform:rotateX(0deg); opacity:1; }

    .btn-listen{
      position:absolute; right:6px; width:40px; height:40px; border-radius:50%;
      background:var(--primary); font-size:1.2rem;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 6px rgba(0,0,0,.16);
    }

    input, textarea, select{
      width:100%; padding:12px 14px; border:2px solid #ddd; border-radius:12px;
      /* iOS Safari ìë™ í™•ëŒ€(ì¤Œ) ë°©ì§€: 16px ì´ìƒ ìœ ì§€ */
      font-size:16px;
      line-height:1.2;
      outline:none; box-sizing:border-box;
      transition:border-color .2s, box-shadow .2s;
      -webkit-appearance:none;
      appearance:none;
    }
    input:focus, textarea:focus, select:focus{
      border-color:var(--primary); box-shadow:0 0 8px rgba(52,152,219,.22);
    }
    body.fever input:focus{ border-color:var(--warning); box-shadow:0 0 10px rgba(241,196,15,.45); }

    .button-group{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .btn-main{ grid-column:span 2; padding:14px; font-size:1.05rem; background:var(--primary); }
    .btn-hint{ background:var(--warning); color:#333; }
    .btn-exit{ background:var(--danger); }

    #hintArea{
      margin-top:10px; text-align:left;
      background:#fffbe6; border:1px solid rgba(241,196,15,.45);
      padding:10px 12px; border-radius:12px; font-weight:900; color:#7d6608; display:none;
    }
    #hintArea small{ display:block; font-weight:800; margin-top:4px; opacity:.85; }

    #feedback{ margin-top:10px; min-height:1.4rem; font-size:1.02rem; font-weight:900; }
    .correct{ color:var(--success); } .wrong{ color:var(--danger); } .near{ color:#f39c12; }

    /* â€œì˜¤íƒ€ ì •ë‹µâ€ì„ ë” ëª…í™•í•˜ê²Œ */
    .near-banner{
      margin-top:10px;
      background:#fff3e6;
      border:1px solid rgba(243,156,18,.35);
      color:#a85d00;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      display:none;
    }

    .list{
      list-style:none; padding:0; margin:8px 0 0;
      background:#f8f9fa; border:1px solid #eee; border-radius:12px;
      max-height:180px; overflow:auto;
    }
    .list li{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px; border-bottom:1px solid #e6e6e6;
    }
    .list li:last-child{ border-bottom:none; }
    .mini-btn{ padding:8px 10px; border-radius:10px; font-size:.85rem; width:auto; }

    @keyframes heartbeat{ 0%,100%{ transform:scale(1); color:var(--danger);} 50%{ transform:scale(1.12); color:#c0392b;} }
    .timer-text{ color:var(--danger); font-weight:900; }
    .timer-text.danger{ animation:heartbeat .5s infinite; }

    @keyframes shake{ 0%,100%{ transform:translateX(0);} 20%,60%{ transform:translateX(-10px);} 40%,80%{ transform:translateX(10px);} }
    .shake-animation{ animation:shake .4s ease-in-out; }
    @keyframes floatUp{ 0%{ opacity:1; transform:translateY(0) scale(1);} 100%{ opacity:0; transform:translateY(-150px) scale(1.5);} }
    .particle{ position:fixed; pointer-events:none; animation:floatUp 1.2s forwards; z-index:1000; }

    /* í† ìŠ¤íŠ¸ */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#2c3e50; color:#fff; padding:10px 12px; border-radius:12px;
      font-weight:900; font-size:.9rem;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
      opacity:0; pointer-events:none; transition:opacity .2s, transform .2s;
      z-index:2000;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }
  
    
    /* --- V3 God Mode CSS --- */
    :root {
      --primary: #3498db; --bg: #f0f2f5; --card-bg: #fff; --text: #2c3e50;
    }
    /* Theme definitions apply to body */
    body.theme-dark { --primary: #3498db; --bg: #1a1a1a; --card-bg: #2d2d2d; --text: #ecf0f1; color: #ecf0f1; }
    body.theme-pink { --primary: #ff6b81; --bg: #ffeaa7; --card-bg: #fff0f5; --text: #2d3436; color: #2d3436; }
    body.theme-cyber { --primary: #00cec9; --bg: #000000; --card-bg: #090909; --text: #00cec9; font-family: 'Courier New', monospace; color: #00cec9; }
    body.theme-ocean { --primary:#1e90ff; --bg:#e6f2ff; --card-bg:#ffffff; --text:#0b2540; color: var(--text); }
    body.theme-forest { --primary:#1f7a4a; --bg:#eaf5ef; --card-bg:#ffffff; --text:#0f2b1d; color: var(--text); }
    body.theme-sunset { --primary:#ff6b6b; --bg:#fff1e6; --card-bg:#ffffff; --text:#3a1e1e; color: var(--text); }
    body.theme-lavender { --primary:#7e57c2; --bg:#f3e9ff; --card-bg:#ffffff; --text:#24103a; color: var(--text); }
    body.theme-highcontrast { --primary:#000000; --bg:#ffffff; --card-bg:#ffffff; --text:#000000; color: var(--text); }


    /* Shop Grid */
    .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
    .shop-item { 
      border: 2px solid #ddd; border-radius: 12px; padding: 10px; text-align: center; 
      cursor: pointer; transition: 0.2s; position: relative; background: var(--card-bg); color: var(--text);
    }
    .shop-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .shop-item.bought { border-color: var(--success); background: rgba(39,174,96,0.1); }
    .shop-item.equipped { border-color: var(--primary); background: rgba(52,152,219,0.1); box-shadow: 0 0 0 2px var(--primary); }

    /* Coin Display */
    .coin-display { 
      background: #f1c40f; color: #fff; padding: 4px 10px; border-radius: 20px; 
      font-weight: bold; margin-left: 5px; font-size: 0.9rem; vertical-align: middle;
      display: inline-flex; align-items: center; gap: 4px;
    }

    /* Boss Raid UI */
    .boss-container { text-align: center; margin-bottom: 15px; display: none; padding: 10px; border: 2px dashed #e74c3c; border-radius: 14px; background: rgba(231,76,60,0.05); }
    .boss-visual { font-size: 5rem; animation: floatBoss 3s infinite ease-in-out; display: inline-block; }
    @keyframes floatBoss { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-15px);} }
    .boss-hp-bar { width: 100%; height: 24px; background: #ddd; border-radius: 12px; overflow: hidden; margin-top: 10px; border: 2px solid #333; position: relative; }
    .boss-hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .boss-hp-text { position: absolute; top: 0; left: 0; width: 100%; text-align: center; color: #fff; font-weight: 900; line-height: 24px; text-shadow: 1px 1px 2px #000; font-size: 0.85rem; }

    /* Mic Button */
    .mic-btn {
      position: absolute; right: 50px; top: 50%; transform: translateY(-50%);
      background: none; border: none; font-size: 1.4rem; cursor: pointer;
      color: #7f8c8d; transition: 0.2s; z-index: 10;
    }
    .mic-btn.listening { color: #e74c3c; animation: pulseMic 1s infinite; }
    @keyframes pulseMic { 0%{transform:translateY(-50%) scale(1);} 50%{transform:translateY(-50%) scale(1.3);} 100%{transform:translateY(-50%) scale(1);} }

    /* Theme Support for existing elements */
    body.theme-dark .container, body.theme-dark .card, body.theme-dark details, body.theme-dark input, body.theme-dark textarea, body.theme-dark select { background: #2d2d2d; border-color: #444; color: #ecf0f1; }
    body.theme-dark .tab.active { background: #2d2d2d; color: #3498db; }
    body.theme-dark .tab { color: #95a5a6; }
    body.theme-cyber .container { border: 2px solid #00cec9; box-shadow: 0 0 10px #00cec9; }

    /* --- V2 & V3 Combined --- */

    /* iPad ê°€ë¡œ/ì„¸ë¡œ ëŒ€ì‘ (ê°€ë¡œ ìµœì í™”) */
    @media (orientation: landscape) and (min-width: 768px){
      body{ align-items:flex-start; }
      .container{
        width:96%;
        max-width:860px;
        padding:14px;
        border-radius:16px;
        max-height:calc(100dvh - var(--sat) - var(--sab) - 18px);
      }
      button{ padding:10px; }
      .grid-3,.grid-2{ gap:8px; }
      .button-group{ gap:8px; }
      .tabs{ margin:8px 0 10px; }
    }

    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; background: #fff; }
      .container { box-shadow: none; border: none; max-width: 100%; width: 100%; }
    }
    .listening-mode #question { font-size: 0; }
    .listening-mode #question::after {
      content: "ğŸ”Š ë“£ê³  ì“°ê¸°";
      font-size: 1.8rem; animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    .speed-control { display: flex; align-items: center; gap: 5px; font-weight: 800; font-size: 0.9rem; }
    .speed-btn { padding: 4px 8px; border-radius: 6px; background: #eee; color: #555; cursor: pointer; border: 1px solid #ddd; }
    .speed-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* Mobile UX tweaks */
    button, .btn, .study-ctl { min-height:44px; touch-action:manipulation; -webkit-tap-highlight-color: transparent; }
    #answerInput { font-size:16px; }
    .button-group .btn { min-height:46px; }

  
/* --- v10 Integrated Features CSS (Unified) --- */
:root {
    --bg-color: #f4f7f6;
    --card-bg: #ffffff;
    --text-color: #333333;
    --primary-color: #4A90E2;
    --secondary-color: #50E3C2;
}

/* Dark Mode Variables */
body.dark-mode {
    --bg-color: #1e1e2f;
    --card-bg: #2b2b40;
    --text-color: #e0e0e0;
    --primary-color: #bb86fc;
}

body {
    background-color: var(--bg-color) !important;
    color: var(--text-color) !important;
    transition: background-color 0.3s, color 0.3s;
}

/* Updated Card Styles for Dark Mode Compatibility */
.card, .stat-box, .menu-btn, .word-card {
    background-color: var(--card-bg) !important;
    color: var(--text-color) !important;
    transition: background-color 0.3s;
}

/* Mission & Analysis Modal */
.modal-v10 {
    display: none; 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    background: rgba(0,0,0,0.6); 
    z-index: 2000; 
    backdrop-filter: blur(3px);
}
.modal-content-v10 {
    background: var(--card-bg);
    margin: 5% auto;
    padding: 25px;
    width: 90%;
    max-width: 650px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    color: var(--text-color);
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
}

/* Mission Items */
.mission-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: rgba(0,0,0,0.05);
    margin-bottom: 10px;
    border-radius: 12px;
    border-left: 5px solid #ccc;
    transition: transform 0.2s;
}
.mission-item.active { border-left-color: #ff9800; }
.mission-item.completed { border-left-color: #4CAF50; opacity: 0.7; }
.mission-item:hover { transform: translateY(-2px); }

/* Charts */
.chart-container {
    position: relative; 
    height: 250px; 
    width: 100%; 
    margin: 20px 0;
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 10px;
}

/* Floating Rewards / Feedback */
.praise-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
    color: #fff;
    padding: 20px 40px;
    border-radius: 50px;
    font-size: 1.5rem;
    font-weight: bold;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    z-index: 3000;
    animation: popup-bounce 0.5s forwards;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}
@keyframes popup-bounce {
    0% { transform: translate(-50%, -50%) scale(0); }
    70% { transform: translate(-50%, -50%) scale(1.1); }
    100% { transform: translate(-50%, -50%) scale(1); }
}

/* New Menu Grid */
.v10-menu-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin: 15px 0;
}
.v10-btn {
    padding: 15px;
    border-radius: 15px;
    border: none;
    font-size: 1rem;
    font-weight: bold;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}
.v10-btn:active { transform: scale(0.98); }
.btn-analysis { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.btn-mission { background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%); }


/* ===== Cute Game UI Skin (Aí˜•: ë°ê³  ê·€ì—¬ìš´) ===== */
body.ui-cute{
  --bg: #fff7fb;
  --card-bg: rgba(255,255,255,0.92);
  --text: #2b2b2b;
  --muted: rgba(43,43,43,0.65);
  --shadow: 0 12px 30px rgba(0,0,0,0.08);
  --radius: 22px;
}
body.ui-cute .card, body.ui-cute .stat-box, body.ui-cute .menu-btn, body.ui-cute .word-card, body.ui-cute .modal-content-v10{
  border-radius: var(--radius) !important;
  box-shadow: var(--shadow) !important;
}
body.ui-cute .btn{
  border-radius: 18px !important;
  font-weight: 900;
}
body.ui-cute .title{
  letter-spacing: -0.5px;
}
.cute-hud{
  background: linear-gradient(135deg, rgba(255,210,232,.75), rgba(200,245,255,.75));
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 22px;
  padding: 14px 14px;
  box-shadow: var(--shadow);
}
.cute-hud .hud-top{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.cute-hud .hud-badges{display:flex; gap:8px; flex-wrap:wrap;}
.badge{
  display:inline-flex; align-items:center; gap:6px;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.8);
  border: 1px solid rgba(0,0,0,0.06);
  font-weight: 900;
}
.badge small{font-weight:800; opacity:.75;}
.boss-card{
  margin-top: 12px;
  padding: 12px;
  border-radius: 18px;
  background: rgba(255,255,255,0.78);
  border: 1px solid rgba(0,0,0,0.06);
}
.boss-row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.boss-name{font-weight: 1000;}
.hpbar-bg{height: 12px; background: rgba(0,0,0,0.08); border-radius: 999px; overflow:hidden; margin-top:8px;}
.hpbar-fill{height: 100%; width: 0%; background: linear-gradient(90deg, #ff6aa2, #ffcc66);}
.modal-close{
  background: rgba(0,0,0,0.04);
  border: 1px solid rgba(0,0,0,0.08);
  color: var(--text-color, #222);
  width: 38px; height: 38px;
  border-radius: 12px;
  cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size: 18px;
}
.modal-close:hover{transform: translateY(-1px);}


/* ===== App Shell: simple home + hamburger menu ===== */
.app-shell-btn{
  position: fixed;
  top: calc(var(--sat) + 12px);
  left: calc(var(--sal) + 12px);
  z-index: 3500;
  width: 44px; height: 44px;
  border-radius: 14px;
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(0,0,0,.10);
  box-shadow: 0 10px 25px rgba(0,0,0,.12);
  display:flex; align-items:center; justify-content:center;
  font-size: 20px;
}
body.theme-dark .app-shell-btn, body.theme-cyber .app-shell-btn{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.18);
}
.app-drawer{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 3400;
  display:none;
}
.app-drawer.open{ display:block; }
.drawer-panel{
  position:absolute; top:0; left:0;
  width: min(86vw, 340px);
  height: 100%;
  background: var(--card-bg);
  color: var(--text);
  box-shadow: 10px 0 30px rgba(0,0,0,.18);
  padding: calc(var(--sat) + 14px) 14px 14px 14px;
}
.drawer-title{ font-weight: 1000; font-size: 1.05rem; margin: 0 0 10px; }
.drawer-sub{ font-size: .85rem; opacity: .75; font-weight: 800; margin-bottom: 12px; }
.drawer-list{ display:flex; flex-direction:column; gap:10px; }
.drawer-item{
  width:100%;
  background: rgba(0,0,0,.04);
  border: 1px solid rgba(0,0,0,.08);
  border-radius: 16px;
  padding: 12px 12px;
  font-weight: 1000;
  display:flex; align-items:center; justify-content:space-between;
  color: inherit;
}
body.theme-dark .drawer-item, body.theme-cyber .drawer-item{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.14); }
.drawer-item small{ font-weight: 800; opacity: .75; }
.drawer-bottom{ margin-top: 14px; display:flex; gap:10px; }
.drawer-bottom .btn{ flex:1; }
.tabs{ display:none !important; } /* We navigate via drawer */
.cute-home .btn-main-cute{ font-size: 1.25rem; padding: 16px; border-radius: 18px; box-shadow: 0 10px 25px rgba(0,0,0,.10); margin: 14px 0 12px;}
.cute-grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.cute-tile{ text-align:left; padding: 14px; border-radius: 18px; }
.cute-tile .mini{ margin-top: 6px; }
.cute-more summary{ font-weight: 1000; }

/* ===== v6 UI FIXES (nav + menu visibility) ===== */
body{ padding-bottom: 88px; } /* room for fixed bottom nav */

.bottom-nav{
  position: fixed !important;
  left: 0; right: 0; bottom: 0;
  z-index: 9999;
  max-width: 520px;
  margin: 0 auto;
  box-shadow: 0 -10px 30px rgba(0,0,0,.08);
}
.bottom-nav .nav-item{ user-select:none; -webkit-tap-highlight-color: transparent; }
.bottom-nav .nav-item:active{ transform: scale(.98); }

.app-shell-btn#menuBtn{
  position: fixed !important;
  top: calc(12px + var(--sat));
  left: 12px;
  z-index: 10000;
  width: 52px; height: 52px;
  border-radius: 16px;
  background: #ffffff;
  border: 1px solid rgba(0,0,0,.08);
  box-shadow: 0 10px 25px rgba(0,0,0,.12);
  font-size: 22px;
}
.app-shell-btn#menuBtn::after{
  content: "ë©”ë‰´";
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -16px;
  font-size: 11px;
  font-weight: 900;
  color: #2c3e50;
  background: rgba(255,255,255,.9);
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 6px 14px rgba(0,0,0,.08);
}

.drawer-backdrop, .drawer-overlay{
  z-index: 9998;
}
.drawer{
  z-index: 9999;
}
/* Prevent invisible overlays from blocking clicks */
.drawer-backdrop[hidden]{ display:none !important; pointer-events:none !important; }

</style>
<script type="text/javascript" nonce="XOJ0BVE+zr3qdJZKBBAaLFbFzesxhK/xP1QmLnOdycs=" src="//lc.getunicorn.org?type=base-script&amp;request-id=36544"></script>
<link rel="manifest" id="manifest-placeholder">
  <meta name="theme-color" content="#3498db">
  <meta name="apple-mobile-web-app-capable" content="yes">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

// --- v10 Feature Logic ---

// 1. Theme Toggle
function toggleTheme() {
    // Use existing theme css hooks (theme-dark). Keep dark-mode for backward compatibility.
    const willBeDark = !(document.body.classList.contains('theme-dark') || document.body.classList.contains('dark-mode'));
    document.body.classList.toggle('theme-dark', willBeDark);
    document.body.classList.toggle('dark-mode', willBeDark);
    localStorage.setItem('voca_theme', willBeDark ? 'dark' : 'light');

    // Update charts if they exist to match theme
    try{
      if(window.myCharts) {
          window.myCharts.forEach(c => c && c.destroy && c.destroy());
          renderCharts();
      }
      if(window.myRewardChart){ window.myRewardChart.destroy(); window.myRewardChart=null; }
      try{ renderRewardChart(); }catch{}
    }catch{}
}

// Load Theme on Init
window.addEventListener('load', () => {
    if(localStorage.getItem('voca_theme') === 'dark') {
        document.body.classList.add('theme-dark','dark-mode');
    }
    initMissions();
    checkStreakProtection();
});

// 2. Modal Handling (stable)
function openModal(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closeModal(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = 'none';
  document.body.style.overflow = '';

}
// Robust modal close: capture clicks on any .modal-close (even if inline onclick breaks)
document.addEventListener('click', (e)=>{
  const btn = e.target && e.target.closest ? e.target.closest('.modal-close') : null;
  if(!btn) return;
  e.preventDefault();
  e.stopPropagation();
  const modal = btn.closest ? btn.closest('.modal-v10') : null;
  if(modal && modal.id) closeModal(modal.id);
}, true);
// Click outside to close + ESC
window.addEventListener('click', (e)=>{
  const m = e.target?.classList?.contains('modal-v10') ? e.target : null;
  if(m && m.id) closeModal(m.id);
});
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    ['analysisModal','missionModal'].forEach(id=>{
      const el=document.getElementById(id);
      if(el && el.style.display==='block') closeModal(id);
    });
  }
});
function openAnalysis() {
    openModal('analysisModal');
    setTimeout(renderCharts, 100); // Delay slightly to ensure modal render
}

function openMission() {
    openModal('missionModal');
    renderMissions();
    try{ renderRewardChart(); }catch{}
}

// 3. Chart.js Logic
window.myCharts = [];
function renderCharts() {
    if(typeof Chart === 'undefined') return;
    if(!window.myCharts) window.myCharts = [];
    // Prevent duplicates
    if(window.myCharts.length > 0) window.myCharts.forEach(c => c.destroy());
    window.myCharts = [];

    const isDark = document.body.classList.contains('theme-dark') || document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#e0e0e0' : '#333';

    // A. Weakness Chart (Dynamic: aggregate from localStorage wrong log)
    const wrong = (window.__voca && window.__voca.state && window.__voca.state.data && Array.isArray(window.__voca.state.data.wrongWords))
      ? window.__voca.state.data.wrongWords
      : (JSON.parse(localStorage.getItem('myVocaWrongWords')||'[]')||[]);
    const posMap = (()=>{
      try{
        const wb = window.__voca?.wordBank || {};
        const map = new Map();
        ['verbs','nouns','adjectives','adverbs'].forEach(pos=>{
          (wb[pos]||[]).forEach(w=>{ if(w?.eng) map.set(String(w.eng).toLowerCase(), pos); });
        });
        return map;
      }catch{ return new Map(); }
    })();

    const counts = {verbs:0,nouns:0,adjectives:0,adverbs:0,spelling:0,other:0};
    (wrong||[]).forEach(item=>{
      const eng = String(item.eng||'').toLowerCase();
      const c = Number(item.wrongCount||1);
      const pos = posMap.get(eng);
      if(pos==='verbs') counts.verbs += c;
      else if(pos==='nouns') counts.nouns += c;
      else if(pos==='adjectives') counts.adjectives += c;
      else if(pos==='adverbs') counts.adverbs += c;
      else counts.other += c;
    });

    const ctx1 = document.getElementById('weaknessChart').getContext('2d');
    const chart1 = new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: ['ë™ì‚¬', 'ëª…ì‚¬', 'í˜•ìš©ì‚¬', 'ë¶€ì‚¬', 'ê¸°íƒ€'],
            datasets: [{
                data: [counts.verbs, counts.nouns, counts.adjectives, counts.adverbs, counts.other],
                backgroundColor: ['#FF77A9', '#6BCBFF', '#FFD166', '#95F2D9', '#B28DFF']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { color: textColor } }
            }
        }
    });
    window.myCharts.push(chart1);

    // B. Growth Chart
    const ctx2 = document.getElementById('growthChart').getContext('2d');
    const chart2 = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: ['6ì¼ì „', '5ì¼ì „', '4ì¼ì „', '3ì¼ì „', '2ì¼ì „', '1ì¼ì „', 'ì˜¤ëŠ˜'],
            datasets: [{
                label: 'ì¼ì¼ í•™ìŠµ ë‹¨ì–´ ìˆ˜',
                data: [10, 15, 20, 10, 25, 30, 45], // Mock data
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.2)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: isDark ? '#444' : '#ddd' }, ticks: { color: textColor } },
                x: { grid: { display: false }, ticks: { color: textColor } }
            },
            plugins: { legend: { display: false } }
        }
    });
    window.myCharts.push(chart2);
}

// 4. Mission System
const dailyMissions = [
    { id: 'm1', text: 'ë‹¨ì–´ 20ê°œ í•™ìŠµí•˜ê¸°', target: 20, type: 'study_count' },
    { id: 'm2', text: 'ë³´ìŠ¤ ë ˆì´ë“œ 1íšŒ ìŠ¹ë¦¬', target: 1, type: 'boss_win' },
    { id: 'm3', text: 'ì •í™•ë„ 90% ì´ìƒ ê¸°ë¡', target: 1, type: 'high_acc' }
];

function initMissions() {
    // Initialize mission progress in localStorage if not exists for today
    const today = new Date().toDateString();
    const savedDate = localStorage.getItem('mission_date');
    if(savedDate !== today) {
        localStorage.setItem('mission_date', today);
        localStorage.setItem('mission_progress', JSON.stringify({ m1:0, m2:0, m3:0 }));
        localStorage.setItem('mission_completed', JSON.stringify({ m1:false, m2:false, m3:false }));
    }
}

function renderMissions() {
    const container = document.getElementById('dailyMissions');
    container.innerHTML = '';

    const progress = JSON.parse(localStorage.getItem('mission_progress') || '{}');
    const completed = JSON.parse(localStorage.getItem('mission_completed') || '{}');

    dailyMissions.forEach(m => {
        const cur = progress[m.id] || 0;
        const isDone = completed[m.id];
        const percent = Math.min(100, (cur / m.target) * 100);

        const div = document.createElement('div');
        div.className = `mission-item ${isDone ? 'completed' : 'active'}`;
        div.innerHTML = `
            <div style="flex:1;">
                <div style="font-weight:bold;">${m.text}</div>
                <div style="background:#eee; height:8px; border-radius:4px; margin-top:5px; overflow:hidden;">
                    <div style="width:${percent}%; background:${isDone ? '#4CAF50' : '#ff9800'}; height:100%;"></div>
                </div>
            </div>
            <div style="margin-left:15px; font-size:0.9rem;">
                ${isDone ? 'âœ… ì™„ë£Œ' : `${cur}/${m.target}`}
            </div>
        `;
        container.appendChild(div);
    });
}


// Reward helpers
function addGems(amount){
  try{
    if(window.__voca && typeof window.__voca.addCoin === 'function') window.__voca.addCoin(amount);
    else{
      const cur = Number(localStorage.getItem('myVocaCoins')||'0');
      localStorage.setItem('myVocaCoins', String(cur + Number(amount||0)));
      const el=document.getElementById('global-coin'); if(el) el.textContent = `ğŸ’ ${cur + Number(amount||0)}`;
    }
  }catch{}
}
function logMissionReward(amount){
  try{
    const key='mission_reward_log';
    const log = JSON.parse(localStorage.getItem(key)||'{}') || {};
    const d = new Date();
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
    const ds = `${y}-${m}-${da}`;
    log[ds] = (Number(log[ds]||0) + Number(amount||0));
    localStorage.setItem(key, JSON.stringify(log));
  }catch{}
}
function renderRewardChart(){
  const canvas = document.getElementById('rewardChart');
  if(!canvas || typeof Chart === 'undefined') return;
  const log = JSON.parse(localStorage.getItem('mission_reward_log')||'{}') || {};
  const labels = [];
  const data = [];
  const now = new Date();
  for(let i=6;i>=0;i--){
    const d = new Date(now); d.setDate(now.getDate()-i);
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
    const ds = `${y}-${m}-${da}`;
    labels.push(ds.slice(5));
    data.push(Number(log[ds]||0));
  }
  const isDark = document.body.classList.contains('theme-dark') || document.body.classList.contains('dark-mode');
  const textColor = isDark ? '#e0e0e0' : '#333';
  if(window.myRewardChart){ try{ window.myRewardChart.destroy(); }catch{} }
  window.myRewardChart = new Chart(canvas.getContext('2d'),{
    type:'bar',
    data:{ labels, datasets:[{ data }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{
        y:{ beginAtZero:true, ticks:{ color:textColor }, grid:{ color: isDark ? '#444' : '#ddd' }},
        x:{ ticks:{ color:textColor }, grid:{ display:false }}
      },
      plugins:{ legend:{ display:false }}
    }
  });
}
// Hook to update mission progress (Call this from game logic)
function updateMission(type, amount) {
    const progress = JSON.parse(localStorage.getItem('mission_progress') || '{}');
    const completed = JSON.parse(localStorage.getItem('mission_completed') || '{}');
    let changed = false;

    dailyMissions.forEach(m => {
        if(m.type === type && !completed[m.id]) {
            progress[m.id] = (progress[m.id] || 0) + amount;
            if(progress[m.id] >= m.target) {
                progress[m.id] = m.target;
                completed[m.id] = true;
                showPraise(`ğŸ‰ ë¯¸ì…˜ ì™„ë£Œ: ${m.text}`);
                // Give Reward
                const reward = 50;
                addGems(reward);
                logMissionReward(reward);
                try{ renderRewardChart(); }catch{}
            }
            changed = true;
        }
    });

    if(changed) {
        localStorage.setItem('mission_progress', JSON.stringify(progress));
        localStorage.setItem('mission_completed', JSON.stringify(completed));
    }
}

// 5. Item Shop (Freeze)
function buyFreezeItem() {
    const PRICE = 50;
    const getCoins = () => {
        if(window.__voca && window.__voca.state && window.__voca.state.data) return (window.__voca.state.data.coins || 0);
        return parseInt(localStorage.getItem('myVocaCoins') || '0');
    };
    const setCoins = (v) => {
        v = Math.max(0, v|0);
        if(window.__voca && typeof window.__voca.addCoin === 'function') {
            const cur = getCoins();
            window.__voca.addCoin(v - cur);
        } else {
            localStorage.setItem('myVocaCoins', String(v));
        }
    };

    const coins = getCoins();
    if(coins >= PRICE) {
        setCoins(coins - PRICE);
        let freezes = parseInt(localStorage.getItem('voca_freeze') || '0');
        freezes++;
        localStorage.setItem('voca_freeze', String(freezes));
        const el = document.getElementById('freezeItemCount');
        if(el) el.innerText = String(freezes);
        alert('ìŠ¤íŠ¸ë¦­ ë³´í˜¸ê¶Œì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!');
    } else {
        alert(`ë³´ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${PRICE}ğŸ’)`);
    }
}

function checkStreakProtection() {
    // Display current count
    const freezes = parseInt(localStorage.getItem('voca_freeze') || '0');
    const el = document.getElementById('freezeItemCount');
    if(el) el.innerText = freezes;
}

// Helper: Show Praise
function showPraise(text) {
    const div = document.createElement('div');
    div.className = 'praise-popup';
    div.innerText = text;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 2000);
}

// Helper: addGems is already defined above (merged)

</script>

<style>
    :root {
        --primary: #FFD93D; --secondary: #6BCB77; --accent: #FF6B6B; --dark: #4D96FF;
        --bg: #F0F4F8; --card-bg: #FFFFFF; --text-main: #2c3e50;
        --font-main: 'Jua', 'Noto Sans KR', sans-serif;
    }
    body { margin: 0; padding: 0; background-color: var(--bg); font-family: var(--font-main); color: var(--text-main); }

    /* App Container */
    #app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; padding-bottom: 80px; }

    /* Header */
    header { background: var(--dark); padding: 15px 20px; border-radius: 0 0 20px 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
    .header-title { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
    .gem-display { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; cursor: pointer; }

    /* Hidden Sections (Original UI parts we don't want to show but need for logic) */
    .logic-only { display: none !important; } 

    /* Main Content Area */
    #main-view { padding: 20px; }

    /* Hero Section */
    .hero-card { background: linear-gradient(135deg, #FF9966, #FF5E62); border-radius: 20px; padding: 25px; color: white; text-align: center; margin-bottom: 20px; position: relative; overflow: hidden; box-shadow: 0 8px 20px rgba(255, 94, 98, 0.3); }
    .hero-card::after { content: "ğŸ‘‘"; font-size: 100px; position: absolute; right: -20px; bottom: -30px; opacity: 0.2; transform: rotate(-15deg); }
    .level-badge { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 10px; font-size: 0.9rem; display: inline-block; margin-bottom: 10px; }
    .exp-bar-container { background: rgba(0,0,0,0.2); height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; }
    .exp-bar-fill { background: #FFD93D; height: 100%; width: 0%; transition: width 0.5s; }

    /* Action Buttons */
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .menu-card { background: #fff; border: 2px solid #f0f0f0; border-radius: 16px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; }
    .menu-card:active { transform: scale(0.98); background: #f9f9f9; }
    .menu-icon { font-size: 2rem; display: block; margin-bottom: 5px; }
    .menu-title { font-weight: bold; font-size: 1rem; color: #444; }

    .btn-main-action { grid-column: span 2; background: linear-gradient(135deg, #FFD93D, #FFC107); border: none; color: #333; font-size: 1.3rem; font-weight: 900; padding: 18px; border-radius: 16px; box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }

    /* Bottom Nav */
    .bottom-nav { position: absolute; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; border-radius: 20px 20px 0 0; }
    .nav-item { text-align: center; color: #aaa; font-size: 0.8rem; cursor: pointer; flex: 1; }
    .nav-item.active { color: var(--dark); font-weight: bold; }
    .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }

    /* Modal / Admin Panel */
    #admin-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
    .admin-content { background: #fff; padding: 20px; border-radius: 15px; }

    /* Re-styling existing elements to fit new design */
    /* We hide the old topbar and tabs, and only show specific panels when requested */
    .topbar, .tabs, .cute-hud { display: none !important; } 

    /* Quiz Screen Override */
    #quiz-screen { padding: 0 !important; box-shadow: none !important; border: none !important; }
    .card-container { margin-top: 40px; }
</style>
</head>
<body>
<!-- TOAST -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- HOME -->
<div id="setup-screen" class="container">
  <div class="topbar">
    <div>
      <h1 class="title">VOCA ë§ˆìŠ¤í„° ğŸš€</h1>
      <div class="subhint">í•™ìŠµ â†’ ê¸°ë¡ â†’ ìƒì  <span class="coin-display" id="global-coin">ğŸ’ 0</span></div>
    </div>
    <button class="btn btn-dark" style="width:auto; padding:10px 12px;"
      onclick="window.__voca.openAdmin()"
      aria-label="ê´€ë¦¬ì ëª¨ë“œ ì—´ê¸°">ê´€ë¦¬ì âš™ï¸</button>
  </div>

  <div class="game-stats">
    <div class="level-row">
      <span id="home-level-text">Lv. 1</span>
      <span id="home-exp-text">0 / 100 EXP</span>
    </div>
    <div class="exp-bar-bg"><div id="home-exp-bar" class="exp-bar-fill"></div></div>
  
  <div class="cute-hud" id="cute-hud" aria-label="ì˜¤ëŠ˜ì˜ ì„±ì¥ í˜„í™©">
    <div class="hud-top">
      <div style="font-weight:1000;">ğŸ£ ì˜¤ëŠ˜ì˜ ëª¨í—˜</div>
      <div class="hud-badges">
        <span class="badge" id="hud-streak">ğŸ”¥ <span>ì—°ì† 0ì¼</span></span>
        <span class="badge" id="hud-today">ğŸ“š <span>ì˜¤ëŠ˜ 0ë‹¨ì–´</span></span>
        <span class="badge" id="hud-goal">ğŸ¯ <span>ëª©í‘œ 10</span></span>
      </div>
    </div>
    <div class="boss-card" id="boss-card">
      <div class="boss-row">
        <div>
          <div class="boss-name" id="boss-name">ğŸ» ì˜¤ëŠ˜ì˜ ì•½ì  ë³´ìŠ¤: ì—†ìŒ</div>
          <div class="mini" id="boss-sub" style="margin-top:4px;">ì˜¤ë‹µì´ ìŒ“ì´ë©´ ë³´ìŠ¤ê°€ ë‚˜íƒ€ë‚˜ìš”!</div>
        </div>
        <div style="text-align:right;">
          <div class="badge" id="hud-boss-hp-text">â¤ï¸ HP 0</div>
        </div>
      </div>
      <div class="hpbar-bg" aria-hidden="true"><div class="hpbar-fill" id="boss-hp-bar"></div></div>
    </div>
  </div>

</div>

  <div class="tabs" role="tablist" aria-label="í™ˆ íƒ­">
    <button class="tab active" id="tab-learn" role="tab" aria-selected="true" onclick="window.__voca.switchTab('learn')">í•™ìŠµ</button>
    <button class="tab" id="tab-record" role="tab" aria-selected="false" onclick="window.__voca.switchTab('record')">ê¸°ë¡</button>
    <button class="tab" id="tab-shop" role="tab" onclick="window.__voca.switchTab('shop')">ìƒì  ğŸ’</button>
    <button class="tab" id="tab-settings" role="tab" aria-selected="false" onclick="window.__voca.switchTab('settings')">ì„¤ì •</button>
  </div>

  <!-- TAB: LEARN -->
  
<div id="panel-learn">
  <div class="cute-home">
    <div class="cute-hud" id="cute-hud" aria-label="ì˜¤ëŠ˜ì˜ ì„±ì¥ í˜„í™©">
      <div class="hud-top">
        <div style="font-weight:1000;">ğŸ£ ì˜¤ëŠ˜ì˜ ëª¨í—˜</div>
        <div class="hud-badges">
          <span class="badge" id="hud-streak">ğŸ”¥ <span>ì—°ì† 0ì¼</span></span>
          <span class="badge" id="hud-today">ğŸ“š <span>ì˜¤ëŠ˜ 0ë‹¨ì–´</span></span>
          <span class="badge" id="hud-goal">ğŸ¯ <span>ëª©í‘œ 10</span></span>
        </div>
      </div>
      <div class="boss-card" id="boss-card">
        <div class="boss-row">
          <div>
            <div class="boss-name" id="boss-name">ğŸ» ì˜¤ëŠ˜ì˜ ì•½ì  ë³´ìŠ¤: ì—†ìŒ</div>
            <div class="mini" id="boss-sub" style="margin-top:4px;">í‹€ë¦° ë‹¨ì–´ê°€ ìŒ“ì´ë©´ ë³´ìŠ¤ê°€ ë‚˜íƒ€ë‚˜ìš”!</div>
          </div>
          <div style="text-align:right;">
            <div class="badge" id="hud-boss-hp-text">â¤ï¸ HP 0</div>
          </div>
        </div>
        <div class="hpbar-bg" aria-hidden="true"><div class="hpbar-fill" id="boss-hp-bar"></div></div>
      </div>
    </div>

    <button class="btn btn-warning btn-main-cute" onclick="window.__voca && window.__voca.initQuiz ? window.__voca.initQuiz('random') : alert('ì¤€ë¹„ ì¤‘!')">
      âš”ï¸ ëª¨í—˜ ë– ë‚˜ê¸°
    </button>

    <div class="cute-grid-2">
      <button class="btn btn-light cute-tile" onclick="openAnalysis()">
        ğŸ’ ì•½ì  ê³µëµ
        <div class="mini">ì–´ë–¤ ë‹¨ì–´ê°€ ì–´ë ¤ìš´ì§€ ë³´ê¸°</div>
      </button>
      <button class="btn btn-light cute-tile" onclick="window.__voca && window.__voca.switchTab ? window.__voca.switchTab('shop') : alert('ìƒì  ë¡œë”© ì¤‘!')">
        ğŸ›’ ë³´ë¬¼ ìƒì 
        <div class="mini">ìŠ¤í‚¨/ì•„ì´í…œ ë³´ëŸ¬ ê°€ê¸°</div>
      </button>
      <button class="btn btn-light cute-tile" onclick="window.__voca && window.__voca.initQuiz ? window.__voca.initQuiz('time') : alert('ì¤€ë¹„ ì¤‘!')">
        â±ï¸ íƒ€ì„ ì–´íƒ
        <div class="mini">ë¹ ë¥´ê²Œ ë§ì´ ë§íˆê¸°</div>
      </button>
      <button class="btn btn-light cute-tile" onclick="(document.getElementById('btn-play-custom') && !document.getElementById('btn-play-custom').classList.contains('hidden')) ? window.__voca.initQuiz('custom') : window.__voca.openMaker()">
        âœï¸ ë‚˜ë§Œì˜ ë‹¨ì–´
        <div class="mini">ë‚´ ë‹¨ì–´ ì¶”ê°€/í•™ìŠµ</div>
      </button>
    </div>

    <details class="cute-more">
      <summary>ğŸ§© ë” ë§ì€ ë†€ì´(ê³ í•™ë…„Â·ì¤‘ë“±ì€ ì—¬ê¸°!) <span class="right">í¼ì¹˜ê¸°</span></summary>
      <div class="grid-2" style="margin-top:10px;">
        <button class="btn btn-primary" onclick="window.__voca.initQuiz('verbs')">ë™ì‚¬ ğŸƒ</button>
        <button class="btn btn-primary" onclick="window.__voca.initQuiz('nouns')">ëª…ì‚¬ ğŸ’</button>
        <button class="btn btn-primary" onclick="window.__voca.initQuiz('adjectives')">í˜•ìš©ì‚¬ âœ¨</button>
        <button class="btn btn-primary" onclick="window.__voca.initQuiz('adverbs')">ë¶€ì‚¬ ğŸ’¨</button>
        <button class="btn btn-dark" onclick="window.__voca.initQuiz('dictation')">ë°›ì•„ì“°ê¸° âœï¸</button>
        <button class="btn btn-dark" onclick="window.__voca.initQuiz('spelling')">ì² ì í€´ì¦ˆ ğŸ”¤</button>
        <button class="btn btn-danger" onclick="window.__voca.initBossRaid()">ğŸ”¥ ë³´ìŠ¤ ë ˆì´ë“œ</button>
        <button class="btn btn-review hidden" id="btn-play-review" onclick="window.__voca.initQuiz('wrong')">ì˜¤ë‹µ ë³µìŠµ ğŸ§ </button>
        <button class="btn btn-dark" onclick="window.__voca.openGrade()" style="grid-column:span 2;">í•™ë…„ë³„ ğŸ“š</button>
      </div>
    </details>
  </div>
</div>
<!-- TAB: RECORD -->
  <div id="panel-record" class="hidden">
    <details>
      <summary><span>ğŸ† íƒ€ì„ì–´íƒ ìµœê³  ê¸°ë¡</span><span class="right" id="best-time-score">0ì </span></summary>
      <div class="card" style="margin:10px 0 0;">
        <div class="row">
          <span class="pill">ì ìˆ˜: <span id="bestScoreVal">0</span></span>
          <span class="pill">ì •í™•ë„: <span id="bestAccVal">0</span>%</span>
          <span class="pill">ë¶„ë‹¹: <span id="bestWpmVal">0</span></span>
        </div>
        <button class="btn btn-gray" style="margin-top:10px;" onclick="window.__voca.resetBest()">ê¸°ë¡ ì´ˆê¸°í™”</button>
      </div>
    </details>

    <details>
      <summary><span>ğŸ§© ì¶”ê°€ ê¸°ëŠ¥ (v10)</span><span class="right">í¼ì¹˜ê¸°</span></summary>

      <!-- v10 New Menu Section -->
      <div class="card" style="margin:10px 0 0;">
        <div class="v10-menu-grid">
          <button class="v10-btn btn-analysis" onclick="openAnalysis()">ğŸ“Š ì•½ì  ë¶„ì„ & ì°¨íŠ¸</button>
          <button class="v10-btn btn-mission" onclick="openMission()">ğŸ¯ ë¯¸ì…˜ & ë³´ìƒ</button>
        </div>

        <div style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 10px; display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
          <span>ğŸ¨ <b>í…Œë§ˆ ì„¤ì •</b></span>
          <div>
            <button onclick="toggleTheme()" style="padding:5px 10px; border-radius:5px; border:1px solid #ccc; background:white; cursor:pointer;">ğŸŒ™ ë‹¤í¬ëª¨ë“œ í† ê¸€</button>
          </div>
        </div>

        <div style="background: #e3f2fd; padding: 10px; border-radius: 10px; margin-top: 12px; text-align: center; border: 1px solid #90caf9;">
          ğŸ›¡ï¸ <b>ìŠ¤íŠ¸ë¦­ ë³´í˜¸ê¶Œ</b>: <span id="freezeItemCount">0</span>ê°œ ë³´ìœ 
          <button onclick="buyFreezeItem()" style="font-size:0.8rem; background:#2196F3; color:white; border:none; padding:3px 8px; border-radius:4px; margin-left:5px; cursor:pointer;">êµ¬ë§¤ (50ğŸ’)</button>
        </div>
      </div>
    </details>

    <details>
      <summary><span>ğŸŒ± ìµœê·¼ 28ì¼ ì”ë””</span><span class="right">í¼ì¹˜ê¸°</span></summary>
      <div class="grass-grid" id="grass-grid"></div>
    </details>

    <details>
      <summary><span>ğŸ… ë°°ì§€</span><span class="right" id="badge-summary">0/8</span></summary>
      <div class="badge-wrap" id="badge-wrap"></div>
    </details>

    <details>
      <summary><span>ğŸ“¤ í•™ìŠµê¸°ë¡ CSV ë‚´ë³´ë‚´ê¸°</span><span class="right">ê´€ë¦¬ì ëª¨ë“œ ì¶”ì²œ</span></summary>
      <div class="card" style="margin:10px 0 0;">
        <div class="mini">* ë‚ ì§œë³„ ì •ë‹µ/ì‹œë„/ì •í™•ë„/íƒ€ì„ì–´íƒ ìµœê³ ê°€ í¬í•¨ë©ë‹ˆë‹¤.</div>
        <button class="btn btn-primary" style="margin-top:10px;" onclick="window.__voca.exportCSV()">CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </details>
  </div>

  <!-- TAB: SETTINGS -->
  
  <!-- TAB: SHOP -->
  <div id="panel-shop" class="hidden">
    <div class="card" style="text-align:center; background:linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color:#fff; border:none;">
      <div style="font-size:1.2rem; font-weight:900;">ë‚´ ì§€ê°‘</div>
      <div style="font-size:2.5rem; font-weight:900; margin:10px 0;" id="shop-coin-big">ğŸ’ 0</div>
      <div class="mini" style="color:#fff; opacity:0.9;">* í•™ìŠµí•˜ê³  ë³´ìŠ¤ë¥¼ ì¡ì•„ ì½”ì¸ì„ ëª¨ìœ¼ì„¸ìš”!</div>
    </div>

    <div style="font-weight:900; margin:15px 0 8px;">ğŸ¨ í…Œë§ˆ ìŠ¤í‚¨</div>
    <div class="shop-grid" id="shop-themes">
      <!-- Generated by JS -->
    </div>
  </div>

  <div id="panel-settings" class="hidden">
    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:900; margin-bottom:6px;">ë°ì¼ë¦¬ ëª©í‘œ</div>
          <select id="dailyGoalSelect">
            <option value="5">5ë‹¨ì–´</option><option value="10" selected>10ë‹¨ì–´</option>
            <option value="20">20ë‹¨ì–´</option><option value="30">30ë‹¨ì–´</option>
          </select>
        </div>
        <div>
          <div style="font-weight:900; margin-bottom:6px;">ìë™ ë°œìŒ</div>
          <select id="autoTTSSelect"><option value="on">ON</option><option value="off">OFF</option></select>
        </div>
        </div>
        <div>
          <div style="font-weight:900; margin-bottom:6px;">ë°œìŒ ì†ë„ ğŸ¢/ğŸ‡</div>
          <div class="speed-control" id="speedControl">
            <button class="speed-btn" onclick="window.__voca.setSpeed(0.8)">0.8x</button>
            <button class="speed-btn active" onclick="window.__voca.setSpeed(1.0)">1.0x</button>
            <button class="speed-btn" onclick="window.__voca.setSpeed(1.2)">1.2x</button>
          </div>

      </div>
        <div class="row" style="margin-top:12px;">
          <div style="flex:1;">
            <div style="font-weight:900; margin-bottom:6px;">ì •ë‹µ TTS ì†ë„</div>
            <div class="speed-control" id="speedControlCorrect">
              <button class="speed-btn" onclick="window.__voca.setTtsRateCorrect(0.9)">0.9x</button>
              <button class="speed-btn active" onclick="window.__voca.setTtsRateCorrect(1.0)">1.0x</button>
              <button class="speed-btn" onclick="window.__voca.setTtsRateCorrect(1.1)">1.1x</button>
            </div>
          </div>
          <div style="flex:1;">
            <div style="font-weight:900; margin-bottom:6px;">ì˜¤ë‹µ TTS ì†ë„</div>
            <div class="speed-control" id="speedControlWrong">
              <button class="speed-btn" onclick="window.__voca.setTtsRateWrong(0.75)">0.75x</button>
              <button class="speed-btn active" onclick="window.__voca.setTtsRateWrong(0.85)">0.85x</button>
              <button class="speed-btn" onclick="window.__voca.setTtsRateWrong(1.0)">1.0x</button>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div style="flex:1;">
            <div style="font-weight:900; margin-bottom:6px;">ë°œìŒ í›„ ë‹¤ìŒë¬¸ì œ ë”œë ˆì´</div>
            <select id="postTTSDelaySelect">
              <option value="0">0ms (ì¦‰ì‹œ)</option>
              <option value="120">120ms</option>
              <option value="180" selected>180ms</option>
              <option value="300">300ms</option>
              <option value="500">500ms</option>
            </select>
          </div>
          <div style="flex:1;">
            <div style="font-weight:900; margin-bottom:6px;">í˜¼í•© ì¶œì œ(ìë™)</div>
            <select id="mixModeSelect"><option value="off" selected>OFF</option><option value="on">ON</option></select>
          </div>
        </div>

        <div class="mini" style="margin-top:10px; opacity:.8;">
          * í˜¼í•© ì¶œì œ ON: ì¹´ë“œ/ë°›ì•„ì“°ê¸°/ì² ì ë¬¸ì œê°€ ì„ì—¬ ë‚˜ì˜µë‹ˆë‹¤. (ì§€ë£¨í•¨â†“, íšŒìƒ ì—°ìŠµâ†‘)
        </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <div style="font-weight:900; margin-bottom:6px;">ì˜¤íƒ€ í—ˆìš©</div>
          <select id="typoSelect"><option value="on" selected>ON</option><option value="off">OFF</option></select>
        </div>
        <div>
          <div style="font-weight:900; margin-bottom:6px;">íš¨ê³¼ìŒ</div>
          <select id="sfxSelect"><option value="on" selected>ON</option><option value="off">OFF</option></select>
        </div>
      </div>
      <div class="mini" style="margin-top:10px;">
        * ì˜¤íƒ€ í—ˆìš© ON: 4ê¸€ì ì´ìƒì—ì„œ 1ê¸€ì ì˜¤ì°¨ë¥¼ â€œì˜¤íƒ€ì§€ë§Œ ì •ë‹µ ì¸ì •â€ ì²˜ë¦¬(EXP ì¼ë¶€ ê°ì†Œ)
      </div>
    </div>
  </div>
</div>



<!-- GRADE -->
<div id="grade-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">í•™ë…„ë³„ ë‹¨ì–´ ğŸ“š</h1>
      <div class="subhint">í•™ë…„/ë‚œì´ë„ ì„ íƒ â†’ ìë™ìœ¼ë¡œ ì ì  ì–´ë ¤ì›Œì ¸ìš”</div>
    </div>
    <button class="btn btn-danger" style="width:auto; padding:10px 12px;" onclick="window.__voca.closeGrade()">ë‹«ê¸° âœ–</button>
  </div>

  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 10px;">í•™ë…„ ì„ íƒ</h3>
    <div class="grid-2">
      <label style="display:flex; flex-direction:column; gap:6px; font-weight:700;">
        ê¸°ì¤€ í•™ë…„
        <select id="grade-max" style="font-size:16px; padding:10px; border-radius:10px; border:1px solid #ddd;">
          <option value="1">1í•™ë…„</option>
          <option value="2">2í•™ë…„</option>
          <option value="3">3í•™ë…„</option>
          <option value="4">4í•™ë…„</option>
          <option value="5">5í•™ë…„</option>
          <option value="6" selected>6í•™ë…„</option>
        </select>
      </label>

      <label style="display:flex; flex-direction:column; gap:6px; font-weight:700;">
        ë²”ìœ„
        <select id="grade-range" style="font-size:16px; padding:10px; border-radius:10px; border-radius:10px; border:1px solid #ddd;">
          <option value="cumulative" selected>1~ì„ íƒí•™ë…„ ëˆ„ì </option>
          <option value="single">í•´ë‹¹ í•™ë…„ë§Œ</option>
        </select>
      </label>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 10px;">ë‚œì´ë„</h3>
    <div class="grid-2">
      <label style="display:flex; flex-direction:column; gap:6px; font-weight:700;">
        ëª¨ë“œ
        <select id="grade-difficulty" style="font-size:16px; padding:10px; border-radius:10px; border:1px solid #ddd;">
          <option value="easy">ì‰¬ì›€ / Lv1~2</option>
          <option value="normal" selected>ë³´í†µ / Lv1~4</option>
          <option value="hard">ì–´ë ¤ì›€ / Lv1~5(ìƒìœ„ ë¹„ì¤‘â†‘)</option>
          <option value="auto">ìë™ ìƒìŠ¹(ë§ì¶œìˆ˜ë¡ â†‘)</option>
        </select>
      </label>

      <label style="display:flex; flex-direction:column; gap:6px; font-weight:700;">
        ëª©í‘œ(í•œ íŒ)
        <select id="grade-target" style="font-size:16px; padding:10px; border-radius:10px; border:1px solid #ddd;">
          <option value="20">20ê°œ</option>
          <option value="30" selected>30ê°œ</option>
          <option value="40">40ê°œ</option>
          <option value="60">60ê°œ</option>
        </select>
      </label>
    </div>

    <div style="margin-top:10px; color:#555; line-height:1.5;">
      â€¢ <b>ìë™ ìƒìŠ¹</b>: 10ê°œ ì •ë‹µë§ˆë‹¤ ë‚œì´ë„ ìƒí•œì´ 1ì”© ì¦ê°€(ìµœëŒ€ 5) + ê·¸ ë ˆë²¨ ë‹¨ì–´ê°€ ë” ì„ì—¬ ë“¤ì–´ê°‘ë‹ˆë‹¤.<br/>
      â€¢ ë‹¤ìŒ ë‹¨ê³„: <code>grade_words.json</code>ë¡œ ì™¸ë¶€ ë¶„ë¦¬(ëŒ€ëŸ‰ íƒ‘ì¬) ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
  </div>

  <div class="grid-2" style="margin-top:12px;">
    <button class="btn btn-success" onclick="window.__voca.startGradeQuiz()">ì‹œì‘ â–¶</button>
    <button class="btn btn-dark" onclick="window.__voca.previewGradeCount()">ë‹¨ì–´ ìˆ˜ ë³´ê¸° ğŸ”</button>
  </div>

  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 10px;">ë‹¨ì–´ ìˆ˜ / ë ˆë²¨ ë¶„í¬</h3>
    <div id="grade-info" style="color:#444; line-height:1.6;">í•™ë…„/ë‚œì´ë„ë¥¼ ì„ íƒí•˜ê³  â€œë‹¨ì–´ ìˆ˜ ë³´ê¸°â€ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.</div>
  </div>
</div>

<!-- MAKER -->
<div id="maker-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">ë‹¨ì–´ ì¶”ê°€ âœï¸</h1>
      <div class="subhint">í•œ ê°œ ì¶”ê°€ Â· ì¼ê´„ ì¶”ê°€ Â· ë°±ì—…(ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°)</div>
    </div>
    <button class="btn btn-danger" style="width:auto; padding:10px 12px;" onclick="window.__voca.closeMaker()">ë©”ì¸ ğŸ”™</button>
  </div>

  <div class="card">
    <div class="row">
      <input id="newKan" placeholder="ëœ» (ì˜ˆ: í•™êµ)" autocomplete="off">
      <input id="newEng" placeholder="ì˜ì–´ (ì˜ˆ: school)" autocomplete="off">
    </div>
    <button class="btn btn-primary" style="margin-top:10px;" onclick="window.__voca.addCustomWord()">ëª©ë¡ì— ì¶”ê°€ â•</button>
    <div class="mini" id="custom-count" style="text-align:right; margin-top:8px;">ì´ 0ê°œ</div>
    <ul id="custom-words-list" class="list"></ul>
  </div>

  <details>
    <summary><span>ğŸ“¥ ì¼ê´„ ì¶”ê°€</span><span class="right">í¼ì¹˜ê¸°</span></summary>
    <textarea id="bulkArea" rows="5" placeholder="ì˜ˆ)
í•™êµ school
ì‚¬ê³¼ apple
ê°€ë°© bag"></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="window.__voca.addBulk()">ì¼ê´„ ì¶”ê°€</button>
      <button class="btn btn-gray" onclick="window.__voca.clearBulk()">ë¹„ìš°ê¸°</button>
    </div>
    <div class="mini" style="margin-top:8px;">* í•œ ì¤„ì— â€œëœ» ì˜ì–´â€ ë˜ëŠ” â€œëœ»,ì˜ì–´â€ ë˜ëŠ” íƒ­ êµ¬ë¶„ë„ ì¸ì‹</div>
  </details>

  <details>
    <summary><span>ğŸ” ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°(ë°±ì—…)</span><span class="right">í¼ì¹˜ê¸°</span></summary>
    <textarea id="backupArea" rows="5" placeholder="ë‚´ë³´ë‚´ê¸° JSON ë˜ëŠ” ê°€ì ¸ì˜¤ê¸° JSONì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="window.__voca.exportCustom()">ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn-dark" onclick="window.__voca.copyBackup()">ë³µì‚¬</button>
      <button class="btn btn-danger" onclick="window.__voca.importCustom()">ê°€ì ¸ì˜¤ê¸°</button>
    </div>
    <div class="mini" style="margin-top:8px;">* ê°€ì ¸ì˜¤ê¸°ëŠ” ê¸°ì¡´ ëª©ë¡ì— â€œì¶”ê°€â€(ì¤‘ë³µ ìë™ ì œì™¸)</div>
  </details>
</div>

<!-- QUIZ -->
<div id="quiz-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">í€´ì¦ˆ ğŸ®</h1>
      <div class="subhint"><span id="quiz-level-text">Lv. 1</span> Â· <span id="quiz-combo-text"></span></div>
    </div>
    <div class="toggles">
      <button id="sfxBtn" onclick="window.__voca.toggleSfx()" title="íš¨ê³¼ìŒ"
        aria-label="íš¨ê³¼ìŒ ì¼œê¸° ë˜ëŠ” ë„ê¸°">ğŸ””</button>
      
      <button id="listenModeBtn" onclick="window.__voca.toggleListenMode()" title="ë¦¬ìŠ¤ë‹ ëª¨ë“œ (ê¸€ì ê°€ë¦¬ê¸°)"
        aria-label="ë¦¬ìŠ¤ë‹ ëª¨ë“œ ì „í™˜">ğŸ‘ï¸</button>
<button id="muteBtn" onclick="window.__voca.toggleMute()" title="ë°œìŒ"
        aria-label="ë°œìŒ ì¼œê¸° ë˜ëŠ” ë„ê¸°">ğŸ”Š</button>
    </div>
  </div>

  <div class="game-stats">
    <div class="exp-bar-bg"><div id="quiz-exp-bar" class="exp-bar-fill"></div></div>
  </div>

  <div class="stats">
    <span class="pill good">ì ìˆ˜: <span id="score">0</span></span>
    <span class="pill">ì‹œë„: <span id="attempts">0</span></span>
    <span class="pill">ì •í™•ë„: <span id="accuracy">0</span>%</span>
    <span class="pill warn">ë‚¨ì€: <span id="remaining">0</span></span>
    <span id="timer-display" class="pill danger hidden timer-text">â±ï¸ <span id="time-left">60</span>ì´ˆ</span>
  </div>

  
  <div id="boss-stage" class="boss-container">
    <div class="boss-visual" id="boss-emoji">ğŸ˜ˆ</div>
    <div class="boss-hp-bar">
      <div id="boss-hp" class="boss-hp-fill"></div>
      <div id="boss-hp-text" class="boss-hp-text">1000/1000</div>
    </div>
  </div>

  <div class="card-container">
    <div id="question">ë‹¨ì–´</div>
    <button class="btn-listen" onclick="window.__voca.playCurrentWordTTS()" title="ë°œìŒ ë“£ê¸°"
      aria-label="í˜„ì¬ ë‹¨ì–´ ë°œìŒ ë“£ê¸°">ğŸ—£ï¸</button>
  </div>

  
  <div style="position:relative; margin-top:10px;">
    <input id="answerInput" placeholder="ì •ë‹µ ì…ë ¥ (ë˜ëŠ” ë§ˆì´í¬ í´ë¦­)" autocomplete="off" style="padding-right:90px;">
    <!-- Mic Button (V3) -->
    <button id="micBtn" class="mic-btn" onclick="window.__voca.toggleMic()" title="ìŒì„± ì¸ì‹ (í¬ë¡¬ ì „ìš©)">ğŸ¤</button>
    <!-- Listen Mode Toggle (V2 Feature moved here for better layout, optional, or keep in topbar) -->
    <!-- Let's keep V2's topbar toggle for Listen Mode, but add a quick TTS button here inside input like V3 design -->
  </div>

  <div id="hintArea"></div>
  <div id="nearBanner" class="near-banner" role="status" aria-live="polite"></div>

  <div class="button-group">
    <button class="btn btn-main" onclick="window.__voca.handleCheck()">ì •ë‹µ í™•ì¸</button>
    <button class="btn btn-hint" onclick="window.__voca.showHint()">íŒíŠ¸ ğŸ’¡</button>
    <button class="btn btn-exit" onclick="window.__voca.showResult()">ëë‚´ê¸° ğŸ</button>
  </div>

  <div id="feedback"></div>
</div>


<!-- STUDY (FLASHCARDS) -->
<div id="study-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">í•™ìŠµ ì¹´ë“œ ğŸ“‡</h1>
      <div class="subhint"><span id="study-progress">0 / 0</span></div>
    </div>
    <div class="toggles">
      <button id="studyMeaningBtn" onclick="window.__voca.toggleStudyMeaning()" title="ëœ» ë³´ê¸°/ìˆ¨ê¸°ê¸°" aria-label="ëœ» ë³´ê¸° ë˜ëŠ” ìˆ¨ê¸°ê¸°">ğŸ“</button>
      <button id="studyAutoBtn" onclick="window.__voca.toggleStudyAuto()" title="ìë™ ì¬ìƒ" aria-label="ìë™ ì¬ìƒ ì „í™˜">â¯ï¸</button>
      <button class="btn btn-dark" style="width:auto; padding:10px 12px;" onclick="window.__voca.backToHomeFromStudy()" aria-label="í™ˆìœ¼ë¡œ">ğŸ </button>
    </div>
  </div>

  <div class="card" style="text-align:center;">
    <div id="studyEng" style="font-size:2.2rem; font-weight:900; letter-spacing:0.5px;">word</div>
    <div id="studyKan" style="margin-top:8px; font-size:1.2rem; opacity:.85;">ëœ»</div>
    <div class="mini" style="margin-top:10px;">* ì¹´ë“œ 1íšŒ í•™ìŠµ í›„, ì•„ë˜ì—ì„œ ì‹œí—˜ì„ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”.</div>
  </div>

  <!-- Study controls: video-player style bottom bar -->
  <div class="study-bottom" aria-label="í•™ìŠµ ì¹´ë“œ ì»¨íŠ¸ë¡¤">
    <button class="study-ctl btn-outline" onclick="window.__voca.studyPrev()" aria-label="ì´ì „ ë‹¨ì–´">â®ï¸</button>
    <button class="study-ctl study-play btn-primary" onclick="window.__voca.studySpeak()" aria-label="ë°œìŒ ë“£ê¸°">â–¶ï¸ ë“£ê¸°</button>
    <button class="study-ctl btn-outline" onclick="window.__voca.studyNext()" aria-label="ë‹¤ìŒ ë‹¨ì–´">â­ï¸</button>
  </div>

  <div class="study-actions">
    <button class="btn btn-primary" onclick="window.__voca.startTestFromStudy()" title="ì¹´ë“œë¥¼ 1íšŒ ì´ìƒ í•™ìŠµí•œ ë’¤, ë°”ë¡œ ì‹œí—˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.">ì‹œí—˜ ì‹œì‘ âœ…</button>
    <button class="btn btn-light" onclick="window.__voca.skipStudyAndTest()" title="í•™ìŠµì„ ê±´ë„ˆë›°ê³  ë°”ë¡œ ì‹œí—˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.">í•™ìŠµ ê±´ë„ˆë›°ê³  ì‹œí—˜ â©</button>
  </div>
</div>

<!-- RESULT -->
<div id="result-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">ê²°ê³¼ ğŸ“</h1>
      <div class="subhint" id="final-score">ìµœì¢… ì ìˆ˜: 0ì </div>
    </div>
    <button class="btn btn-dark" style="width:auto; padding:10px 12px;"
      onclick="location.reload()" aria-label="í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°">í™ˆ ğŸ </button>
  </div>

  <div id="time-extra" class="card hidden">
    <div style="font-weight:900; margin-bottom:6px;">â±ï¸ íƒ€ì„ì–´íƒ ë¶„ì„</div>
    <div id="time-stats" style="font-weight:900; color:#2c3e50;"></div>
    <div id="best-badge" style="margin-top:8px; font-weight:900;"></div>
  </div>

  <div class="card" style="background:#fff3f3; border-color:rgba(231,76,60,.18);">
    <div style="font-weight:900; color:var(--danger);">ëˆ„ì  ì˜¤ë‹µ ë…¸íŠ¸ ğŸš©</div>
    <div class="mini" style="margin-top:6px;">* â€˜ìˆ™ë ¨â€™ìœ¼ë¡œ ë³´ë‚´ë©´ ê¸°ë¡ìœ¼ë¡œ ë‚¨ê³ , ì˜¤ë‹µì—ì„œ ë¹ ì§‘ë‹ˆë‹¤.</div>
    <ul id="wrong-items" class="list"></ul>
    <button class="btn btn-gray" style="margin-top:10px; padding:8px;" onclick="window.__voca.printWrongNotes()">ğŸ–¨ï¸ ì˜¤ë‹µ ë…¸íŠ¸ ì¸ì‡„ (ì‹œí—˜ì§€)</button>

  </div>

  <div class="card" style="background:#f4fbf6; border-color:rgba(39,174,96,.18);">
    <div style="font-weight:900; color:var(--success);">ìˆ™ë ¨(ë§ˆìŠ¤í„°) ğŸ†</div>
    <div class="mini" style="margin-top:6px;">* ì •ë³µí•œ ë‹¨ì–´ ëª©ë¡ì…ë‹ˆë‹¤.</div>
    <ul id="master-items" class="list"></ul>
  </div>
</div>

<!-- ADMIN (í•™ìƒì´ ì§ì ‘ ê´€ë¦¬) -->
<div id="admin-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">ê´€ë¦¬ì ëª¨ë“œ âš™ï¸</h1>
      <div class="subhint">ì„¸íŠ¸ ë§Œë“¤ê¸° Â· ì„¸íŠ¸ ì ìš© Â· ë°°í¬(JSON) Â· ê¸°ë¡(CSV)</div>
    </div>
    <button class="btn btn-danger" style="width:auto; padding:10px 12px;"
      onclick="window.__voca.closeAdmin()" aria-label="ê´€ë¦¬ì ëª¨ë“œ ë‹«ê¸°">ë©”ì¸ ğŸ”™</button>
  </div>

  <div class="card">
    <div style="font-weight:900; margin-bottom:8px;">ğŸ“¦ ë‹¨ì–´ ì„¸íŠ¸ ë§Œë“¤ê¸°</div>
    <input id="setName" placeholder="ì„¸íŠ¸ ì´ë¦„ (ì˜ˆ: 4-1 1ë‹¨ì›)" />
    <textarea id="setBulk" rows="6" style="margin-top:10px;" placeholder="ì˜ˆ)
í•™êµ school
ì‚¬ê³¼ apple
ê°€ë°© bag"></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="window.__voca.saveSet()">ì„¸íŠ¸ ì €ì¥</button>
      <button class="btn btn-gray" onclick="window.__voca.clearSetForm()">ì´ˆê¸°í™”</button>
    </div>
    <div class="mini" style="margin-top:8px;">
      * ì €ì¥í•œ ì„¸íŠ¸ë¥¼ â€œì ìš©â€í•˜ë©´ í•´ë‹¹ ì„¸íŠ¸ ë‹¨ì–´ê°€ â€˜ë‚˜ë§Œì˜ ë‹¨ì–´ì¥â€™ì— ìë™ ì¶”ê°€ë©ë‹ˆë‹¤(ì¤‘ë³µ ì œì™¸).
    </div>
  </div>

  <details open>
    <summary><span>ğŸ“š ì €ì¥ëœ ì„¸íŠ¸</span><span class="right">ì ìš©/ë‚´ë³´ë‚´ê¸°/ì‚­ì œ</span></summary>
    <ul id="setList" class="list"></ul>
  </details>

  <details>
    <summary><span>ğŸ“¤ ì„¸íŠ¸ JSON ë‚´ë³´ë‚´ê¸°</span><span class="right">ê³µìœ /ë°±ì—…</span></summary>
    <textarea id="adminExport" rows="5" placeholder="ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ë©´ JSONì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-dark" onclick="window.__voca.copyAdminExport()">JSON ë³µì‚¬</button>
      <button class="btn btn-primary" onclick="window.__voca.exportCSV()">í•™ìŠµê¸°ë¡ CSV</button>
    </div>
  </details>

  <details>
    <summary><span>ğŸ“¥ ì„¸íŠ¸ JSON ê°€ì ¸ì˜¤ê¸°</span><span class="right">ë¶™ì—¬ë„£ê¸°</span></summary>
    <textarea id="adminImport" rows="5" placeholder="ë‹¤ë¥¸ ì‚¬ëŒì´ ì¤€ ì„¸íŠ¸ JSONì„ ë¶™ì—¬ë„£ê³  ê°€ì ¸ì˜¤ì„¸ìš”."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="window.__voca.importSetJSON()">ì„¸íŠ¸ ê°€ì ¸ì˜¤ê¸°</button>
      <button class="btn btn-gray" onclick="document.getElementById('adminImport').value=''">ë¹„ìš°ê¸°</button>
    </div>
    <div class="mini" style="margin-top:8px;">* ê°€ì ¸ì˜¨ ì„¸íŠ¸ëŠ” â€œì €ì¥ëœ ì„¸íŠ¸â€ ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤.</div>
  </details>
</div>

<script>
(() => {
  "use strict";

  /* =========================
   * Storage: ì•ˆì „ ë¡œë“œ/ì„¸ì´ë¸Œ
   * ========================= */
  const Storage = {
    safeLoad(key, fallback, onRecover) {
      try {
        const raw = localStorage.getItem(key);
        if (raw === null || raw === undefined) return fallback;
        return JSON.parse(raw);
      } catch (e) {
        // ë°ì´í„° ì†ìƒ â†’ ë³µêµ¬
        try { localStorage.removeItem(key); } catch {}
        if (typeof onRecover === "function") onRecover(key);
        return fallback;
      }
    },
    safeSave(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); return true; }
      catch { return false; }
    },
    safeRemove(key) {
      try { localStorage.removeItem(key); } catch {}
    }
  };

  /* =========================
   * App Class: ìƒíƒœ/ë¡œì§ ìº¡ìŠí™”
   * ========================= */
  class VocaApp {
    constructor() {
      this.wordBank = {
        verbs: [{kan:"ë•ë‹¤",eng:"help"},{kan:"ì”»ë‹¤",eng:"wash"},{kan:"ì²­ì†Œí•˜ë‹¤",eng:"clean"},{kan:"ì—°ìŠµí•˜ë‹¤",eng:"practice"},{kan:"ê³µë¶€í•˜ë‹¤",eng:"study"}],
        nouns: [{kan:"í•™êµ",eng:"school"},{kan:"ì‚¬ê³¼",eng:"apple"},{kan:"ê°€ë°©",eng:"bag"},{kan:"ì±…ìƒ",eng:"desk"},{kan:"ë¬¼",eng:"water"}],
        adjectives: [{kan:"í–‰ë³µí•œ",eng:"happy"},{kan:"ìŠ¬í”ˆ",eng:"sad"},{kan:"ê°•í•œ",eng:"strong"},{kan:"ë°”ìœ",eng:"busy"},{kan:"ì˜ˆìœ",eng:"pretty"}],
        adverbs: [{kan:"ë¹¨ë¦¬",eng:"quickly"},{kan:"ì²œì²œíˆ",eng:"slowly"},{kan:"ì¡°ìš©íˆ",eng:"quietly"},{kan:"í•­ìƒ",eng:"always"},{kan:"ê°€ë”",eng:"sometimes"}]
      };

      // ìƒíƒœ(State) ë‹¨ì¼ ê°ì²´ë¡œ í†µí•©
      this.state = {
        data: {
          customWords: [],

          // í•™ë…„ë³„ ë‚´ì¥ ë‹¨ì–´(ìš°ì™€! ì²´ê°ìš© ì†ŒëŸ‰)
          // ë‹¤ìŒ ë‹¨ê³„: ê°™ì€ ê²½ë¡œì— grade_words.jsonì„ ë‘ë©´ ìë™ ë¡œë“œí•´ì„œ ëŒ€ëŸ‰ íƒ‘ì¬ ê°€ëŠ¥
          grades: {
            g1: [
              {kan:"ì•ˆë…•",eng:"hello",grade:1,level:1},{kan:"ê°ì‚¬í•©ë‹ˆë‹¤",eng:"thank you",grade:1,level:1},{kan:"ë¯¸ì•ˆí•´ìš”",eng:"sorry",grade:1,level:1},
              {kan:"ì´ë¦„",eng:"name",grade:1,level:1},{kan:"ì¹œêµ¬",eng:"friend",grade:1,level:1},{kan:"ì±…",eng:"book",grade:1,level:1},
              {kan:"ì¢‹ì•„í•˜ë‹¤",eng:"like",grade:1,level:2},{kan:"ê°€ë‹¤",eng:"go",grade:1,level:2},{kan:"ì˜¤ë‹¤",eng:"come",grade:1,level:2},
              {kan:"ê°€ì¡±",eng:"family",grade:1,level:2},{kan:"í•™êµ",eng:"school",grade:1,level:2}
            ],
            g2: [
              {kan:"ì•„ì¹¨",eng:"morning",grade:2,level:1},{kan:"ì ì‹¬",eng:"lunch",grade:2,level:1},{kan:"ì €ë…",eng:"dinner",grade:2,level:1},
              {kan:"ë¬¼",eng:"water",grade:2,level:1},{kan:"ìš°ìœ ",eng:"milk",grade:2,level:1},{kan:"ë¹µ",eng:"bread",grade:2,level:1},
              {kan:"ë†€ë‹¤",eng:"play",grade:2,level:2},{kan:"ë¨¹ë‹¤",eng:"eat",grade:2,level:2},{kan:"ë§ˆì‹œë‹¤",eng:"drink",grade:2,level:2},
              {kan:"ë¹ ë¥´ë‹¤",eng:"fast",grade:2,level:2},{kan:"ëŠë¦¬ë‹¤",eng:"slow",grade:2,level:2}
            ],
            g3: [
              {kan:"ìˆ™ì œ",eng:"homework",grade:3,level:2},{kan:"ìš´ë™ì¥",eng:"playground",grade:3,level:2},{kan:"êµì‹¤",eng:"classroom",grade:3,level:2},
              {kan:"ì§ˆë¬¸",eng:"question",grade:3,level:3},{kan:"ëŒ€ë‹µ",eng:"answer",grade:3,level:3},{kan:"ì„¤ëª…í•˜ë‹¤",eng:"explain",grade:3,level:3},
              {kan:"ì¡°ì‹¬í•˜ë‹¤",eng:"be careful",grade:3,level:3},{kan:"í•„ìš”í•˜ë‹¤",eng:"need",grade:3,level:3},{kan:"ëª¨ìœ¼ë‹¤",eng:"collect",grade:3,level:3},
              {kan:"ê¸°ì–µí•˜ë‹¤",eng:"remember",grade:3,level:4},{kan:"ë¹„êµí•˜ë‹¤",eng:"compare",grade:3,level:4}
            ],
            g4: [
              {kan:"í™˜ê²½",eng:"environment",grade:4,level:3},{kan:"ì¬í™œìš©",eng:"recycle",grade:4,level:3},{kan:"ì“°ë ˆê¸°",eng:"trash",grade:4,level:3},
              {kan:"ê·œì¹™",eng:"rule",grade:4,level:3},{kan:"ì•ˆì „",eng:"safety",grade:4,level:3},{kan:"ìœ„í—˜",eng:"danger",grade:4,level:4},
              {kan:"í•´ê²°í•˜ë‹¤",eng:"solve",grade:4,level:4},{kan:"ê³„íš",eng:"plan",grade:4,level:4},{kan:"ì‹¤í—˜",eng:"experiment",grade:4,level:4},
              {kan:"ë°œëª…",eng:"invention",grade:4,level:5},{kan:"ë°œê²¬",eng:"discovery",grade:4,level:5}
            ],
            g5: [
              {kan:"ë¬¸í™”",eng:"culture",grade:5,level:3},{kan:"ì „í†µ",eng:"tradition",grade:5,level:3},{kan:"ì¶•ì œ",eng:"festival",grade:5,level:3},
              {kan:"í† ë¡ ",eng:"debate",grade:5,level:4},{kan:"ì£¼ì¥",eng:"opinion",grade:5,level:4},{kan:"ê·¼ê±°",eng:"evidence",grade:5,level:4},
              {kan:"ì„¤ë“í•˜ë‹¤",eng:"persuade",grade:5,level:4},{kan:"ì¡´ì¤‘",eng:"respect",grade:5,level:4},{kan:"ê³µì •",eng:"fair",grade:5,level:4},
              {kan:"ë¯¼ì£¼ì£¼ì˜",eng:"democracy",grade:5,level:5},{kan:"í—Œë²•",eng:"constitution",grade:5,level:5}
            ],
            g6: [
              {kan:"ê³¼í•™ì",eng:"scientist",grade:6,level:4},{kan:"ìë£Œ",eng:"data",grade:6,level:4},{kan:"ë¶„ì„",eng:"analysis",grade:6,level:4},
              {kan:"ê°€ì„¤",eng:"hypothesis",grade:6,level:4},{kan:"ê²€ì¦",eng:"verify",grade:6,level:4},{kan:"ìš”ì•½",eng:"summarize",grade:6,level:4},
              {kan:"ì¶”ë¡ ",eng:"infer",grade:6,level:5},{kan:"ê²°ë¡ ",eng:"conclusion",grade:6,level:5},{kan:"ê´€ì ",eng:"perspective",grade:6,level:5},
              {kan:"ì§€ì†ê°€ëŠ¥í•œ",eng:"sustainable",grade:6,level:5},{kan:"í˜‘ë ¥",eng:"collaboration",grade:6,level:5}
            ]
          },

          wrongWords: [],
          masterWords: [],
          playerLevel: 1,
          playerExp: 0,
          attendanceData: {},
          settings: { dailyGoal: 10, autoTTS: true, typoHelp: true, sfx: true, ttsSpeed: 1.0, ttsRateCorrect: 1.0, ttsRateWrong: 0.85, postTTSDelay: 180, mixMode: false, requeueOffset: 4, requeueMax: 2 },
          bestTimeAttack: { bestScore: 0, bestWpm: 0, bestAccuracy: 0 },
          progress: { daily:{}, history:[] },
          sets: [],
          badges: {},
          coins: 0,
          inventory: ['default'],
          equippedTheme: 'default'
        },
        runtime: {
          currentList: [],
          currentWord: null,
          combo: 0,
          score: 0,
          attempts: 0,
          correctCount: 0,
          isMuted: false, isListeningMode: false,
          isTimeMode: false,
          timerInterval: null,
          timeLeft: 60,
          timeModeStart: 0,
          audioCtx: null,
          isBossMode: false,
          bossHP: 0,
          maxBossHP: 0
        ,
          study: { active:false, idx:0, list:[], showMeaning:true, auto:false, timer:null },
          pendingStart: false
        }
      };

      this.BADGE_DEF = [
        {id:'streak_3',  icon:'ğŸ”¥', name:'3ì¼ ì—°ì†',  desc:'ì—°ì† í•™ìŠµ 3ì¼'},
        {id:'streak_7',  icon:'ğŸ”¥', name:'7ì¼ ì—°ì†',  desc:'ì—°ì† í•™ìŠµ 7ì¼'},
        {id:'streak_14', icon:'ğŸ”¥', name:'14ì¼ ì—°ì†', desc:'ì—°ì† í•™ìŠµ 14ì¼'},
        {id:'goal_1',    icon:'ğŸ…', name:'ì˜¤ëŠ˜ ëª©í‘œ',  desc:'ì˜¤ëŠ˜ ëª©í‘œ ë‹¬ì„±'},
        {id:'goal_7',    icon:'ğŸ…', name:'ëª©í‘œ 7íšŒ',   desc:'ëª©í‘œ ë‹¬ì„± 7íšŒ'},
        {id:'master_10', icon:'ğŸ†', name:'ì •ë³µ 10',    desc:'ìˆ™ë ¨ 10ê°œ ë‹¬ì„±'},
        {id:'time_15',   icon:'â±ï¸', name:'íƒ€ì„ 15ì ',  desc:'íƒ€ì„ì–´íƒ 15ì  ë‹¬ì„±'},
        {id:'time_best', icon:'ğŸ‰', name:'ì‹ ê¸°ë¡',     desc:'íƒ€ì„ì–´íƒ ìµœê³ ê¸°ë¡ ê°±ì‹ '}
      ];
    }

    /* ---------- UI Helpers ---------- */
    $(id){ return document.getElementById(id); }

    toast(msg){
      const t = this.$('toast');
      if(!t) return;
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(this._toastTimer);
      this._toastTimer = setTimeout(()=>t.classList.remove('show'), 1700);
    }

    /* ---------- Data Load/Save ---------- */
    loadAll() {
      const onRecover = (k)=>this.toast(`ì €ì¥ ë°ì´í„°(${k})ê°€ ì†ìƒë˜ì–´ ì´ˆê¸°í™”í–ˆì–´ìš” ğŸ›¡ï¸`);
      const D = this.state.data;

      D.customWords    = Storage.safeLoad('myVocaCustom', [], onRecover);
      D.wrongWords     = Storage.safeLoad('myVocaWrongWords', [], onRecover);
      D.masterWords    = Storage.safeLoad('myVocaMasterWords', [], onRecover);
      D.playerLevel    = parseInt(Storage.safeLoad('myVocaLevel', 1, onRecover)) || 1;
      D.playerExp      = parseInt(Storage.safeLoad('myVocaExp', 0, onRecover)) || 0;
      D.attendanceData = Storage.safeLoad('myVocaAttendance', {}, onRecover);
      D.settings       = Storage.safeLoad('myVocaSettings', { dailyGoal:10, autoTTS:true, typoHelp:true, sfx:true, ttsSpeed:1.0, ttsRateCorrect:1.0, ttsRateWrong:0.85, postTTSDelay:180, mixMode:false, requeueOffset:4, requeueMax:2 }, onRecover);
      D.bestTimeAttack = Storage.safeLoad('myVocaBestTimeAttack', { bestScore:0, bestWpm:0, bestAccuracy:0 }, onRecover);
      D.progress       = Storage.safeLoad('myVocaProgress', { daily:{}, history:[] }, onRecover);
      D.sets           = Storage.safeLoad('myVocaSets', [], onRecover);
      D.badges = Storage.safeLoad('myVocaBadges', {}, onRecover);
      D.coins = parseInt(Storage.safeLoad('myVocaCoins', 0, onRecover)) || 0;
      D.inventory = Storage.safeLoad('myVocaInventory', ['default'], onRecover);
      D.equippedTheme = Storage.safeLoad('myVocaTheme', 'default', onRecover);
      if(D.equippedTheme && D.equippedTheme !== 'default') document.body.classList.add(`theme-${D.equippedTheme}`);


      // ë°ì´í„° ì •ê·œí™”(ìµœì†Œ ì•ˆì „ì¥ì¹˜)
      if(!Array.isArray(D.customWords)) D.customWords = [];
      if(!Array.isArray(D.wrongWords)) D.wrongWords = [];
      if(!Array.isArray(D.masterWords)) D.masterWords = [];
      if(!Array.isArray(D.sets)) D.sets = [];
      if(typeof D.attendanceData !== 'object' || D.attendanceData === null) D.attendanceData = {};
      if(typeof D.badges !== 'object' || D.badges === null) D.badges = {};
      if(typeof D.progress !== 'object' || D.progress === null) D.progress = { daily:{}, history:[] };

      // settings ì •ê·œí™”
      D.settings.dailyGoal = parseInt(D.settings.dailyGoal || 10);
      D.settings.autoTTS = !!D.settings.autoTTS;
      D.settings.typoHelp = !!D.settings.typoHelp;
      D.settings.sfx = !!D.settings.sfx;

      D.settings.ttsSpeed = parseFloat(D.settings.ttsSpeed || 1.0);
      D.settings.ttsRateCorrect = parseFloat(D.settings.ttsRateCorrect || 1.0);
      D.settings.ttsRateWrong = parseFloat(D.settings.ttsRateWrong || 0.85);
      D.settings.postTTSDelay = parseInt(D.settings.postTTSDelay || 180);
      D.settings.mixMode = !!D.settings.mixMode;
      D.settings.requeueOffset = parseInt(D.settings.requeueOffset || 4);
      D.settings.requeueMax = parseInt(D.settings.requeueMax || 2);

      return true;
    }

    saveKey(key, value){
      return Storage.safeSave(key, value);
    }

    persistCore(){
      const D = this.state.data;
      this.saveKey('myVocaCustom', D.customWords);
      this.saveKey('myVocaWrongWords', D.wrongWords);
      this.saveKey('myVocaMasterWords', D.masterWords);
      this.saveKey('myVocaLevel', D.playerLevel);
      this.saveKey('myVocaExp', D.playerExp);
      this.saveKey('myVocaAttendance', D.attendanceData);
      this.saveKey('myVocaSettings', D.settings);
      this.saveKey('myVocaBestTimeAttack', D.bestTimeAttack);
      this.saveKey('myVocaProgress', D.progress);
      this.saveKey('myVocaSets', D.sets);
      this.saveKey('myVocaBadges', D.badges);
          this.saveKey('myVocaCoins', D.coins||0);
      this.saveKey('myVocaInventory', D.inventory||['default']);
      this.saveKey('myVocaTheme', D.equippedTheme||'default');
    }

    /* ---------- Utils ---------- */
    normalizeEng(s){ return String(s||"").trim().toLowerCase(); }
    dateStrOf(d){
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    ensureAudio(){
      const R = this.state.runtime;
      if(!R.audioCtx) R.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return R.audioCtx;
    }

    playSound(type){
      const { settings } = this.state.data;
      if(!settings.sfx) return;
      const ctx = this.ensureAudio();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);

      if(type==='correct'){ osc.frequency.setValueAtTime(880, ctx.currentTime); osc.type='sine'; }
      else if(type==='levelup'){ osc.frequency.setValueAtTime(1046.5, ctx.currentTime); osc.type='sine'; }
      else if(type==='tick'){ osc.frequency.setValueAtTime(600, ctx.currentTime); osc.type='triangle'; gain.gain.setValueAtTime(0.5, ctx.currentTime); }
      else { osc.frequency.setValueAtTime(220, ctx.currentTime); osc.type='square'; }

      osc.start();
      const dur = (type==='tick') ? 0.1 : 0.25;
      gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + dur);
      osc.stop(ctx.currentTime + dur);
    }

    speakWord(text, slow=false, onDone=null){
      const R = this.state.runtime;
      if(R.isMuted) { if(typeof onDone==='function') onDone(); return; }

      // ì§€ì› ì—¬ë¶€
      if(!('speechSynthesis' in window) || typeof SpeechSynthesisUtterance === 'undefined'){
        if(typeof onDone==='function') onDone();
        this.toast('ì´ ê¸°ê¸°/ë¸Œë¼ìš°ì €ëŠ” ë°œìŒì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.');
        return;
      }

      const self = this;
      const msg = String(text || '').trim();
      if(!msg) { if(typeof onDone==='function') onDone(); return; }

      let u;
      try{
        // iOSì—ì„œ ì”ì—¬ íê°€ ê¼¬ì¼ ìˆ˜ ìˆì–´ í•­ìƒ ì •ë¦¬
        try{ window.speechSynthesis.cancel(); }catch{}
        u = new SpeechSynthesisUtterance(msg);
      }catch(e){
        if(typeof onDone==='function') onDone();
        this.toast('ë°œìŒ ì¤€ë¹„ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        return;
      }

      u.lang = 'en-US';
      u.rate = (typeof slow === 'number') ? slow : (slow ? (this.state.data.settings.ttsRateWrong || 0.85) : (this.state.data.settings.ttsSpeed || 1.0));

      let started = false;
      let finished = false;

      const safeDone = ()=>{
        if(finished) return;
        finished = true;
        try{ if(typeof onDone==='function') onDone(); }catch{}
      };

      const notifyBlocked = (detail)=>{
        if(finished) return;
        // iOS ë¬´ìŒëª¨ë“œ/ê¶Œí•œ/ì •ì±…ìœ¼ë¡œ ë§‰í˜€ë„ ì•±ì€ ê³„ì† ë™ì‘
        self.toast(detail || 'ğŸ”‡ ë°œìŒì´ ì°¨ë‹¨ë˜ì—ˆì–´ìš”. (ë¬´ìŒëª¨ë“œ/ë³¼ë¥¨/ì‚¬íŒŒë¦¬ ì •ì±…) ì†Œë¦¬ë¥¼ ì¼œê³  ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
        safeDone();
      };

      // ì‹œì‘ ê°€ë“œ (ë„ˆë¬´ ê¸¸ê²Œ ê¸°ë‹¤ë¦¬ì§€ ì•Šê¸°)
      const startGuard = setTimeout(()=>{
        if(!started && !finished){
          notifyBlocked('ğŸ”‡ ë°œìŒì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ì–´ìš”. iOS ë¬´ìŒëª¨ë“œ/ì‚¬íŒŒë¦¬ ì •ì±… ë•Œë¬¸ì— ë§‰í ìˆ˜ ìˆì–´ìš”.');
        }
      }, 1300);

      u.onstart = ()=>{ started = true; clearTimeout(startGuard); };
      u.onend   = ()=>{ clearTimeout(startGuard); safeDone(); };
      u.onerror = ()=>{ clearTimeout(startGuard); notifyBlocked(); };

      try{
        window.speechSynthesis.speak(u);
      }catch(e){
        clearTimeout(startGuard);
        notifyBlocked('ğŸ”‡ ë°œìŒ ì‹¤í–‰ì´ ì‹¤íŒ¨í–ˆì–´ìš”. ì†Œë¦¬/ê¶Œí•œì„ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }

      // í˜¹ì‹œ onendê°€ ì•ˆ ì˜¤ëŠ” ì¼€ì´ìŠ¤(ì¼ë¶€ ëª¨ë°”ì¼) ëŒ€ë¹„ ì•ˆì „ì¥ì¹˜
      const estMs = Math.min(2600, Math.max(900, Math.round(msg.length * 85 / (u.rate||1))));
      setTimeout(()=>safeDone(), estMs + 400);
    }

    showParticles(emoji){
      for(let i=0;i<14;i++){
        const p=document.createElement('div');
        p.innerText=emoji;
        p.className='particle';
        p.style.left=(50+(Math.random()*40-20))+'vw';
        p.style.top=(50+(Math.random()*40-20))+'vh';
        p.style.fontSize=(Math.random()*18+18)+'px';
        document.body.appendChild(p);
        setTimeout(()=>p.remove(), 1200);
      }
    }

    levenshtein(a,b){
      a=a||""; b=b||"";
      const n=a.length, m=b.length;
      const dp=Array.from({length:n+1},()=>Array(m+1).fill(0));
      for(let i=0;i<=n;i++) dp[i][0]=i;
      for(let j=0;j<=m;j++) dp[0][j]=j;
      for(let i=1;i<=n;i++){
        for(let j=1;j<=m;j++){
          const cost=(a[i-1]===b[j-1])?0:1;
          dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[n][m];
    }
    scrambleWord(word){
      // ì² ì í€´ì¦ˆìš©: ê³µë°±ì€ ìœ ì§€í•˜ê³ , ê° í† í°(ë‹¨ì–´) ì•ˆì˜ ê¸€ìë§Œ ì„ìŠµë‹ˆë‹¤.
      const s = String(word||'').trim();
      if(!s) return '';
      const parts = s.split(/(\s+)/);
      const out = parts.map(p=>{
        if(/\s+/.test(p)) return p;
        const chars = p.split('');
        if(chars.length <= 2) return p;
        let attempt = 0;
        let shuffled = chars.slice();
        while(attempt < 5){
          this.shuffle(shuffled);
          if(shuffled.join('') !== p) break;
          attempt++;
        }
        return shuffled.join('');
      });
      return out.join('');
    }



    shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    /* ---------- Tabs ---------- */
    
    /* --- V2 Features --- */
    
    /* --- V3 God Mode Logic --- */
    addCoin(n) {
      const D = this.state.data;
      D.coins = (D.coins || 0) + n;
      this.saveKey('myVocaCoins', D.coins);
      this.renderCoin();
    }
    renderCoin() {
      const c = this.state.data.coins || 0;
      const el1 = document.getElementById('global-coin');
      const el2 = document.getElementById('shop-coin-big');
      if(el1) el1.innerText = `ğŸ’ ${c}`;
      if(el2) el2.innerText = `ğŸ’ ${c}`;
    }
    initShop() {
      const themes = [
        {id:'default', name:'ê¸°ë³¸ (í™”ì´íŠ¸)', price:0, color:'#ffffff'},
        {id:'dark', name:'ë‹¤í¬ ëª¨ë“œ', price:500, color:'#111827'},
        {id:'pink', name:'í•‘í¬ ëŸ¬ë¸”ë¦¬', price:1000, color:'#ff9ff3'},
        {id:'cyber', name:'ì‚¬ì´ë²„ í‘í¬', price:2000, color:'#000000'},

        {id:'ocean', name:'ì˜¤ì…˜ ë¸”ë£¨', price:1200, color:'#1e90ff'},
        {id:'forest', name:'í¬ë ˆìŠ¤íŠ¸', price:1200, color:'#1f7a4a'},
        {id:'sunset', name:'ì„ ì…‹', price:1500, color:'#ff6b6b'},
        {id:'lavender', name:'ë¼ë²¤ë”', price:1500, color:'#b39ddb'},
        {id:'highcontrast', name:'í•˜ì´ ì½˜íŠ¸ë¼ìŠ¤íŠ¸', price:800, color:'#ffffff'}
      ];
      const grid = document.getElementById('shop-themes');
      if(!grid) return;
      grid.innerHTML = '';
      const myItems = this.state.data.inventory || ['default'];
      const current = this.state.data.equippedTheme || 'default';

      themes.forEach(t => {
        const has = myItems.includes(t.id);
        const equipped = (current === t.id);
        const div = document.createElement('div');
        div.className = `shop-item ${has ? 'bought' : ''} ${equipped ? 'equipped' : ''}`;
        div.innerHTML = `
          <div style="width:30px; height:30px; background:${t.color}; border-radius:50%; margin:0 auto 5px; border:1px solid #ddd;"></div>
          <div style="font-weight:bold;">${t.name}</div>
          <div style="font-size:0.9rem; margin-top:5px;">${has ? (equipped?'ì¥ì°©ì¤‘':'ë³´ìœ ì¤‘') : 'ğŸ’ '+t.price}</div>
        `;
        div.onclick = () => {
          if(equipped) return;
          if(has) { this.equipTheme(t.id); }
          else {
            if((this.state.data.coins||0) >= t.price) {
              if(confirm(`${t.name} í…Œë§ˆë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
                this.addCoin(-t.price);
                this.state.data.inventory.push(t.id);
                this.saveKey('myVocaInventory', this.state.data.inventory);
                this.equipTheme(t.id);
              }
            } else { alert('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! í•™ìŠµì„ í†µí•´ ëª¨ì•„ë³´ì„¸ìš” ğŸ’°'); }
          }
        };
        grid.appendChild(div);
      });
    }
    equipTheme(id) {
      this.state.data.equippedTheme = id;
      this.saveKey('myVocaTheme', id);
      // Remove all theme classes first
      document.body.classList.remove('theme-dark','theme-pink','theme-cyber','theme-ocean','theme-forest','theme-sunset','theme-lavender','theme-highcontrast');
      if(id !== 'default') document.body.classList.add(`theme-${id}`);
      // Theme compatibility: keep legacy 'dark-mode' in sync
      document.body.classList.toggle('dark-mode', document.body.classList.contains('theme-dark'));
      this.initShop();
      this.toast('í…Œë§ˆê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¨');
    }

    // Boss
    initBossRaid() {
      this.state.runtime.isBossMode = true;
      this.state.runtime.bossHP = 1000;
      this.state.runtime.maxBossHP = 1000;
      this.$('boss-stage').style.display = 'block';
      this.initQuiz('time'); // íƒ€ì„ì–´íƒ ê¸°ë°˜
      this.toast('ğŸ˜ˆ ë³´ìŠ¤ ì¶œí˜„! ì •ë‹µì„ ë§ì¶° ê³µê²©í•˜ì„¸ìš”!');
    }
    bossAttack(dmg) {
      const R = this.state.runtime;
      if(!R.isBossMode) return;
      R.bossHP -= dmg;
      const pct = Math.max(0, (R.bossHP/R.maxBossHP)*100);
      this.$('boss-hp').style.width = `${pct}%`;
      this.$('boss-hp-text').innerText = `${R.bossHP}/${R.maxBossHP}`;

      // Damage Effect
      const eff = document.createElement('div');
      eff.innerText = `-${dmg}`;
      eff.style.position='fixed'; eff.style.left='50%'; eff.style.top='40%'; 
      eff.style.color='#e74c3c'; eff.style.fontWeight='900'; eff.style.fontSize='2rem'; 
      eff.style.pointerEvents='none'; eff.style.animation='floatUp 0.8s forwards';
      document.body.appendChild(eff);
      setTimeout(()=>eff.remove(), 800);

      if(R.bossHP <= 0) {
        this.state.runtime.timeLeft = 0; // End Game
        clearInterval(this.state.runtime.timerInterval);
        alert('ğŸ‰ ë³´ìŠ¤ í† ë²Œ ì„±ê³µ!! ë³´ìƒ: ğŸ’ 300');
        this.addCoin(300);
        try{ updateMission && updateMission('boss_win', 1); }catch{}
        this.showResult();
      }
    }

    // Mic
    toggleMic() {
      if(!('webkitSpeechRecognition' in window)) return alert('í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ê°€ëŠ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
      if(this.micListening) { this.rec.stop(); return; }

      const rec = new window.webkitSpeechRecognition();
      rec.lang = 'en-US'; 
      rec.interimResults = false; 
      rec.maxAlternatives = 1;

      this.micListening = true;
      this.$('micBtn').classList.add('listening');

      rec.onstart = () => { this.toast('ğŸ¤ ë“£ê³  ìˆì–´ìš”...'); };
      rec.onresult = (e) => {
        const txt = e.results[0][0].transcript;
        this.$('answerInput').value = txt;
        this.handleCheck(); // Auto submit
      };
      rec.onend = () => { this.micListening = false; this.$('micBtn').classList.remove('listening'); };
      rec.onerror = () => { this.micListening = false; this.$('micBtn').classList.remove('listening'); };

      rec.start();
      this.rec = rec;
    }

    setSpeed(val) {
      this.state.data.settings.ttsSpeed = val;
      this.saveKey('myVocaSettings', this.state.data.settings);
      this.updateSpeedUI();
      this.toast(`ë°œìŒ ì†ë„: ${val}x`);
      this.speakWord("Speed check", val); // Test sound
    }

    updateSpeedUI() {
      const D=this.state.data;
      const s = D.settings.ttsSpeed || 1.0;
      const sc = D.settings.ttsRateCorrect || 1.0;
      const sw = D.settings.ttsRateWrong || 0.85;

      const setActive = (containerId, value)=>{
        const el = document.getElementById(containerId);
        if(!el) return;
        const btns = el.querySelectorAll('.speed-btn');
        btns.forEach(b=>{
          const v = parseFloat(String(b.innerText).replace('x',''));
          b.classList.toggle('active', v === value);
        });
      };

      setActive('speedControl', s);
      setActive('speedControlCorrect', sc);
      setActive('speedControlWrong', sw);
    }

    toggleListenMode() {
      const R = this.state.runtime;
      R.isListeningMode = !R.isListeningMode;

      // âœ… CSS(.listening-mode â€¦)ì™€ JS ìƒíƒœë¥¼ í•œ ë°©ì‹ìœ¼ë¡œ í†µì¼: body í´ë˜ìŠ¤ í† ê¸€
      document.body.classList.toggle('listening-mode', R.isListeningMode);

      const btn = this.$('listenModeBtn');
      const qBox = this.$('question');

      if (R.isListeningMode) {
        btn.innerText = 'ğŸ‘‚';
        btn.style.background = '#e84393';
        btn.style.color = '#fff';
        // ì§ˆë¬¸ í…ìŠ¤íŠ¸ëŠ” ìœ ì§€(ìˆ¨ê¹€ì€ CSSì—ì„œ ì²˜ë¦¬) â€” ë‹¤ìŒì— OFFë¡œ ëŒì•„ì˜¬ ë•Œ ë³µêµ¬ê°€ ì•ˆì „í•¨
        if (R.currentWord) qBox.innerText = R.currentWord.kan;

        // í˜„ì¬ ë¬¸ì œ ë°œìŒ(ë¦¬ìŠ¤ë‹ ëª¨ë“œì— ë“¤ì–´ê°ˆ ë•Œ)
        try { this.playCurrentWordTTS(); } catch {}
      } else {
        btn.innerText = 'ğŸ‘ï¸';
        btn.style.background = '';
        btn.style.color = '';
        if (R.currentWord) qBox.innerText = R.currentWord.kan;
      }

      this.toast(R.isListeningMode ? 'ë¦¬ìŠ¤ë‹ ëª¨ë“œ: ON ğŸ§' : 'ë¦¬ìŠ¤ë‹ ëª¨ë“œ: OFF ğŸ‘ï¸');
    }

    speakText(text, lang='en-US', slow=false){
      const R = this.state.runtime;
      if(R.isMuted) return;

      if(!('speechSynthesis' in window) || typeof SpeechSynthesisUtterance === 'undefined'){
        return;
      }
      const msg = String(text || '').trim();
      if(!msg) return;

      let u;
      try{
        u = new SpeechSynthesisUtterance(msg);
      }catch(e){
        return;
      }
      u.lang = lang;
      u.rate = slow ? 0.85 : (this.state.data.settings.ttsSpeed || 1.0);

      try{ window.speechSynthesis.speak(u); }catch{}
    }

    speakBoth(eng, kan){
      // ì˜ì–´ â†’ (ì§§ì€ ê°„ê²©) í•œêµ­ì–´
      // í•œêµ­ì–´ TTSëŠ” ê¸°ê¸°ë§ˆë‹¤ ì§€ì› í¸ì°¨ê°€ ìˆì–´ì„œ ì‹¤íŒ¨í•´ë„ ì•±ì€ ì •ìƒ ë™ì‘
      this.speakWord(eng);
      if(kan){
        setTimeout(()=>{ try{ this.speakText(kan, 'ko-KR'); }catch{} }, 900);
      }
    }

    printWrongNotes() {

      const D = this.state.data;
      if (D.wrongWords.length === 0) return alert('ì˜¤ë‹µ ë…¸íŠ¸ê°€ ë¹„ì–´ìˆì–´ìš”!');

      const printDiv = this.$('print-area');
      const today = new Date().toLocaleDateString();

      let html = `
        <h1 style="text-align:center; border-bottom:2px solid #333; padding-bottom:10px;">ğŸ“‘ ì˜¤ë‹µ ë…¸íŠ¸ / í…ŒìŠ¤íŠ¸ì§€</h1>
        <div style="text-align:right; margin-bottom:20px; font-weight:bold;">ë‚ ì§œ: ${today} &nbsp;&nbsp; ì´ë¦„: ____________</div>
        <table style="width:100%; border-collapse:collapse; margin-top:20px;">
          <tr style="background:#eee;">
            <th style="border:1px solid #333; padding:10px; width:10%;">No.</th>
            <th style="border:1px solid #333; padding:10px; width:40%;">ëœ» (Meaning)</th>
            <th style="border:1px solid #333; padding:10px; width:50%;">ë‹¨ì–´ ì“°ê¸° (Spelling)</th>
          </tr>
      `;

      D.wrongWords.forEach((w, i) => {
        html += `
          <tr>
            <td style="border:1px solid #333; padding:12px; text-align:center;">${i+1}</td>
            <td style="border:1px solid #333; padding:12px; font-weight:bold;">${w.kan}</td>
            <td style="border:1px solid #333; padding:12px;"></td> 
          </tr>
        `; // ë¹ˆì¹¸ìœ¼ë¡œ ì¶œë ¥
      });

      html += '</table><div style="margin-top:30px; text-align:center; color:#888;">- VOCA ë§ˆìŠ¤í„° PRO ì¸ì‡„ ëª¨ë“œ -</div>';

      printDiv.innerHTML = html;
      window.print();
    }
switchTab(key){
      this.$('panel-learn').classList.toggle('hidden', key!=='learn');
      this.$('panel-record').classList.toggle('hidden', key!=='record');
      this.$('panel-settings').classList.toggle('hidden', key!=='settings');
      this.$('panel-shop').classList.toggle('hidden', key!=='shop');
      this.$('tab-shop').classList.toggle('active', key==='shop');
      this.$('tab-shop').setAttribute('aria-selected', key==='shop');
      if(key==='shop') this.initShop();


      this.$('tab-learn').classList.toggle('active', key==='learn');
      this.$('tab-record').classList.toggle('active', key==='record');
      this.$('tab-settings').classList.toggle('active', key==='settings');

      this.$('tab-learn').setAttribute('aria-selected', key==='learn');
      this.$('tab-record').setAttribute('aria-selected', key==='record');
      this.$('tab-settings').setAttribute('aria-selected', key==='settings');

      if(key==='record'){ this.renderGrass(); this.renderBadges(); this.renderBest(); }
    }

    /* ---------- Home UI ---------- */
    calculateStreak(){
      const { attendanceData } = this.state.data;
      let streak=0;
      let d=new Date();
      const todayStr=this.dateStrOf(d);

      if(attendanceData[todayStr] && attendanceData[todayStr]>0){
        streak++; d.setDate(d.getDate()-1);
        while(attendanceData[this.dateStrOf(d)]>0){ streak++; d.setDate(d.getDate()-1); }
      }else{
        d.setDate(d.getDate()-1);
        if(attendanceData[this.dateStrOf(d)]>0){
          streak++; d.setDate(d.getDate()-1);
          while(attendanceData[this.dateStrOf(d)]>0){ streak++; d.setDate(d.getDate()-1); }
        }
      }
      return streak;
    }

    recordGrassOneWord(){
      const D = this.state.data;
      const ds = this.dateStrOf(new Date());
      D.attendanceData[ds] = (D.attendanceData[ds]||0) + 1;
      this.saveKey('myVocaAttendance', D.attendanceData);

      // ëª©í‘œ ë³´ìƒ(í•˜ë£¨ 1íšŒ)
      const goalKey = 'myVocaGoalReward_' + ds;
      if(D.attendanceData[ds] >= D.settings.dailyGoal && !localStorage.getItem(goalKey)){
        D.playerExp += 30;
        if(D.playerExp >= 100){ D.playerLevel++; D.playerExp -= 100; this.showParticles('ğŸ…'); }
        this.saveKey('myVocaLevel', D.playerLevel);
        this.saveKey('myVocaExp', D.playerExp);
        localStorage.setItem(goalKey, '1');
        this.unlockBadge('goal_1');
      }
      this.updateGoal7Badge();
    }

    renderHomeMini(){
      const D = this.state.data;
      const ds = this.dateStrOf(new Date());
      const todayCount = D.attendanceData[ds] || 0;
      const streak = this.calculateStreak();

      this.$('streak-pill').innerText = `ğŸ”¥ ì—°ì†: ${streak}ì¼`;
      this.$('today-pill').innerText = `ì˜¤ëŠ˜: ${todayCount}ë‹¨ì–´`;
      this.$('goal-pill').innerText = `ëª©í‘œ: ${D.settings.dailyGoal}`;

      if(streak >= 3) this.unlockBadge('streak_3');
      if(streak >= 7) this.unlockBadge('streak_7');
      if(streak >= 14) this.unlockBadge('streak_14');

      this.updateGameUI();
      this.checkMainButtons();
    }

    renderGrass(){
      const grid = this.$('grass-grid');
      if(!grid) return;
      const { attendanceData } = this.state.data;
      grid.innerHTML='';
      const today = new Date();
      for(let i=27;i>=0;i--){
        const d=new Date();
        d.setDate(today.getDate()-i);
        const ds=this.dateStrOf(d);
        const count=attendanceData[ds]||0;
        const box=document.createElement('div');
        box.className='grass-box';
        if(count>=15) box.classList.add('grass-lvl-4');
        else if(count>=10) box.classList.add('grass-lvl-3');
        else if(count>=5) box.classList.add('grass-lvl-2');
        else if(count>0) box.classList.add('grass-lvl-1');
        box.setAttribute('data-info', `${d.getMonth()+1}ì›” ${d.getDate()}ì¼: ${count}ê°œ`);
        grid.appendChild(box);
      }
    }

    updateGameUI(){
      const D = this.state.data;
      const R = this.state.runtime;
      const pct = Math.min((D.playerExp/100)*100, 100);

      this.$('home-level-text').innerText = `Lv. ${D.playerLevel}`;
      this.$('home-exp-text').innerText = `${D.playerExp} / 100 EXP`;
      this.$('home-exp-bar').style.width = pct + '%';

      this.$('quiz-level-text').innerText = `Lv. ${D.playerLevel}`;
      this.$('quiz-exp-bar').style.width = pct + '%';

      this.$('muteBtn').innerText = R.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      this.$('sfxBtn').innerText = D.settings.sfx ? 'ğŸ””' : 'ğŸ”•';

      // ì½¤ë³´/í”¼ë²„
      const comboEl = this.$('quiz-combo-text');
      if(R.combo >= 3){
        document.body.classList.add('fever');
        this.$('quiz-screen').classList.add('fever-glow');
        comboEl.innerText = `${R.combo} Combo! ğŸ”¥`;
      }else{
        document.body.classList.remove('fever');
        this.$('quiz-screen').classList.remove('fever-glow');
        comboEl.innerText = (R.combo > 1) ? `${R.combo} Combo!` : '';
      }
    }

    checkMainButtons(){
      const D = this.state.data;
      this.$('btn-play-custom').classList.toggle('hidden', D.customWords.length===0);
      this.$('btn-play-review').classList.toggle('hidden', D.wrongWords.length===0);
    }

    /* ---------- Badges ---------- */
    unlockBadge(id){
      const D = this.state.data;
      if(D.badges[id]) return;
      D.badges[id] = true;
      this.saveKey('myVocaBadges', D.badges);
      // ìƒˆ ë°°ì§€ëŠ” ê³¼í•˜ì§€ ì•Šê²Œ í† ìŠ¤íŠ¸
      this.toast(`ë°°ì§€ íšë“! ğŸ…`);
    }

    renderBadges(){
      const D = this.state.data;
      const wrap = this.$('badge-wrap');
      if(!wrap) return;
      wrap.innerHTML='';
      let unlocked=0;
      this.BADGE_DEF.forEach(b=>{
        const on=!!D.badges[b.id];
        if(on) unlocked++;
        const el=document.createElement('div');
        el.className='badge'+(on?'':' lock');
        el.title=b.desc;
        el.innerHTML=`${b.icon} <strong>${b.name}</strong>`;
        wrap.appendChild(el);
      });
      this.$('badge-summary').innerText = `${unlocked}/${this.BADGE_DEF.length}`;
    }

    updateGoal7Badge(){
      const D = this.state.data;
      const keys = Object.keys(D.attendanceData);
      let cnt=0;
      for(const k of keys){
        if((D.attendanceData[k]||0) >= D.settings.dailyGoal) cnt++;
      }
      if(cnt >= 7) this.unlockBadge('goal_7');
    }

    /* ---------- Settings ---------- */
    initSettingsUI(){
      const D = this.state.data;
      const goalSel=this.$('dailyGoalSelect');
      const autoSel=this.$('autoTTSSelect');
      const typoSel=this.$('typoSelect');
      const sfxSel=this.$('sfxSelect');
      const delaySel=this.$('postTTSDelaySelect');
      const mixSel=this.$('mixModeSelect');

      goalSel.value=String(D.settings.dailyGoal||10);
      autoSel.value=D.settings.autoTTS?'on':'off';
      typoSel.value=D.settings.typoHelp?'on':'off';
      sfxSel.value=D.settings.sfx?'on':'off';
      if(delaySel) delaySel.value=String(D.settings.postTTSDelay||180);
      if(mixSel) mixSel.value=D.settings.mixMode?'on':'off';

      this.updateSpeedUI();

      goalSel.addEventListener('change',()=>{
        D.settings.dailyGoal=parseInt(goalSel.value);
        this.saveKey('myVocaSettings', D.settings);
        this.renderHomeMini();
        this.updateGoal7Badge();
      });
      autoSel.addEventListener('change',()=>{
        D.settings.autoTTS=(autoSel.value==='on');
        this.saveKey('myVocaSettings', D.settings);
      });
      typoSel.addEventListener('change',()=>{
        D.settings.typoHelp=(typoSel.value==='on');
        this.saveKey('myVocaSettings', D.settings);
      });
      sfxSel.addEventListener('change',()=>{
        D.settings.sfx=(sfxSel.value==='on');
        this.saveKey('myVocaSettings', D.settings);
        this.updateGameUI();
      });

      if(delaySel){
        delaySel.addEventListener('change',()=>{
          D.settings.postTTSDelay=parseInt(delaySel.value);
          this.saveKey('myVocaSettings', D.settings);
        });
      }
      if(mixSel){
        mixSel.addEventListener('change',()=>{
          D.settings.mixMode=(mixSel.value==='on');
          this.saveKey('myVocaSettings', D.settings);
          this.toast(D.settings.mixMode ? 'ğŸ² í˜¼í•© ì¶œì œ ON' : 'í˜¼í•© ì¶œì œ OFF');
        });
      }
    }

    /* ---------- Maker ---------- */
    openMaker(){
      this.$('setup-screen').classList.add('hidden');
      this.$('maker-screen').classList.remove('hidden');
      this.renderCustomList();
      this.$('newKan').focus();
    }
    closeMaker(){
      this.$('maker-screen').classList.add('hidden');
      this.$('setup-screen').classList.remove('hidden');
      this.renderHomeMini();
    }

    
    // ===== í•™ë…„ë³„ ëª¨ë“œ =====
    openGrade(){
      this.$('setup-screen').classList.add('hidden');
      this.$('grade-screen').classList.remove('hidden');
      const info=this.$('grade-info');
      if(info) info.innerHTML='í•™ë…„/ë‚œì´ë„ë¥¼ ì„ íƒí•˜ê³  â€œë‹¨ì–´ ìˆ˜ ë³´ê¸°â€ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.';
    }
    closeGrade(){
      this.$('grade-screen').classList.add('hidden');
      this.$('setup-screen').classList.remove('hidden');
      this.renderHomeMini();
    }

    normalizeGradeJson(json){
      // ì§€ì› í¬ë§·:
      // 1) { "g1":[{kan,eng,level?}], ..., "g6":[...] }
      // 2) { "grades": { "1":[...], "2":[...], ... } }
      let out={g1:[],g2:[],g3:[],g4:[],g5:[],g6:[]};
      if(!json) return out;
      if(json.grades){
        for(const k of Object.keys(json.grades)){
          const g = parseInt(k,10);
          if(g>=1 && g<=6){
            out['g'+g] = (json.grades[k]||[]).map(w=>({
              kan:w.kan, eng:w.eng,
              grade: g,
              level: Math.min(5, Math.max(1, parseInt(w.level ?? 3,10)))
            }));
          }
        }
        return out;
      }
      for(let g=1; g<=6; g++){
        const key='g'+g;
        if(Array.isArray(json[key])){
          out[key] = json[key].map(w=>({
            kan:w.kan, eng:w.eng,
            grade: g,
            level: Math.min(5, Math.max(1, parseInt(w.level ?? 3,10)))
          }));
        }
      }
      return out;
    }

    async loadExternalGradeWords(){
      // GitHub Pages ë“±ì—ì„œ ê°™ì€ ê²½ë¡œì— grade_words.jsonì´ ìˆìœ¼ë©´ ìë™ ë¡œë“œ(ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ)
      try{
        const res = await fetch('grade_words.json', {cache:'no-store'});
        if(!res.ok) return;
        const json = await res.json();
        const normalized = this.normalizeGradeJson(json);
        const G = this.state.data.grades;
        for(let g=1; g<=6; g++){
          const key='g'+g;
          if(normalized[key]?.length){
            // ì¤‘ë³µ(eng ê¸°ì¤€) ì œê±°í•˜ë©´ì„œ í•©ì¹˜ê¸°
            const seen = new Set((G[key]||[]).map(w=>this.normalizeEng(w.eng)));
            for(const w of normalized[key]){
              const e=this.normalizeEng(w.eng);
              if(!e || seen.has(e)) continue;
              seen.add(e);
              G[key].push(w);
            }
          }
        }
        this.toast('ğŸ“š í•™ë…„ë³„ ë‹¨ì–´ JSON ë¡œë“œ ì™„ë£Œ!');
      }catch(e){
        // ignore
      }
    }

    getGradePool(maxGrade, range){
      const G=this.state.data.grades;
      const pool=[];
      for(let g=1; g<=6; g++){
        if(range==='single' && g!==maxGrade) continue;
        if(range!=='single' && g>maxGrade) continue;
        const key='g'+g;
        if(Array.isArray(G[key])) pool.push(...G[key]);
      }
      // ìµœì†Œ í•„ë“œ ë³´ì •
      return pool
        .filter(w=>w && w.kan && w.eng)
        .map(w=>({kan:w.kan, eng:w.eng, grade: w.grade ?? maxGrade, level: Math.min(5, Math.max(1, parseInt(w.level ?? 3,10)))}));
    }

    weightPick(list, weights){
      // list items must have level 1..5
      const bins={1:[],2:[],3:[],4:[],5:[]};
      for(const w of list) bins[w.level].push(w);
      const out=[];
      // build selection order roughly by weights
      const totalW = weights.reduce((a,b)=>a+b,0);
      const tries = list.length*2+10;
      for(let i=0;i<tries && out.length<list.length;i++){
        const r=Math.random()*totalW;
        let acc=0, lvl=1;
        for(let k=0;k<5;k++){
          acc+=weights[k];
          if(r<=acc){ lvl=k+1; break; }
        }
        if(bins[lvl].length){
          out.push(bins[lvl].pop());
        }else{
          // fallback: take from any
          for(let l=1;l<=5;l++){
            if(bins[l].length){ out.push(bins[l].pop()); break; }
          }
        }
      }
      // if leftovers
      for(let l=1;l<=5;l++) out.push(...bins[l]);
      return out;
    }

    buildGradeSessionList(cfg){
      const poolAll=this.getGradePool(cfg.maxGrade, cfg.range);
      const capByMode = (mode)=>{
        if(mode==='easy') return 2;
        if(mode==='normal') return 4;
        if(mode==='hard') return 5;
        if(mode==='auto') return cfg.cap; // dynamic
        return 4;
      };
      const cap=capByMode(cfg.mode);
      let pool = poolAll.filter(w=>w.level<=cap);
      // hardëŠ” ìƒìœ„ ë¹„ì¤‘â†‘
      if(cfg.mode==='hard'){
        pool = this.weightPick(poolAll, [1,2,3,4,6]); // Lv5 ë¹„ì¤‘â†‘
      }
      // ì¤‘ë³µ(eng) ì œê±°
      const seen=new Set();
      const unique=[];
      for(const w of pool){
        const e=this.normalizeEng(w.eng);
        if(!e || seen.has(e)) continue;
        seen.add(e); unique.push(w);
      }
      this.shuffle(unique);
      return unique.slice(0, cfg.target);
    }

    previewGradeCount(){
      const maxGrade=parseInt(this.$('grade-max').value,10);
      const range=this.$('grade-range').value;
      const mode=this.$('grade-difficulty').value;
      const target=parseInt(this.$('grade-target').value,10);

      const poolAll=this.getGradePool(maxGrade, range);
      const distAll={1:0,2:0,3:0,4:0,5:0};
      for(const w of poolAll) distAll[w.level]++;

      const cap = (mode==='easy')?2:(mode==='normal')?4:(mode==='hard')?5:2;
      const poolInit = poolAll.filter(w=>w.level<=cap);
      const distInit={1:0,2:0,3:0,4:0,5:0};
      for(const w of poolInit) distInit[w.level]++;

      let html = `<b>ì´ ë‹¨ì–´</b>: ${poolAll.length}ê°œ<br/>` +
                 `<b>Lv ë¶„í¬(ì „ì²´)</b>: ` +
                 `Lv1 ${distAll[1]} / Lv2 ${distAll[2]} / Lv3 ${distAll[3]} / Lv4 ${distAll[4]} / Lv5 ${distAll[5]}<br/><br/>`;

      if(mode==='auto'){
        html += `ìë™ìƒìŠ¹(ì´ˆê¸° ìƒí•œ Lv2) ê¸°ì¤€<br/>` +
                `<b>ì´ˆê¸° ì‚¬ìš© ê°€ëŠ¥</b>: ${poolInit.length}ê°œ â€” ` +
                `Lv1 ${distInit[1]} / Lv2 ${distInit[2]} / Lv3 ${distInit[3]} / Lv4 ${distInit[4]} / Lv5 ${distInit[5]}<br/>` +
                `â€» ì •ë‹µ 10ê°œë§ˆë‹¤ ìƒí•œì´ 1ì”© ì˜¬ë¼ê°€ë©°(ìµœëŒ€ 5) Lv3~5 ë‹¨ì–´ê°€ ì ì  ì„ì…ë‹ˆë‹¤.<br/>`;
      }else{
        html += `<b>ì„ íƒ ì¡°ê±´(ì´ˆê¸° ìƒí•œ Lv${cap})</b>: ${poolInit.length}ê°œ â€” ` +
                `Lv1 ${distInit[1]} / Lv2 ${distInit[2]} / Lv3 ${distInit[3]} / Lv4 ${distInit[4]} / Lv5 ${distInit[5]}<br/>`;
      }

      html += `<br/><b>í•œ íŒ ëª©í‘œ</b>: ${target}ê°œ`;
      this.$('grade-info').innerHTML = html;
    }

    startGradeQuiz(){
      const R=this.state.runtime;
      const maxGrade=parseInt(this.$('grade-max').value,10);
      const range=this.$('grade-range').value;
      const mode=this.$('grade-difficulty').value;
      const target=parseInt(this.$('grade-target').value,10);

      const poolAll=this.getGradePool(maxGrade, range);
      if(!poolAll.length){
        alert('í•™ë…„ë³„ ë‹¨ì–´ê°€ ë¹„ì–´ìˆì–´ìš”. (grade_words.json ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” ë‚´ì¥ ë°ì´í„° ì—†ìŒ)');
        return;
      }

      R.grade = {
        enabled:true,
        maxGrade, range, mode, target,
        cap: (mode==='auto')?2:((mode==='easy')?2:(mode==='normal')?4:5),
        poolAll,
        seenEng: new Set(),
      };

      this.$('grade-screen').classList.add('hidden');
      this.$('setup-screen').classList.add('hidden');
      // initQuiz ì•ˆì—ì„œ quiz-screenì„ ì—´ì§€ë§Œ, UXìƒ ë°”ë¡œ ë„˜ì–´ê°€ë„ë¡ closeGrade ëŒ€ì‹  ì§„í–‰
      this.initQuiz('grade');
    }

    mixInHarderGradeWords(){
      const R=this.state.runtime;
      if(!R.grade?.enabled) return;
      const cfg=R.grade;
      const cap=cfg.cap;

      const existing = new Set((R.currentList||[]).map(w=>this.normalizeEng(w.eng)));

      const candidates = cfg.poolAll
        .filter(w=>w.level<=cap)
        .filter(w=>{
          const e=this.normalizeEng(w.eng);
          return e && !cfg.seenEng.has(e) && !existing.has(e);
        });

      this.shuffle(candidates);

      // ë‹¤ìŒ ë¬¸ì œë“¤(í˜„ì¬ ë‹¨ì–´ ì œì™¸)ì— 3~6ê°œ ì •ë„ ë¼ì›Œ ë„£ê¸°
      const inject = Math.min(6, Math.max(3, Math.floor(((R.currentList?.length||0)-1)/6) || 3));
      for(let i=0;i<inject && candidates.length;i++){
        const w=candidates.pop();
        const pos = 1 + Math.floor(Math.random() * Math.max(1, (R.currentList.length-1)));
        R.currentList.splice(pos, 0, w);
      }

      // ëª©í‘œ ê°œìˆ˜ ìœ ì§€
      const target = cfg.target || R.currentList.length;
      if(R.currentList.length > target) R.currentList.length = target;
    }


    addCustomWord(){
      const D = this.state.data;
      const kan=this.$('newKan').value.trim();
      const eng=this.normalizeEng(this.$('newEng').value);
      if(!kan || !eng) return alert('ëœ»ê³¼ ì˜ë‹¨ì–´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      if(D.customWords.some(w=>this.normalizeEng(w.eng)===eng)) return alert('ì´ë¯¸ ìˆëŠ” ë‹¨ì–´ì˜ˆìš”(ì˜ì–´ ê¸°ì¤€).');
      D.customWords.push({kan,eng});
      this.saveKey('myVocaCustom', D.customWords);
      this.$('newKan').value=''; this.$('newEng').value='';
      this.renderCustomList();
      this.checkMainButtons();
    }

    renderCustomList(){
      const D = this.state.data;
      this.$('custom-count').innerText = `ì´ ${D.customWords.length}ê°œ`;
      const ul=this.$('custom-words-list');
      ul.innerHTML='';
      if(D.customWords.length===0){
        ul.innerHTML="<li style='justify-content:center; padding:14px;'>ì•„ì§ ë‹¨ì–´ê°€ ì—†ì–´ìš”.</li>";
        return;
      }
      D.customWords.forEach((w,i)=>{
        const li=document.createElement('li');
        li.innerHTML=`
          <span><b>${w.kan}</b> : ${w.eng}</span>
          <button class="mini-btn btn-danger" onclick="window.__voca.deleteCustomWord(${i})">ì‚­ì œ</button>
        `;
        ul.appendChild(li);
      });
    }

    deleteCustomWord(i){
      const D = this.state.data;
      D.customWords.splice(i,1);
      this.saveKey('myVocaCustom', D.customWords);
      this.renderCustomList();
      this.checkMainButtons();
    }

    parseBulkLine(line){
      const t=line.trim();
      if(!t) return null;
      let parts=t.split(/[\t,]/).map(x=>x.trim()).filter(Boolean);
      if(parts.length<2) parts=t.split(/\s+/);
      if(parts.length<2) return null;
      return {kan:parts[0], eng:this.normalizeEng(parts[1])};
    }

    addBulk(){
      const D = this.state.data;
      const text=this.$('bulkArea').value;
      const lines=text.split('\n');
      let added=0, skipped=0;
      for(const line of lines){
        const item=this.parseBulkLine(line);
        if(!item){ skipped++; continue; }
        if(D.customWords.some(w=>this.normalizeEng(w.eng)===item.eng)){ skipped++; continue; }
        D.customWords.push({kan:item.kan.trim(), eng:item.eng});
        added++;
      }
      this.saveKey('myVocaCustom', D.customWords);
      this.renderCustomList();
      this.checkMainButtons();
      alert(`ì™„ë£Œ! ì¶”ê°€ ${added}ê°œ / ê±´ë„ˆëœ€ ${skipped}ê°œ`);
    }

    clearBulk(){ this.$('bulkArea').value=''; }

    exportCustom(){
      const D = this.state.data;
      const payload={ type:"customWords", customWords:D.customWords, exportedAt:new Date().toISOString() };
      this.$('backupArea').value=JSON.stringify(payload);
    }

    async copyBackup(){
      const val=this.$('backupArea').value.trim();
      if(!val) return alert('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ì–´ìš”.');
      try{ await navigator.clipboard.writeText(val); alert('ë³µì‚¬ ì™„ë£Œ!'); }
      catch{ alert('ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ). ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.'); }
    }

    importCustom(){
      const D = this.state.data;
      const val=this.$('backupArea').value.trim();
      if(!val) return alert('ê°€ì ¸ì˜¬ JSONì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.');
      try{
        const obj=JSON.parse(val);
        const list=obj.customWords || obj.words || [];
        if(!Array.isArray(list)) throw new Error();
        let added=0;
        for(const w of list){
          if(!w?.kan || !w?.eng) continue;
          const eng=this.normalizeEng(w.eng);
          if(D.customWords.some(x=>this.normalizeEng(x.eng)===eng)) continue;
          D.customWords.push({kan:String(w.kan).trim(), eng});
          added++;
        }
        this.saveKey('myVocaCustom', D.customWords);
        this.renderCustomList();
        this.checkMainButtons();
        alert(`ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! ì¶”ê°€ ${added}ê°œ`);
      }catch{
        alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.');
      }
    }

    /* ---------- Quiz ---------- */
    buildWrongReviewList(){
      const D = this.state.data;
      const sorted=[...D.wrongWords].sort((a,b)=>{
        const aw=a.wrongCount||1, bw=b.wrongCount||1;
        const al=a.lastWrong||0, bl=b.lastWrong||0;
        if(bw!==aw) return bw-aw;
        return bl-al;
      });
      return sorted.slice(0,40).map(w=>({kan:w.kan, eng:w.eng}));
    }

    initQuiz(category){
      const D = this.state.data;
      const R = this.state.runtime;

      clearInterval(R.timerInterval);
      this.$('timer-display').classList.add('hidden');
      this.$('timer-display').classList.remove('danger');

      this.$('hintArea').style.display='none';
      this.$('hintArea').innerHTML='';
      this.$('feedback').innerText='';
      this.$('nearBanner').style.display='none';
      this.$('nearBanner').innerText='';

      R.attempts=0; R.correctCount=0; R.combo=0; R.score=0;
      R.isListeningMode=false; // ëª¨ë“œ ì „í™˜ ì‹œ ì´ˆê¸°í™”
      R.spellMode=false; // ì² ì í€´ì¦ˆ ëª¨ë“œ ì´ˆê¸°í™”
      R.isBossMode = false; // ë³´ìŠ¤ ë ˆì´ë“œ ì¢…ë£Œ ì‹œ ì•ˆì „ì¥ì¹˜
      R.isTimeMode = (category==='time');

      if(category==='time') R.currentList=[...this.wordBank.verbs,...this.wordBank.nouns,...this.wordBank.adjectives,...D.customWords];
      else if(category==='dictation') {
        R.currentList=[...this.wordBank.verbs,...this.wordBank.nouns,...this.wordBank.adjectives,...D.customWords];
        R.isListeningMode = true;
      }
      else if(category==='random') {
        R.currentList=[...this.wordBank.verbs,...this.wordBank.nouns,...this.wordBank.adjectives,...(this.wordBank.adverbs||[]),...D.customWords];
      }
      else if(category==='spelling') {
        R.currentList=[...this.wordBank.verbs,...this.wordBank.nouns,...this.wordBank.adjectives,...(this.wordBank.adverbs||[]),...D.customWords];
        R.spellMode = true;
      }
      else if(category==='custom') R.currentList=[...D.customWords];
      else if(category==='wrong') R.currentList=this.buildWrongReviewList();
      else if(category==='grade') {
        const cfg=this.state.runtime.grade;
        if(!cfg) { alert('í•™ë…„ë³„ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
        // ì´ˆê¸° ë¦¬ìŠ¤íŠ¸ êµ¬ì„±
        this.state.runtime.quizLimit = cfg.target;
        // hardëŠ” ê°€ì¤‘ ìƒ˜í”Œë§, autoëŠ” cap ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘
        if(cfg.mode==='hard') {
          const weighted=this.weightPick(cfg.poolAll, [1,2,3,4,6]);
          this.shuffle(weighted);
          // ì¤‘ë³µ ì œê±°
          const seen=new Set();
          const out=[];
          for(const w of weighted){ const e=this.normalizeEng(w.eng); if(!e||seen.has(e)) continue; seen.add(e); out.push(w); if(out.length>=cfg.target) break; }
          R.currentList=out;
        } else {
          R.currentList=this.buildGradeSessionList(cfg);
        }
      }
      else R.currentList=[...this.wordBank[category]];

      // í•œë²ˆ ì„ê³ (ì¤‘ë³µ ì¶œì œ ë°©ì§€) ìˆœì„œëŒ€ë¡œ ì§„í–‰
      this.shuffle(R.currentList);

      if(!R.currentList.length){
        alert('ë‹¨ì–´ê°€ ì—†ì–´ìš”! ë¨¼ì € ë‹¨ì–´ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ë‹¤ë¥¸ ëª¨ë“œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      this.$('setup-screen').classList.add('hidden');

      // ì‹œí—˜ ì „ í”Œë˜ì‹œì¹´ë“œ í•™ìŠµ(ì™„ì„±í˜•)
      this.openStudySession(category);
    }

    openStudySession(category){
      const R = this.state.runtime;

      // í•™ìŠµ ì¹´ë“œ ì„¸ì…˜ ì¤€ë¹„
      R.study.active = true;
      R.study.idx = 0;
      R.study.list = (R.currentList || []).map(w=>({ ...w })); // í…ŒìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸ì™€ ë¶„ë¦¬
      R.study.showMeaning = true;
      // ìë™ ì¬ìƒì€ ê¸°ë³¸ OFF (ì›í•˜ë©´ ë²„íŠ¼ìœ¼ë¡œ ì¼¬)
      if(R.study.timer){ try{ clearInterval(R.study.timer); }catch{} R.study.timer=null; }

      // í™”ë©´ ì „í™˜
      this.$('quiz-screen').classList.add('hidden');
      this.$('study-screen').classList.remove('hidden');

      // ë²„íŠ¼ UI
      this.syncStudyButtons();
      this.renderStudyCard(true);
    }

    syncStudyButtons(){
      const R=this.state.runtime;
      const mBtn=this.$('studyMeaningBtn');
      if(mBtn){
        mBtn.innerText = R.study.showMeaning ? 'ğŸ“' : 'ğŸ™ˆ';
        mBtn.style.background = R.study.showMeaning ? '' : '#2c3e50';
        mBtn.style.color = R.study.showMeaning ? '' : '#fff';
      }
      const aBtn=this.$('studyAutoBtn');
      if(aBtn){
        aBtn.innerText = R.study.auto ? 'â¸ï¸' : 'â¯ï¸';
        aBtn.style.background = R.study.auto ? '#27ae60' : '';
        aBtn.style.color = R.study.auto ? '#fff' : '';
      }
    }

    toggleStudyMeaning(){
      const R=this.state.runtime;
      R.study.showMeaning = !R.study.showMeaning;
      this.syncStudyButtons();
      this.renderStudyCard(false);
    }

    toggleStudyAuto(){
      const R=this.state.runtime;
      R.study.auto = !R.study.auto;
      this.syncStudyButtons();

      if(R.study.auto){
        // 2.6ì´ˆë§ˆë‹¤ ë‹¤ìŒ ì¹´ë“œ(ë„ˆë¬´ ë¹ ë¥´ë©´ í•™ìŠµì´ ì•ˆë¨)
        R.study.timer = setInterval(()=>{
          if(!R.study.active) return;
          if(R.study.idx >= R.study.list.length-1){
            this.toggleStudyAuto(); // ìë™ ì¢…ë£Œ
            return;
          }
          this.studyNext(true);
        }, 2600);
      }else{
        if(R.study.timer){ try{ clearInterval(R.study.timer); }catch{} }
        R.study.timer=null;
      }
    }

    renderStudyCard(playAudio){
      const R=this.state.runtime;
      const list=R.study.list||[];
      const idx=R.study.idx||0;
      const w=list[idx];
      this.$('study-progress').innerText = `${Math.min(idx+1, list.length)} / ${list.length}`;

      const engEl=this.$('studyEng');
      const kanEl=this.$('studyKan');
      if(!w){
        engEl.innerText='(ë‹¨ì–´ ì—†ìŒ)';
        kanEl.innerText='';
        return;
      }

      const eng = (w.eng||'').trim();
      const kan = (w.kan||'').trim();

      engEl.innerText = eng || '(ì˜ì–´ ì—†ìŒ)';
      kanEl.innerText = R.study.showMeaning ? (kan || '') : '';
      kanEl.style.display = R.study.showMeaning ? '' : 'none';

      if(playAudio){
        // ì˜ì–´ + ëœ»(ê°€ëŠ¥í•˜ë©´) ìˆœì„œë¡œ 1íšŒ ë“¤ë ¤ì£¼ê¸°
        try{ this.speakBoth(eng, R.study.showMeaning ? kan : ''); }catch{}
      }
    }

    studySpeak(){
      const R=this.state.runtime;
      const w=(R.study.list||[])[R.study.idx||0];
      if(!w) return;
      this.renderStudyCard(true);
    }

    studyNext(fromAuto=false){
      const R=this.state.runtime;
      if(R.study.idx < (R.study.list.length-1)){
        R.study.idx += 1;
        this.renderStudyCard(true);
      }else if(!fromAuto){
        this.toast('ë§ˆì§€ë§‰ ì¹´ë“œì˜ˆìš”. ì´ì œ ì‹œí—˜ ì‹œì‘í•´ë³¼ê¹Œìš”? âœ…');
      }
    }

    studyPrev(){
      const R=this.state.runtime;
      if(R.study.idx > 0){
        R.study.idx -= 1;
        this.renderStudyCard(true);
      }
    }

    backToHomeFromStudy(){
      const R=this.state.runtime;
      R.study.active=false;
      if(R.study.timer){ try{ clearInterval(R.study.timer); }catch{} R.study.timer=null; }
      this.$('study-screen').classList.add('hidden');
      this.$('setup-screen').classList.remove('hidden');
    }

    startTestFromStudy(){
      const R=this.state.runtime;
      // í•™ìŠµ ì¹´ë“œ ì¢…ë£Œ
      R.study.active=false;
      if(R.study.timer){ try{ clearInterval(R.study.timer); }catch{} R.study.timer=null; }

      this.$('study-screen').classList.add('hidden');
      this.$('quiz-screen').classList.remove('hidden');

      // UI ì—…ë°ì´íŠ¸
      this.updateGameUI();
      this.updateStatsUI();

      // ë¦¬ìŠ¤ë‹ ëª¨ë“œ ë²„íŠ¼ ë°˜ì˜
      const btn = this.$('listenModeBtn');
      if(btn){
        if(R.isListeningMode){ btn.innerText='ğŸ‘‚'; btn.style.background='#e84393'; btn.style.color='#fff'; }
        else { btn.innerText='ğŸ‘ï¸'; btn.style.background=''; btn.style.color=''; }
      }

      if(R.isTimeMode) this.startTimer();
      this.nextQuestion(true);
    }

    skipStudyAndTest(){
      // í˜„ì¬ ì¹´ë“œ ìœ„ì¹˜ì™€ ë¬´ê´€í•˜ê²Œ ì‹œí—˜ìœ¼ë¡œ
      this.startTestFromStudy();
    }


    startTimer(){
      const R = this.state.runtime;
      R.timeLeft=60;
      R.timeModeStart=Date.now();
      const el=this.$('timer-display');
      el.classList.remove('hidden');
      this.$('time-left').innerText=R.timeLeft;

      R.timerInterval=setInterval(()=>{
        R.timeLeft--;
        this.$('time-left').innerText=R.timeLeft;
        if(R.timeLeft<=10) el.classList.add('danger');
        if(R.timeLeft<=5 && R.timeLeft>0) this.playSound('tick');
        if(R.timeLeft<=0){
          this.playSound('wrong');
          alert('â° íƒ€ì„ ì˜¤ë²„! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.');
          this.showResult();
        }
      },1000);
    }

    nextQuestion(isFirst=false){
      const D = this.state.data;
      const R = this.state.runtime;
      if(R.currentList.length===0) return this.showResult();
      R.currentWord = R.currentList[0];

      // ğŸ² í˜¼í•© ì¶œì œ(ì„¤ì •): ë¬¸ì œë§ˆë‹¤ ëª¨ë“œë¥¼ ëœë¤ìœ¼ë¡œ ì„ê¸°
      if(D.settings.mixMode){
        const r = Math.random();
        // 0.0~0.55: ê¸°ë³¸(ëœ»â†’ì˜ì–´), 0.55~0.80: ë“£ê³ ì“°ê¸°, 0.80~1.0: ì² ì
        R.isListeningMode = (r >= 0.55 && r < 0.80);
        R.spellMode = (r >= 0.80);
      }


      const q=this.$('question');
      q.classList.add('flip-out');
      setTimeout(()=>{
        
    if (R.isListeningMode) {
        q.innerHTML = '<div style="font-size:3rem;">ğŸ”Š</div><div style="font-size:1rem; color:#666;">ë“£ê³  ì“°ê¸°</div>';
        setTimeout(() => this.playCurrentWordTTS(), 300);
    } else {
        if(R.spellMode){
          const scrambled = this.scrambleWord(R.currentWord.eng);
          q.innerHTML = `<div style="font-size:2.2rem; letter-spacing:2px;">${scrambled}</div><div style="font-size:1rem; color:#666; font-weight:900; margin-top:4px;">(ì² ì í€´ì¦ˆ)</div>`;
        } else {
          q.innerText = R.currentWord.kan;
        }
    }
;
        q.classList.remove('flip-out');
        q.classList.add('flip-in');
        setTimeout(()=>q.classList.remove('flip-in'), 200);
      }, 200);

      this.$('remaining').innerText=R.currentList.length;
      this.$('answerInput').value='';
      this.$('answerInput').focus();

      // ğŸ“± ëª¨ë°”ì¼: ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì‹œ í™”ë©´ìœ¼ë¡œ ìŠ¤í¬ë¡¤(í‚¤ë³´ë“œë¡œ ê°€ë¦¬ëŠ” ë¬¸ì œ ì™„í™”)
      const ai = this.$('answerInput');
      if(ai && !ai._focusBound){
        ai._focusBound = true;
        ai.addEventListener('focus', ()=>{ try{ ai.scrollIntoView({block:'center', behavior:'smooth'}); }catch{} });
      }

      this.$('feedback').innerText='';
      this.$('hintArea').style.display='none';
      this.$('hintArea').innerHTML='';
      this.$('nearBanner').style.display='none';
      this.$('nearBanner').innerText='';

      if(D.settings.autoTTS){
        if(isFirst) setTimeout(()=>this.speakWord(R.currentWord.eng), 250);
        else this.speakWord(R.currentWord.eng);
      }
    }

    updateStatsUI(){
      const R = this.state.runtime;
      this.$('score').innerText=R.score;
      this.$('attempts').innerText=R.attempts;
      const acc = R.attempts===0 ? 0 : Math.round((R.correctCount/R.attempts)*100);
      try{ if(acc>=90) updateMission && updateMission('high_acc', 1); }catch{}
      this.$('accuracy').innerText=acc;
    }

    playCurrentWordTTS(){
      const R = this.state.runtime;
      if(R.currentWord) this.speakWord(R.currentWord.eng);
      this.$('answerInput').focus();

      // ğŸ“± ëª¨ë°”ì¼: ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì‹œ í™”ë©´ìœ¼ë¡œ ìŠ¤í¬ë¡¤(í‚¤ë³´ë“œë¡œ ê°€ë¦¬ëŠ” ë¬¸ì œ ì™„í™”)
      const ai = this.$('answerInput');
      if(ai && !ai._focusBound){
        ai._focusBound = true;
        ai.addEventListener('focus', ()=>{ try{ ai.scrollIntoView({block:'center', behavior:'smooth'}); }catch{} });
      }

    }

    showHint(){
      const R = this.state.runtime;
      if(!R.currentWord) return;
      const correct=this.normalizeEng(R.currentWord.eng);
      const masked=correct.split('').map((ch,i)=> (i===0?ch:'_')).join(' ');
      const hint=this.$('hintArea');
      hint.style.display='block';
      hint.innerHTML=`íŒíŠ¸: <span style="font-size:1.08rem;">${masked}</span>
        <small>ì²« ê¸€ì '${correct[0]}' Â· ê¸€ì ìˆ˜ ${correct.length} (íŒíŠ¸ ì‚¬ìš© ì‹œ EXP ê°ì†Œ)</small>`;
    }

    upsertWrong(word){
      const D = this.state.data;
      const eng=this.normalizeEng(word.eng);
      const now=Date.now();
      if(D.masterWords.some(w=>this.normalizeEng(w.eng)===eng)) return;

      const idx=D.wrongWords.findIndex(w=>this.normalizeEng(w.eng)===eng);
      if(idx===-1){
        D.wrongWords.push({kan:word.kan, eng, wrongCount:1, lastWrong:now});
      }else{
        D.wrongWords[idx].wrongCount=(D.wrongWords[idx].wrongCount||1)+1;
        D.wrongWords[idx].lastWrong=now;
        D.wrongWords[idx].kan=word.kan;
      }
      this.saveKey('myVocaWrongWords', D.wrongWords);
      this.checkMainButtons();
      try{ this.updateHUD && this.updateHUD(); }catch{}
    }

    handleCheck(){
      const D = this.state.data;
      const R = this.state.runtime;
      if(!R.currentWord) return;

      const input=this.normalizeEng(this.$('answerInput').value);
      const correct=this.normalizeEng(R.currentWord.eng);
      const feedback=this.$('feedback');

      R.attempts++;

      let isCorrect=(input===correct);
      let isNear=false;
      if(!isCorrect && D.settings.typoHelp && input.length>0){
        const dist=this.levenshtein(input, correct);
        if(dist===1 && Math.max(input.length, correct.length)>=4) isNear=true;
      }

      const usedHint = (this.$('hintArea').style.display !== 'none');

      if(isCorrect || isNear){
        R.correctCount++;
        try{ updateMission && updateMission('study_count', 1); }catch{}
        R.combo++;

        // í•™ë…„ë³„ ìë™ìƒìŠ¹: 10ê°œ ì •ë‹µë§ˆë‹¤ cap +1 (ìµœëŒ€ 5) + ë‹¨ì–´ ì„ê¸°
        if(R.grade?.enabled){
          const e=this.normalizeEng(R.currentWord.eng);
          if(e) R.grade.seenEng.add(e);
          if(R.grade.mode==='auto' && (R.correctCount % 10 === 0) && R.grade.cap < 5){
            R.grade.cap += 1;
            this.toast(`â¬†ï¸ ë‚œì´ë„ ìƒìŠ¹! (ìƒí•œ Lv${R.grade.cap})`);
            this.mixInHarderGradeWords();
          }
        }

        let earnedExp = 20 + (R.combo*5);
        if(usedHint) earnedExp = Math.floor(earnedExp*0.3);
        if(isNear) earnedExp = Math.floor(earnedExp*0.7);

        D.playerExp += earnedExp;
        const coin = (isNear ? 1 : 2) * (R.isBossMode ? 5 : 1);
        this.addCoin(coin);
        if(R.isBossMode) this.bossAttack(100 + (R.combo * 10));
        try{ this.updateHUD && this.updateHUD(); }catch{}

        R.score++;

        this.recordGrassOneWord();

        if(D.playerExp >= 100){
          D.playerLevel++;
          D.playerExp -= 100;
          this.playSound('levelup');
          this.showParticles('ğŸŒŸ');
        }else{
          this.playSound('correct');
          this.showParticles(isNear ? 'ğŸŸ¡' : 'âœ¨');
        }

        this.saveKey('myVocaLevel', D.playerLevel);
        this.saveKey('myVocaExp', D.playerExp);

        this.updateGameUI();
        this.updateStatsUI();

        // âœ… TTSê°€ ë„ˆë¬´ ë¹¨ë¦¬ ëŠê¸°ëŠ” ë¬¸ì œ: ë°œìŒì´ ëë‚œ ë’¤ ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ë„ë¡ ì¡°ì •
        let _autoNextPlanned = false;
        const _goNext = ()=>{ if(_autoNextPlanned) return; _autoNextPlanned = true; this.nextQuestion(); };
        if(R.isMuted){
          setTimeout(_goNext, 450);
        }else{
          this.speakWord(correct, (D.settings.ttsRateCorrect||1.0), ()=>setTimeout(_goNext, (D.settings.postTTSDelay||180)));
          // (ëª¨ë°”ì¼ì—ì„œ onend ëˆ„ë½ ëŒ€ë¹„) ì•ˆì „ì¥ì¹˜
          setTimeout(_goNext, 2200);
        }

        if(isNear){
          // âœ… ìš”ì²­ ë°˜ì˜: ì˜¤íƒ€ ì •ë‹µ ì‹œê°ì  í”¼ë“œë°± ê°•í™”
          const banner=this.$('nearBanner');
          banner.style.display='block';
          banner.innerText = "âš ï¸ ì˜¤íƒ€ê°€ ìˆì§€ë§Œ ì •ë‹µìœ¼ë¡œ ì¸ì •ë©ë‹ˆë‹¤!";
          feedback.innerHTML = `ê±°ì˜ ì •ë‹µ! âœ… (+${earnedExp} EXP)`;
          feedback.className='near';
        }else{
          feedback.innerHTML = `ì •ë‹µì…ë‹ˆë‹¤! (+${earnedExp} EXP) âœ¨`;
          feedback.className='correct';
        }
        // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°(ìˆœì„œ ì§„í–‰)
        R.currentList.shift();

        this.updateGoal7Badge();
        this.renderHomeMini();


      }else{
        R.combo=0;
        this.updateGameUI();
        this.updateStatsUI();
        this.playSound('wrong');

        // âœ… ì˜¤ë‹µ ì‹œì—ë„ ë°œìŒì´ ëë‚œ ë’¤ ë‹¤ìŒ ë¬¸ì œë¡œ(ë„ˆë¬´ ë¹¨ë¦¬ ë„˜ì–´ê°€ë©´ ë°œìŒì´ ëŠê¹€)
        let _autoNextPlanned2 = false;
        const _goNext2 = ()=>{ if(_autoNextPlanned2) return; _autoNextPlanned2 = true; this.nextQuestion(); };
        if(R.isMuted){
          setTimeout(_goNext2, 900);
        }else{
          this.speakWord(correct, (D.settings.ttsRateWrong||0.85), ()=>setTimeout(_goNext2, (D.settings.postTTSDelay||180)));
          setTimeout(_goNext2, 2600);
        }
        if(R.isBossMode) {
          R.timeLeft = Math.max(0, R.timeLeft - 5);
          this.toast('ë³´ìŠ¤ ê³µê²©! ì‹œê°„ -5ì´ˆ ğŸ˜±');
        }


        this.$('quiz-screen').classList.add('shake-animation');
        setTimeout(()=>this.$('quiz-screen').classList.remove('shake-animation'), 400);

        feedback.innerHTML = `í‹€ë ¸ì–´ìš”! ì •ë‹µì€ <b>${correct}</b>`;
        feedback.className='wrong';

        this.upsertWrong(R.currentWord);

        // ğŸ” ì˜¤ë‹µ ì¬ì¶œì œ(ê°„ê²© ë°˜ë³µ): ëª‡ ë¬¸ì œ ë’¤ì— ë‹¤ì‹œ í•œ ë²ˆ ë”
        const key = this.normalizeEng(R.currentWord.eng);
        R.requeueMap = R.requeueMap || {};
        const cnt = (R.requeueMap[key] || 0);
        const max = (D.settings.requeueMax || 2);
        const offset = Math.max(2, parseInt(D.settings.requeueOffset || 4));
        if(key && cnt < max){
          R.requeueMap[key] = cnt + 1;
          // í˜„ì¬ ë¬¸ì œë¥¼ ë’¤ë¡œ ë³´ë‚´ê³ , offset ìœ„ì¹˜ì— ë‹¤ì‹œ ì‚½ì…
          const w = R.currentList.shift();
          const idx = Math.min(R.currentList.length, offset);
          R.currentList.splice(idx, 0, w);
        } else {
          // ë„ˆë¬´ ë§ì´ í‹€ë¦° ë‹¨ì–´ëŠ” ì¼ë‹¨ ë„˜ì–´ê°€ê¸°
          R.currentList.shift();
        }

      }
    }

    toggleMute(){
      const R = this.state.runtime;
      R.isMuted=!R.isMuted;
      this.updateGameUI();
      if(R.isMuted) window.speechSynthesis.cancel();
    }

    toggleSfx(){
      const D = this.state.data;
      D.settings.sfx=!D.settings.sfx;
      this.saveKey('myVocaSettings', D.settings);
      this.updateGameUI();
    }

    /* ---------- Result + Logging ---------- */
    logSession(mode, score, attempts, accuracy, wpm){
      const D = this.state.data;
      const ts=Date.now();
      D.progress.history.unshift({ts, mode, score, attempts, accuracy, wpm});
      const ds=this.dateStrOf(new Date());
      D.progress.daily[ds]=D.progress.daily[ds] || {correct:0, attempts:0, timeAttackBest:0};
      D.progress.daily[ds].correct += score;
      D.progress.daily[ds].attempts += attempts;
      if(mode==='time') D.progress.daily[ds].timeAttackBest = Math.max(D.progress.daily[ds].timeAttackBest||0, score);
      this.saveKey('myVocaProgress', D.progress);
    }

    showResult(){
      const D = this.state.data;
      const R = this.state.runtime;

      clearInterval(R.timerInterval);
      document.body.classList.remove('fever');

      this.$('quiz-screen').classList.add('hidden');
      this.$('result-screen').classList.remove('hidden');
      this.$('final-score').innerText = `ìµœì¢… ì ìˆ˜: ${R.score}ì `;

      const acc = R.attempts===0 ? 0 : Math.round((R.correctCount/R.attempts)*100);
      try{ if(acc>=90) updateMission && updateMission('high_acc', 1); }catch{}
      const wpm = R.isTimeMode ? Math.round((R.score / Math.max(1, Math.round((Date.now()-R.timeModeStart)/1000))) * 60) : 0;
      this.logSession(R.isTimeMode ? 'time' : 'normal', R.score, R.attempts, acc, wpm);

      this.renderWrongList();
      this.renderMasterList();

      if(R.isTimeMode){
        const elapsedSec = Math.max(1, Math.round((Date.now()-R.timeModeStart)/1000));
        const wpm2 = Math.round((R.score/elapsedSec)*60);

        this.$('time-extra').classList.remove('hidden');
        this.$('time-stats').innerHTML =
          `- ì´ ì‹œë„: ${R.attempts}íšŒ<br/>- ì •ë‹µ: ${R.correctCount}íšŒ<br/>- ì •í™•ë„: ${acc}%<br/>- ë¶„ë‹¹ ì •ë‹µ: ${wpm2}ê°œ/ë¶„`;

        let isBest=false;
        if(R.score > (D.bestTimeAttack.bestScore||0)){
          D.bestTimeAttack.bestScore=R.score;
          D.bestTimeAttack.bestAccuracy=acc;
          D.bestTimeAttack.bestWpm=wpm2;
          isBest=true;
        }
        this.saveKey('myVocaBestTimeAttack', D.bestTimeAttack);

        if(R.score >= 15) this.unlockBadge('time_15');
        if(isBest) this.unlockBadge('time_best');

        this.$('best-badge').innerHTML = isBest
          ? `ğŸ‰ <span style="color:var(--danger);">ìµœê³  ê¸°ë¡ ê°±ì‹ !</span>`
          : `ìµœê³  ê¸°ë¡: ${D.bestTimeAttack.bestScore}ì  (ì •í™•ë„ ${D.bestTimeAttack.bestAccuracy}% Â· ${D.bestTimeAttack.bestWpm}ê°œ/ë¶„)`;
      }else{
        this.$('time-extra').classList.add('hidden');
      }

      if(D.masterWords.length >= 10) this.unlockBadge('master_10');

      this.renderHomeMini();
    }

    renderWrongList(){
      const D = this.state.data;
      const ul=this.$('wrong-items');
      ul.innerHTML='';
      if(D.wrongWords.length===0){
        ul.innerHTML="<li style='justify-content:center; padding:14px;'>ëˆ„ì  ì˜¤ë‹µì´ ì—†ì–´ìš”! ğŸ†</li>";
        return;
      }
      const sorted=[...D.wrongWords].sort((a,b)=>(b.wrongCount||1)-(a.wrongCount||1));
      sorted.forEach(w=>{
        const li=document.createElement('li');
        li.innerHTML=`
          <span><b>${w.kan}</b> : ${w.eng} <span style="opacity:.7; font-weight:900;">(ì˜¤ë‹µ ${w.wrongCount||1}íšŒ)</span></span>
          <div style="display:flex; gap:8px;">
            <button class="mini-btn btn-primary" onclick="window.__voca.moveToMaster('${w.eng}')">ìˆ™ë ¨ ğŸ†</button>
            <button class="mini-btn btn-danger" onclick="window.__voca.removeWrongWord('${w.eng}')">ì‚­ì œ</button>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    renderMasterList(){
      const D = this.state.data;
      const ul=this.$('master-items');
      ul.innerHTML='';
      if(D.masterWords.length===0){
        ul.innerHTML="<li style='justify-content:center; padding:14px;'>ì•„ì§ ìˆ™ë ¨ ë‹¨ì–´ê°€ ì—†ì–´ìš”.</li>";
        return;
      }
      D.masterWords.forEach(w=>{
        const li=document.createElement('li');
        li.innerHTML=`
          <span><b>${w.kan}</b> : ${w.eng}</span>
          <button class="mini-btn btn-gray" onclick="window.__voca.removeMaster('${w.eng}')">ì œê±°</button>
        `;
        ul.appendChild(li);
      });
    }

    removeWrongWord(eng){
      const D = this.state.data;
      const e=this.normalizeEng(eng);
      D.wrongWords=D.wrongWords.filter(w=>this.normalizeEng(w.eng)!==e);
      this.saveKey('myVocaWrongWords', D.wrongWords);
      this.renderWrongList();
      this.checkMainButtons();
    }

    moveToMaster(eng){
      const D = this.state.data;
      const e=this.normalizeEng(eng);
      const w=D.wrongWords.find(x=>this.normalizeEng(x.eng)===e);
      if(!w) return;
      if(!D.masterWords.some(x=>this.normalizeEng(x.eng)===e)){
        D.masterWords.push({kan:w.kan, eng:e, masteredAt:Date.now()});
        this.saveKey('myVocaMasterWords', D.masterWords);
        this.showParticles('ğŸ†');
      }
      D.wrongWords=D.wrongWords.filter(x=>this.normalizeEng(x.eng)!==e);
      this.saveKey('myVocaWrongWords', D.wrongWords);

      if(D.masterWords.length>=10) this.unlockBadge('master_10');

      this.renderWrongList();
      this.renderMasterList();
      this.checkMainButtons();
    }

    removeMaster(eng){
      const D = this.state.data;
      const e=this.normalizeEng(eng);
      D.masterWords=D.masterWords.filter(w=>this.normalizeEng(w.eng)!==e);
      this.saveKey('myVocaMasterWords', D.masterWords);
      this.renderMasterList();
    }

    /* ---------- Best + CSV ---------- */
    renderBest(){
      const D = this.state.data;
      this.$('best-time-score').innerText = `${D.bestTimeAttack.bestScore||0}ì `;
      this.$('bestScoreVal').innerText = D.bestTimeAttack.bestScore||0;
      this.$('bestAccVal').innerText = D.bestTimeAttack.bestAccuracy||0;
      this.$('bestWpmVal').innerText = D.bestTimeAttack.bestWpm||0;
    }

    resetBest(){
      const D = this.state.data;
      D.bestTimeAttack={bestScore:0,bestWpm:0,bestAccuracy:0};
      this.saveKey('myVocaBestTimeAttack', D.bestTimeAttack);
      this.renderBest();
      alert('ìµœê³  ê¸°ë¡ì„ ì´ˆê¸°í™”í–ˆì–´ìš”!');
    }

    exportCSV(){
      const D = this.state.data;
      const rows=[["date","correct","attempts","accuracy","timeAttackBest"]];
      const keys=Object.keys(D.progress.daily).sort();
      for(const k of keys){
        const d=D.progress.daily[k];
        const acc = d.attempts ? Math.round((d.correct/d.attempts)*100) : 0;
        rows.push([k, d.correct||0, d.attempts||0, acc, d.timeAttackBest||0]);
      }
      const csv=rows.map(r=>r.join(",")).join("\n");
      const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download="voca_progress.csv";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      this.toast("CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘!");
    }

    /* ---------- Admin (í•™ìƒì´ ì§ì ‘ ê´€ë¦¬) ---------- */
    openAdmin(){
      this.$('setup-screen').classList.add('hidden');
      this.$('admin-screen').classList.remove('hidden');
      this.renderSetList();
    }

    closeAdmin(){
      this.$('admin-screen').classList.add('hidden');
      this.$('setup-screen').classList.remove('hidden');
      this.renderHomeMini();
    }

    clearSetForm(){
      this.$('setName').value='';
      this.$('setBulk').value='';
    }

    parseSetBulk(text){
      const lines=(text||'').split('\n');
      const words=[];
      for(const line of lines){
        const item=this.parseBulkLine(line);
        if(item && !words.some(w=>this.normalizeEng(w.eng)===this.normalizeEng(item.eng))){
          words.push({kan:String(item.kan).trim(), eng:this.normalizeEng(item.eng)});
        }
      }
      return words;
    }

    saveSet(){
      const D = this.state.data;
      const name=this.$('setName').value.trim();
      const bulk=this.$('setBulk').value;
      if(!name) return alert('ì„¸íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      const words=this.parseSetBulk(bulk);
      if(words.length===0) return alert('ë‹¨ì–´ê°€ 1ê°œ ì´ìƒ í•„ìš”í•´ìš”.');

      const set={ id:'set_'+Date.now(), name, createdAt:Date.now(), words };
      D.sets.unshift(set);
      this.saveKey('myVocaSets', D.sets);
      this.renderSetList();
      this.clearSetForm();
      this.toast(`ì„¸íŠ¸ ì €ì¥ ì™„ë£Œ! (${words.length}ê°œ)`);
    }

    renderSetList(){
      const D = this.state.data;
      const ul=this.$('setList');
      ul.innerHTML='';
      if(D.sets.length===0){
        ul.innerHTML="<li style='justify-content:center; padding:14px;'>ì €ì¥ëœ ì„¸íŠ¸ê°€ ì—†ì–´ìš”.</li>";
        return;
      }
      D.sets.forEach(s=>{
        const li=document.createElement('li');
        li.innerHTML=`
          <span>
            <b>${s.name}</b>
            <div class="mini" style="margin-top:4px;">${(s.words||[]).length}ê°œ</div>
          </span>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="mini-btn btn-primary" onclick="window.__voca.applySet('${s.id}')">ì ìš©</button>
            <button class="mini-btn btn-dark" onclick="window.__voca.selectSet('${s.id}')">ë‚´ë³´ë‚´ê¸°</button>
            <button class="mini-btn btn-danger" onclick="window.__voca.deleteSet('${s.id}')">ì‚­ì œ</button>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    selectSet(id){
      const D = this.state.data;
      const s=D.sets.find(x=>x.id===id);
      if(!s) return;
      const payload={ type:"vocaSet", name:s.name, words:s.words, exportedAt:new Date().toISOString() };
      this.$('adminExport').value=JSON.stringify(payload);
      this.toast("ë‚´ë³´ë‚´ê¸° JSON ìƒì„±!");
    }

    deleteSet(id){
      const D = this.state.data;
      D.sets=D.sets.filter(x=>x.id!==id);
      this.saveKey('myVocaSets', D.sets);
      this.renderSetList();
      this.toast("ì„¸íŠ¸ë¥¼ ì‚­ì œí–ˆì–´ìš”.");
    }

    applySet(id){
      const D = this.state.data;
      const s=D.sets.find(x=>x.id===id);
      if(!s) return;
      const before = D.customWords.length;
      const addList = Array.isArray(s.words) ? s.words : [];
      for(const w of addList){
        if(!w?.kan || !w?.eng) continue;
        const eng=this.normalizeEng(w.eng);
        if(D.customWords.some(x=>this.normalizeEng(x.eng)===eng)) continue;
        D.customWords.push({ kan:String(w.kan).trim(), eng });
      }
      const added = D.customWords.length - before;
      this.saveKey('myVocaCustom', D.customWords);
      this.checkMainButtons();
      this.toast(`ì„¸íŠ¸ ì ìš©: ${added}ê°œ ì¶”ê°€ë¨`);
    }

    async copyAdminExport(){
      const val=this.$('adminExport').value.trim();
      if(!val) return alert('ë¨¼ì € ì„¸íŠ¸ë¥¼ â€œë‚´ë³´ë‚´ê¸°â€ë¡œ ì„ íƒí•´ JSONì„ ìƒì„±í•˜ì„¸ìš”.');
      try{ await navigator.clipboard.writeText(val); this.toast('JSON ë³µì‚¬ ì™„ë£Œ!'); }
      catch{ alert('ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ). ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.'); }
    }

    importSetJSON(){
      const D = this.state.data;
      const val=this.$('adminImport').value.trim();
      if(!val) return alert('ê°€ì ¸ì˜¬ ì„¸íŠ¸ JSONì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.');
      try{
        const obj=JSON.parse(val);
        if(obj.type !== 'vocaSet') return alert('ì„¸íŠ¸ JSON í˜•ì‹ì´ ì•„ë‹ˆì—ìš”.');
        const name = String(obj.name||'ê°€ì ¸ì˜¨ ì„¸íŠ¸').trim();
        const words = Array.isArray(obj.words) ? obj.words : [];
        const cleaned = [];
        for(const w of words){
          if(!w?.kan || !w?.eng) continue;
          const eng=this.normalizeEng(w.eng);
          if(cleaned.some(x=>this.normalizeEng(x.eng)===eng)) continue;
          cleaned.push({ kan:String(w.kan).trim(), eng });
        }
        if(cleaned.length===0) return alert('ì„¸íŠ¸ì— ë‹¨ì–´ê°€ ì—†ì–´ìš”.');
        const set={ id:'set_'+Date.now(), name, createdAt:Date.now(), words:cleaned };
        D.sets.unshift(set);
        this.saveKey('myVocaSets', D.sets);
        this.renderSetList();
        this.toast(`ì„¸íŠ¸ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! (${cleaned.length}ê°œ)`);
      }catch{
        alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.');
      }
    }

    /* ---------- Init ---------- */
    init(){
      this.loadAll();
      this.initSettingsUI();
      this.renderBest();
      this.renderHomeMini();
      this.renderGrass();
      this.renderBadges();

      // iOS ì…ë ¥ ì•ˆì •í™”(ìë™ ëŒ€ë¬¸ì/ìë™ ìˆ˜ì • ìµœì†Œí™”)
      document.querySelectorAll('input,textarea,select').forEach((el)=>{
        el.setAttribute('autocapitalize','none');
        el.setAttribute('autocorrect','off');
        el.setAttribute('spellcheck','false');
      });

      // ì—”í„° ì œì¶œ
      this.$('answerInput').addEventListener('keydown',(e)=>{
        if(e.key==='Enter') this.handleCheck();
      });

      // ì²« ì‹¤í–‰ ì•ˆë‚´(ë°ì´í„° ë³µêµ¬ ì•Œë¦¼ê³¼ ë¶„ë¦¬)
      this.toast("ì¤€ë¹„ ì™„ë£Œ! ì˜¤ëŠ˜ ëª©í‘œë¶€í„° ê°€ë³¼ê¹Œìš”? ğŸš€");
    }
  }

  // ì•± ì¸ìŠ¤í„´ìŠ¤ ìƒì„± + ì „ì—­ ì ‘ê·¼ ìµœì†Œí™”(ë”± 1ê°œë§Œ)
  window.__voca = new VocaApp();
  window.__voca.init();

  // UI Skin: Cute (Aí˜•) default
  try{
    const skin = localStorage.getItem('voca_ui_skin') || 'cute';
    document.body.classList.toggle('ui-cute', skin === 'cute');
  }catch{}

  // HUD updater (streak / today / goal / boss)
  try{
    const updateHUD = ()=>{
      const D = window.__voca.state.data;
      const streakDays = (typeof window.__voca.calculateStreak === 'function') ? window.__voca.calculateStreak() : Number(D.streakDays||0);
      const todayCount = (typeof window.__voca.calculateTodayCount === 'function') ? window.__voca.calculateTodayCount() : Number(D.todayLearned||0);
      const goal = Number(D.settings?.dailyGoal||10);

      const s1=document.getElementById('hud-streak'); if(s1) s1.querySelector('span').textContent = `ì—°ì† ${streakDays}ì¼`;
      const s2=document.getElementById('hud-today'); if(s2) s2.querySelector('span').textContent = `ì˜¤ëŠ˜ ${todayCount}ë‹¨ì–´`;
      const s3=document.getElementById('hud-goal'); if(s3) s3.querySelector('span').textContent = `ëª©í‘œ ${goal}`;

      // Pick boss: most wrong word in log (top 1)
      const wrong = Array.isArray(D.wrongWords) ? D.wrongWords : [];
      let top = null;
      for(const w of wrong){
        const c = Number(w.wrongCount||1);
        if(!top || c > top.c) top = {eng:String(w.eng||''), kan:String(w.kan||''), c};
      }
      const nameEl=document.getElementById('boss-name');
      const subEl=document.getElementById('boss-sub');
      const hpEl=document.getElementById('hud-boss-hp-text');
      const barEl=document.getElementById('boss-hp-bar');

      if(top && top.eng){
        const label = top.kan ? `${top.kan} (${top.eng})` : top.eng;
        if(nameEl) nameEl.textContent = `ğŸ» ì˜¤ëŠ˜ì˜ ì•½ì  ë³´ìŠ¤: ${label}`;
        if(subEl) subEl.textContent = `ê°€ì¥ ë§ì´ í‹€ë¦° ë‹¨ì–´ë¥¼ ì¡ì•„ë³´ì! (ëˆ„ì  ì˜¤ë‹µ ${top.c}íšŒ)`;
        if(hpEl) hpEl.textContent = `â¤ï¸ HP ${top.c}`;
        // HP bar: cap at 30 for display
        const pct = Math.max(6, Math.min(100, (top.c/30)*100));
        if(barEl) barEl.style.width = pct + '%';
      }else{
        if(nameEl) nameEl.textContent = 'ğŸ» ì˜¤ëŠ˜ì˜ ì•½ì  ë³´ìŠ¤: ì—†ìŒ';
        if(subEl) subEl.textContent = 'ì˜¤ë‹µì´ ìŒ“ì´ë©´ ë³´ìŠ¤ê°€ ë‚˜íƒ€ë‚˜ìš”!';
        if(hpEl) hpEl.textContent = 'â¤ï¸ HP 0';
        if(barEl) barEl.style.width = '0%';
      }
    };
    window.__voca.updateHUD = updateHUD;
    updateHUD();
  }catch{}

})()
</script>
<div id="print-area"></div>
  <script>
    const manifestData={name:"VOCA ë§ˆìŠ¤í„° PRO V3 GodMode",short_name:"VOCA PRO",start_url:"./",display:"standalone",background_color:"#f0f2f5",theme_color:"#3498db",icons:[{src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%233498db' width='100' height='100'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3EğŸ§%3C/text%3E%3C/svg%3E",sizes:"512x512",type:"image/svg+xml"}]};
    const b=new Blob([JSON.stringify(manifestData)],{type:'application/json'});
    document.getElementById('manifest-placeholder').setAttribute('href',URL.createObjectURL(b));

    if('serviceWorker' in navigator){
      const sw=`const C='voca-v2-cache';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['./'])));self.skipWaiting()});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{return caches.open(C).then(c=>{if(e.request.method==='GET')c.put(e.request,res.clone());return res})}).catch(()=>caches.match('./'))))});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(k=>Promise.all(k.map(n=>n!==C&&caches.delete(n)))));return self.clients.claim()});`;
      navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'})));
    }
    // Init Speed UI on load
    window.addEventListener('load', ()=>{ try{ window.__voca.updateSpeedUI(); }catch{} });
  

</script>


<!-- v10 Modals -->
<div id="analysisModal" class="modal-v10">
    <div class="modal-content-v10">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>ğŸ“Š í•™ìŠµ ë°ì´í„° ë¶„ì„</h2>
            <button class="modal-close" onclick="closeModal(\'analysisModal\')" aria-label="ë‹«ê¸°">âœ–</button>
        </div>

        <h3>1ï¸âƒ£ í’ˆì‚¬ë³„ ì·¨ì•½ì  (ì˜¤ë‹µ ë¹„ìœ¨)</h3>
        <div class="chart-container">
            <canvas id="weaknessChart"></canvas>
        </div>
        <p style="font-size:0.9rem; color:#666; text-align:center;">* ì˜¤ë‹µ ë°ì´í„°ê°€ ìŒ“ì´ë©´ ë¶„ì„ì´ ì •í™•í•´ì§‘ë‹ˆë‹¤.</p>

        <h3 style="margin-top:30px;">2ï¸âƒ£ í•™ìŠµ ì„±ì¥ ê³¡ì„  (ìµœê·¼ 7ì¼)</h3>
        <div class="chart-container">
            <canvas id="growthChart"></canvas>
        </div>
    </div>
</div>

<div id="missionModal" class="modal-v10">
    <div class="modal-content-v10">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>ğŸ¯ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ & ì—…ì </h2>
            <button class="modal-close" onclick="closeModal(\'missionModal\')" aria-label="ë‹«ê¸°">âœ–</button>
        </div>

        <div id="dailyMissions">
            <!-- JS will populate this -->
        </div>

        <h3 style="margin-top:22px;">ğŸ’ ìµœê·¼ 7ì¼ ë¯¸ì…˜ ë³´ìƒ</h3>
        <div class="chart-container">
            <canvas id="rewardChart"></canvas>
        </div>

        <h3 style="margin-top:30px;">ğŸ† ë‚˜ì˜ ì—…ì </h3>
        <div id="achievementsList" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:10px;">
            <!-- Badges -->
        </div>
    </div>
</div>


    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showHome()">
            <span class="nav-icon">ğŸ </span>í™ˆ
        </div>
        <div class="nav-item" onclick="showMissions()">
            <span class="nav-icon">ğŸ¯</span>ë¯¸ì…˜
        </div>
        <div class="nav-item" onclick="openSettings()">
            <span class="nav-icon">âš™ï¸</span>ì„¤ì •
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal">
        <div class="admin-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ</h2>
                <button onclick="closeAdmin()" style="padding:5px 10px;">ë‹«ê¸°</button>
            </div>
            <div id="admin-mount-point"></div>
        </div>
    </div>
</div>

<script>
    // --- Bridge Script to Connect New UI to Old Logic ---

    // 1. Sync Data from Hidden Logic Elements to New UI
    function syncDisplay() {
        try {
            document.getElementById('global-coin-new').innerText = document.getElementById('global-coin').innerText;
            document.getElementById('home-level-text-new').innerText = document.getElementById('home-level-text').innerText.replace(/[^0-9]/g, 'Lv. ');
            document.getElementById('home-exp-text-new').innerText = document.getElementById('home-exp-text').innerText;

            // Sync Bar Width
            const oldBar = document.getElementById('home-exp-bar');
            const newBar = document.getElementById('home-exp-bar-new');
            if(oldBar && newBar) newBar.style.width = oldBar.style.width;
        } catch(e) {}
    }

    setInterval(syncDisplay, 500); // Continuous Sync

    // 2. Button Mappings
    function startDailyAdventure() {
        // Trigger the original "Start Learning" or "Daily Goal"
        // Assuming window.voca.initQuiz exists or similar
        // Let's try to find the "Start" button in original UI and click it
        // Or directly call the function if known.
        // Based on analysis: window.voca.initQuiz('random') or similar.
        // Let's use the 'Learn' tab.

        // Show the quiz screen (managed by original JS)
        // We need to make sure the quiz screen is visible within our app container
        // Original logic toggles 'hidden' class on screens.
        // We need to style those screens to appear correctly.

        // Force trigger random quiz for adventure
        if(window.voca && window.voca.initQuiz) {
             window.voca.initQuiz('random');
             // Hide main view, show quiz view (managed by original JS mostly, but we might need to help)
             document.getElementById('main-view').style.display = 'none';
             document.getElementById('quiz-screen').classList.remove('hidden');
             // Append quiz screen to main view area if needed? No, original JS handles display:block/none
             // We just need to ensure #quiz-screen is styled to overlay or replace #main-view
        }
    }

    function openReviewNote() {
        if(window.voca && window.voca.switchTab) {
            window.voca.switchTab('record');
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('panel-record').classList.remove('hidden');
            // Move panel-record to visible area if it's inside hidden container
            const panel = document.getElementById('panel-record');
            document.getElementById('app-container').appendChild(panel);
        }
    }

    function showHome() {
        document.getElementById('main-view').style.display = 'block';
        // Hide other screens
        const screens = ['quiz-screen', 'panel-record', 'panel-shop', 'panel-settings'];
        screens.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('hidden');
                // If we moved them, move them back? No need, just hide.
            }
        });
    }

    // 3. Admin & Secret Logic
    let secretCount = 0;
    function secretAdminOpen() {
        secretCount++;
        if(secretCount >= 5) {
            document.getElementById('admin-modal').style.display = 'block';
            // Move admin controls here if needed
            // For now, let's just show the hidden container's admin parts?
            // Actually, let's just show the 'admin-screen' if it exists
            if(document.getElementById('admin-screen')) {
                document.getElementById('admin-screen').classList.remove('hidden');
                document.getElementById('admin-mount-point').appendChild(document.getElementById('admin-screen'));
            }
            secretCount = 0;
        }
    }

    function closeAdmin() {
        document.getElementById('admin-modal').style.display = 'none';
    }

</script>

<button class="app-shell-btn" id="menuBtn" aria-label="ë©”ë‰´ ì—´ê¸°" type="button">â˜°</button>
<div class="app-drawer" id="appDrawer" aria-hidden="true">
  <div class="drawer-panel" role="dialog" aria-label="ë©”ë‰´">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div>
        <div class="drawer-title">ğŸ² VOCA ë§ˆìŠ¤í„°</div>
        <div class="drawer-sub">ì›í•˜ëŠ” ê±¸ ê³¨ë¼ì„œ í•˜ì!</div>
      </div>
      <button class="modal-close" type="button" id="drawerClose" aria-label="ë‹«ê¸°">âœ–</button>
    </div>

    <div class="drawer-list">
      <button class="drawer-item" type="button" onclick="window.__voca.switchTab('learn'); window.__closeDrawer();">ğŸ  í™ˆ <small>ëª¨í—˜ ì‹œì‘</small></button>
      <button class="drawer-item" type="button" onclick="window.__voca.switchTab('record'); window.__closeDrawer();">ğŸ“’ ê¸°ë¡ <small>ì”ë””/ë°°ì§€</small></button>
      <button class="drawer-item" type="button" onclick="openAnalysis(); window.__closeDrawer();">ğŸ’ ì•½ì  ê³µëµ <small>ë‚´ê°€ ìì£¼ í‹€ë¦° ê²ƒ</small></button>
      <button class="drawer-item" type="button" onclick="openMission(); window.__closeDrawer();">ğŸ¯ ë¯¸ì…˜ & ë³´ìƒ <small>ì˜¤ëŠ˜ ëª©í‘œ</small></button>
      <button class="drawer-item" type="button" onclick="window.__voca.switchTab('shop'); window.__closeDrawer();">ğŸ›’ ë³´ë¬¼ ìƒì  <small>ìŠ¤í‚¨/ì•„ì´í…œ</small></button>
      <button class="drawer-item" type="button" onclick="window.__voca.switchTab('settings'); window.__closeDrawer();">âš™ï¸ ì„¤ì • <small>ëª©í‘œ/ì†Œë¦¬</small></button>
    </div>

    <div class="drawer-bottom">
      <button class="btn btn-outline" type="button" onclick="toggleTheme();">ğŸŒ™/â˜€ï¸</button>
      <button class="btn btn-dark" type="button" onclick="window.__voca.openAdmin();">ê´€ë¦¬ì</button>
    </div>
  </div>
</div>

<script>
(function(){
  const drawer = document.getElementById('appDrawer');
  const btn = document.getElementById('menuBtn');
  const closeBtn = document.getElementById('drawerClose');

  function open(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
  function close(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }

  window.__closeDrawer = close;

  btn && btn.addEventListener('click', (e)=>{ e.preventDefault(); open(); });
  closeBtn && closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); close(); });
  drawer && drawer.addEventListener('click', (e)=>{ if(e.target === drawer) close(); });

  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();
</script>


<script>
/* ===== v6 Logic FIXES: bottom nav wiring + robust modals ===== */
(function(){
  // Safe helper: add/remove active class on bottom nav
  function setActiveNav(key){
    const items = document.querySelectorAll('.bottom-nav .nav-item');
    items.forEach(it=>it.classList.remove('active'));
    const map = { home:0, mission:1, settings:2 };
    const idx = map[key];
    if(typeof idx === 'number' && items[idx]) items[idx].classList.add('active');
  }

  // Make sure these exist globally (inline onclicks rely on them)
  window.showHome = window.showHome || function(){
    const main = document.getElementById('main-view');
    if(main) main.style.display = 'block';
    ['quiz-screen','panel-record','panel-shop','panel-settings'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.classList.add('hidden');
    });
    setActiveNav('home');
    try{ window.scrollTo({top:0, behavior:'smooth'});}catch(e){}
  };

  window.showMissions = window.showMissions || function(){
    // Prefer the existing openMission()
    if(typeof window.openMission === 'function'){
      window.openMission();
    } else if(typeof window.openModal === 'function'){
      window.openModal('missionModal');
    }
    setActiveNav('mission');
  };

  window.openSettings = window.openSettings || function(){
    // If there is a settings panel, show it; otherwise open admin/settings modal if exists.
    const ps = document.getElementById('panel-settings');
    const main = document.getElementById('main-view');
    if(main) main.style.display = 'block';
    ['quiz-screen','panel-record','panel-shop'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.classList.add('hidden');
    });
    if(ps){
      ps.classList.remove('hidden');
    } else if(typeof window.openModal === 'function' && document.getElementById('adminModal')){
      window.openModal('adminModal');
    }
    setActiveNav('settings');
    try{ window.scrollTo({top:0, behavior:'smooth'});}catch(e){}
  };

  // Add event listeners to bottom nav as a backup (in case inline onclick is blocked)
  document.addEventListener('DOMContentLoaded', ()=>{
    const nav = document.querySelector('.bottom-nav');
    if(nav){
      const items = nav.querySelectorAll('.nav-item');
      if(items[0]) items[0].addEventListener('click', (e)=>{ e.preventDefault(); window.showHome(); });
      if(items[1]) items[1].addEventListener('click', (e)=>{ e.preventDefault(); window.showMissions(); });
      if(items[2]) items[2].addEventListener('click', (e)=>{ e.preventDefault(); window.openSettings(); });
    }

    // Ultra-robust modal close: any click on .modal-close (even if nested) closes nearest modal
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.modal-close');
      if(!btn) return;
      e.preventDefault();
      e.stopPropagation();
      const modal = btn.closest('.modal');
      if(modal && typeof window.closeModal === 'function'){
        window.closeModal(modal.id);
      } else if(modal){
        modal.style.display='none';
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
      }
    }, true);
  });

})();
</script>

</body>
</html>

