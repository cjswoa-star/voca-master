<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>VOCA ë§ˆìŠ¤í„° PRO v5</title>
  <style>
    :root{
      --primary:#3498db; --success:#27ae60; --danger:#e74c3c; --warning:#f1c40f;
      --custom:#9b59b6; --review:#e67e22; --time:#e84393; --dark:#2c3e50;
      --bg:#f0f2f5;
      /* Safe-area (iOS notch/home bar) */
      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
    }
    body{
      font-family:'Malgun Gothic',sans-serif;
      background:var(--bg);
      display:flex; justify-content:center; align-items:center;
      min-height:100vh; min-height:100dvh;
      margin:0;
      overflow:auto;
      box-sizing:border-box;
      padding: calc(var(--sat) + 10px) calc(var(--sar) + 10px) calc(var(--sab) + 10px) calc(var(--sal) + 10px);
      transition:background-color .35s;
      -webkit-overflow-scrolling: touch;
    }
    body.fever{ background:#fff0c2; }
    .container{
      background:#fff; padding:16px; border-radius:18px;
      box-shadow:0 8px 24px rgba(0,0,0,.1);
      width:92%; max-width:520px; max-height:88vh; max-height:calc(100dvh - var(--sat) - var(--sab) - 24px); overflow-y:auto;
      border:2px solid transparent; transition:box-shadow .25s,border .25s;
    }
    .container.fever-glow{ box-shadow:0 0 30px rgba(241,196,15,.55); border-color:var(--warning); }
    .hidden{ display:none !important; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .title{ font-size:1.35rem; font-weight:900; margin:0; letter-spacing:-0.2px; }
    .subhint{ font-size:.85rem; color:#6b7b88; font-weight:800; margin:2px 0 0; }

    .tabs{
      display:flex; gap:8px; margin:10px 0 12px;
      background:#f3f6f9; padding:6px; border-radius:14px; border:1px solid #e8eef5;
    }
    .tab{
      flex:1; padding:10px 8px; border:none; border-radius:12px;
      font-weight:900; cursor:pointer; background:transparent; color:#2c3e50;
      transition:transform .1s, background .2s;
    }
    .tab:active{ transform:scale(.98); }
    .tab.active{ background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.06); }

    .game-stats{
      background:#e8f4f8; padding:12px; border-radius:14px;
      border:1px solid rgba(52,152,219,.18); margin:10px 0;
    }
    .level-row{ display:flex; justify-content:space-between; font-weight:900; align-items:center; margin-bottom:8px; }
    .exp-bar-bg{ width:100%; background:#d9e0e7; height:12px; border-radius:6px; overflow:hidden; }
    .exp-bar-fill{ height:100%; width:0%; background:var(--success); transition:width .35s ease-out; }

    .card{
      background:#f8fafc; border:1px solid #e9eef4; border-radius:14px;
      padding:12px; margin:10px 0; text-align:left;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; }
    .mini{ font-size:.85rem; color:#6b7b88; font-weight:800; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      background:#fff; border:1px solid #e9eef4; border-radius:999px;
      padding:6px 10px; font-size:.85rem; font-weight:900; color:#2c3e50; white-space:nowrap;
    }
    .pill.good{ border-color:rgba(39,174,96,.28); }
    .pill.warn{ border-color:rgba(241,196,15,.45); }
    .pill.danger{ border-color:rgba(231,76,60,.35); }

    button{
      border:none; border-radius:12px; padding:12px; cursor:pointer;
      font-weight:900; color:#fff; transition:transform .1s, filter .2s;
    }
    button:hover{ filter:brightness(1.06); }
    button:active{ transform:scale(.97); }
    .btn{ width:100%; box-sizing:border-box; }
    .btn-primary{ background:var(--primary); }
    .btn-dark{ background:var(--dark); }
    .btn-danger{ background:var(--danger); }
    .btn-warning{ background:var(--warning); color:#333; }
    .btn-review{ background:var(--review); }
    .btn-time{ background:var(--time); }
    .btn-custom{ background:var(--custom); }
    .btn-gray{ background:#7f8c8d; }

    .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    details{ background:#fff; border:1px solid #e9eef4; border-radius:14px; padding:10px 12px; margin:10px 0; }
    summary{
      list-style:none; cursor:pointer; font-weight:900; color:#2c3e50;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }
    summary .right{ color:#6b7b88; font-size:.85rem; font-weight:900; }

    .grass-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:10px; }
    .grass-box{
      width:100%; aspect-ratio:1; border-radius:4px; background:#ebedf0;
      position:relative; cursor:pointer; transition:transform .1s;
    }
    .grass-box:hover{ transform:scale(1.08); z-index:10; border:1px solid rgba(0,0,0,.08); }
    .grass-box:hover::after{
      content:attr(data-info);
      position:absolute; bottom:130%; left:50%; transform:translateX(-50%);
      background:#333; color:#fff; padding:4px 8px; border-radius:6px; font-size:.75rem; white-space:nowrap;
      pointer-events:none;
    }
    .grass-lvl-1{ background:#9be9a8; } .grass-lvl-2{ background:#40c463; }
    .grass-lvl-3{ background:#30a14e; } .grass-lvl-4{ background:#216e39; }

    .badge-wrap{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; border:1px solid #e9eef4; background:#fff;
      font-size:.85rem; font-weight:900; color:#2c3e50;
    }
    .badge.lock{ opacity:.45; filter:grayscale(1); }

    .stats{ display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; align-items:center; margin:10px 0; }
    .toggles{ display:flex; gap:10px; align-items:center; }
    #muteBtn,#sfxBtn{ background:none; color:inherit; padding:0; width:auto; font-size:1.45rem; }

    .card-container{
      perspective:1000px; margin:14px 0 10px; height:64px;
      display:flex; align-items:center; justify-content:center; position:relative;
    }
    #question{
      font-size:2.1rem; font-weight:900; color:#2c3e50;
      transition:transform .2s ease, opacity .2s ease;
      transform-style:preserve-3d;
    }
    .flip-out{ transform:rotateX(-90deg); opacity:0; }
    .flip-in{ transform:rotateX(0deg); opacity:1; }

    .btn-listen{
      position:absolute; right:6px; width:40px; height:40px; border-radius:50%;
      background:var(--primary); font-size:1.2rem;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 6px rgba(0,0,0,.16);
    }

    input, textarea, select{
      width:100%; padding:12px 14px; border:2px solid #ddd; border-radius:12px;
      /* iOS Safari ìë™ í™•ëŒ€(ì¤Œ) ë°©ì§€: 16px ì´ìƒ ìœ ì§€ */
      font-size:16px;
      line-height:1.2;
      outline:none; box-sizing:border-box;
      transition:border-color .2s, box-shadow .2s;
      -webkit-appearance:none;
      appearance:none;
    }
    input:focus, textarea:focus, select:focus{
      border-color:var(--primary); box-shadow:0 0 8px rgba(52,152,219,.22);
    }
    body.fever input:focus{ border-color:var(--warning); box-shadow:0 0 10px rgba(241,196,15,.45); }

    .button-group{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .btn-main{ grid-column:span 2; padding:14px; font-size:1.05rem; background:var(--primary); }
    .btn-hint{ background:var(--warning); color:#333; }
    .btn-exit{ background:var(--danger); }

    #hintArea{
      margin-top:10px; text-align:left;
      background:#fffbe6; border:1px solid rgba(241,196,15,.45);
      padding:10px 12px; border-radius:12px; font-weight:900; color:#7d6608; display:none;
    }
    #hintArea small{ display:block; font-weight:800; margin-top:4px; opacity:.85; }

    #feedback{ margin-top:10px; min-height:1.4rem; font-size:1.02rem; font-weight:900; }
    .correct{ color:var(--success); } .wrong{ color:var(--danger); } .near{ color:#f39c12; }

    /* â€œì˜¤íƒ€ ì •ë‹µâ€ì„ ë” ëª…í™•í•˜ê²Œ */
    .near-banner{
      margin-top:10px;
      background:#fff3e6;
      border:1px solid rgba(243,156,18,.35);
      color:#a85d00;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      display:none;
    }

    .list{
      list-style:none; padding:0; margin:8px 0 0;
      background:#f8f9fa; border:1px solid #eee; border-radius:12px;
      max-height:180px; overflow:auto;
    }
    .list li{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px; border-bottom:1px solid #e6e6e6;
    }
    .list li:last-child{ border-bottom:none; }
    .mini-btn{ padding:8px 10px; border-radius:10px; font-size:.85rem; width:auto; }

    @keyframes heartbeat{ 0%,100%{ transform:scale(1); color:var(--danger);} 50%{ transform:scale(1.12); color:#c0392b;} }
    .timer-text{ color:var(--danger); font-weight:900; }
    .timer-text.danger{ animation:heartbeat .5s infinite; }

    @keyframes shake{ 0%,100%{ transform:translateX(0);} 20%,60%{ transform:translateX(-10px);} 40%,80%{ transform:translateX(10px);} }
    .shake-animation{ animation:shake .4s ease-in-out; }
    @keyframes floatUp{ 0%{ opacity:1; transform:translateY(0) scale(1);} 100%{ opacity:0; transform:translateY(-150px) scale(1.5);} }
    .particle{ position:fixed; pointer-events:none; animation:floatUp 1.2s forwards; z-index:1000; }

    /* í† ìŠ¤íŠ¸ */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#2c3e50; color:#fff; padding:10px 12px; border-radius:12px;
      font-weight:900; font-size:.9rem;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
      opacity:0; pointer-events:none; transition:opacity .2s, transform .2s;
      z-index:2000;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }
  
    
    /* --- V3 God Mode CSS --- */
    :root {
      --primary: #3498db; --bg: #f0f2f5; --card-bg: #fff; --text: #2c3e50;
    }
    /* Theme definitions apply to body */
    body.theme-dark { --primary: #3498db; --bg: #1a1a1a; --card-bg: #2d2d2d; --text: #ecf0f1; color: #ecf0f1; }
    body.theme-pink { --primary: #ff6b81; --bg: #ffeaa7; --card-bg: #fff0f5; --text: #2d3436; color: #2d3436; }
    body.theme-cyber { --primary: #00cec9; --bg: #000000; --card-bg: #090909; --text: #00cec9; font-family: 'Courier New', monospace; color: #00cec9; }

    /* Shop Grid */
    .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
    .shop-item { 
      border: 2px solid #ddd; border-radius: 12px; padding: 10px; text-align: center; 
      cursor: pointer; transition: 0.2s; position: relative; background: var(--card-bg); color: var(--text);
    }
    .shop-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .shop-item.bought { border-color: var(--success); background: rgba(39,174,96,0.1); }
    .shop-item.equipped { border-color: var(--primary); background: rgba(52,152,219,0.1); box-shadow: 0 0 0 2px var(--primary); }

    /* Coin Display */
    .coin-display { 
      background: #f1c40f; color: #fff; padding: 4px 10px; border-radius: 20px; 
      font-weight: bold; margin-left: 5px; font-size: 0.9rem; vertical-align: middle;
      display: inline-flex; align-items: center; gap: 4px;
    }

    /* Boss Raid UI */
    .boss-container { text-align: center; margin-bottom: 15px; display: none; padding: 10px; border: 2px dashed #e74c3c; border-radius: 14px; background: rgba(231,76,60,0.05); }
    .boss-visual { font-size: 5rem; animation: floatBoss 3s infinite ease-in-out; display: inline-block; }
    @keyframes floatBoss { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-15px);} }
    .boss-hp-bar { width: 100%; height: 24px; background: #ddd; border-radius: 12px; overflow: hidden; margin-top: 10px; border: 2px solid #333; position: relative; }
    .boss-hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .boss-hp-text { position: absolute; top: 0; left: 0; width: 100%; text-align: center; color: #fff; font-weight: 900; line-height: 24px; text-shadow: 1px 1px 2px #000; font-size: 0.85rem; }

    /* Mic Button */
    .mic-btn {
      position: absolute; right: 50px; top: 50%; transform: translateY(-50%);
      background: none; border: none; font-size: 1.4rem; cursor: pointer;
      color: #7f8c8d; transition: 0.2s; z-index: 10;
    }
    .mic-btn.listening { color: #e74c3c; animation: pulseMic 1s infinite; }
    @keyframes pulseMic { 0%{transform:translateY(-50%) scale(1);} 50%{transform:translateY(-50%) scale(1.3);} 100%{transform:translateY(-50%) scale(1);} }

    /* Theme Support for existing elements */
    body.theme-dark .container, body.theme-dark .card, body.theme-dark details, body.theme-dark input, body.theme-dark textarea, body.theme-dark select { background: #2d2d2d; border-color: #444; color: #ecf0f1; }
    body.theme-dark .tab.active { background: #2d2d2d; color: #3498db; }
    body.theme-dark .tab { color: #95a5a6; }
    body.theme-cyber .container { border: 2px solid #00cec9; box-shadow: 0 0 10px #00cec9; }

    /* --- V2 & V3 Combined --- */

    /* iPad ê°€ë¡œ/ì„¸ë¡œ ëŒ€ì‘ (ê°€ë¡œ ìµœì í™”) */
    @media (orientation: landscape) and (min-width: 768px){
      body{ align-items:flex-start; }
      .container{
        width:96%;
        max-width:860px;
        padding:14px;
        border-radius:16px;
        max-height:calc(100dvh - var(--sat) - var(--sab) - 18px);
      }
      button{ padding:10px; }
      .grid-3,.grid-2{ gap:8px; }
      .button-group{ gap:8px; }
      .tabs{ margin:8px 0 10px; }
    }

    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; background: #fff; }
      .container { box-shadow: none; border: none; max-width: 100%; width: 100%; }
    }
    .listening-mode #question { font-size: 0; }
    .listening-mode #question::after {
      content: "ğŸ”Š ë“£ê³  ì“°ê¸°";
      font-size: 1.8rem; animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    .speed-control { display: flex; align-items: center; gap: 5px; font-weight: 800; font-size: 0.9rem; }
    .speed-btn { padding: 4px 8px; border-radius: 6px; background: #eee; color: #555; cursor: pointer; border: 1px solid #ddd; }
    .speed-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
</style>
<link rel="manifest" id="manifest-placeholder">
  <meta name="theme-color" content="#3498db">
  <meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>

<!-- TOAST -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- HOME -->
<div id="setup-screen" class="container">
  <div class="topbar">
    <div>
      <h1 class="title">VOCA ë§ˆìŠ¤í„° ğŸš€</h1>
      <div class="subhint">í•™ìŠµ â†’ ê¸°ë¡ â†’ ìƒì  <span class="coin-display" id="global-coin">ğŸ’ 0</span></div>
    </div>
    <button class="btn btn-dark" style="width:auto; padding:10px 12px;"
      onclick="window.__voca.openAdmin()"
      aria-label="ê´€ë¦¬ì ëª¨ë“œ ì—´ê¸°">ê´€ë¦¬ì âš™ï¸</button>
  </div>

  <div class="game-stats">
    <div class="level-row">
      <span id="home-level-text">Lv. 1</span>
      <span id="home-exp-text">0 / 100 EXP</span>
    </div>
    <div class="exp-bar-bg"><div id="home-exp-bar" class="exp-bar-fill"></div></div>
  </div>

  <div class="tabs" role="tablist" aria-label="í™ˆ íƒ­">
    <button class="tab active" id="tab-learn" role="tab" aria-selected="true" onclick="window.__voca.switchTab('learn')">í•™ìŠµ</button>
    <button class="tab" id="tab-record" role="tab" aria-selected="false" onclick="window.__voca.switchTab('record')">ê¸°ë¡</button>
    <button class="tab" id="tab-shop" role="tab" onclick="window.__voca.switchTab('shop')">ìƒì  ğŸ’</button>
    <button class="tab" id="tab-settings" role="tab" aria-selected="false" onclick="window.__voca.switchTab('settings')">ì„¤ì •</button>
  </div>

  <!-- TAB: LEARN -->
  <div id="panel-learn">
    <div class="card">
      <div class="row">
        <span class="pill good" id="streak-pill">ğŸ”¥ ì—°ì†: 0ì¼</span>
        <span class="pill good" id="today-pill">ì˜¤ëŠ˜: 0ë‹¨ì–´</span>
        <span class="pill warn" id="goal-pill">ëª©í‘œ: 10</span>
      </div>
      <div class="mini" style="margin-top:8px;">* ì˜¤ë‹µ ë³µìŠµì€ í‹€ë¦° ë‹¨ì–´ê°€ ìƒê¸°ë©´ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.</div>
    </div>

    <div class="grid-3">
      <button class="btn btn-primary" onclick="window.__voca.initQuiz('verbs')">ë™ì‚¬ ğŸƒ</button>
      <button class="btn btn-primary" onclick="window.__voca.initQuiz('nouns')">ëª…ì‚¬ ğŸ’</button>
      <button class="btn btn-primary" onclick="window.__voca.initQuiz('adjectives')">í˜•ìš©ì‚¬ âœ¨</button>
    </div>

    <div class="grid-2" style="margin-top:10px;">
      <button class="btn btn-time" onclick="window.__voca.initQuiz('time')">íƒ€ì„ ì–´íƒ â±ï¸</button>
      <button class="btn btn-danger" onclick="window.__voca.initBossRaid()">ğŸ”¥ ë³´ìŠ¤ ë ˆì´ë“œ</button>
      <button class="btn btn-dark" onclick="window.__voca.initQuiz('dictation')">ë°›ì•„ì“°ê¸° âœï¸</button>
      <button class="btn btn-review hidden" id="btn-play-review" onclick="window.__voca.initQuiz('wrong')">ì˜¤ë‹µ ë³µìŠµ ğŸ§ </button>
      <button class="btn btn-custom hidden" id="btn-play-custom" onclick="window.__voca.initQuiz('custom')">ë‚˜ë§Œì˜ ë‹¨ì–´ì¥ ğŸŒŸ</button>
      <button class="btn btn-dark" onclick="window.__voca.openMaker()" style="grid-column:span 2;">ìƒˆ ë‹¨ì–´ ì¶”ê°€ âœï¸</button>
    </div>
  </div>

  <!-- TAB: RECORD -->
  <div id="panel-record" class="hidden">
    <details>
      <summary><span>ğŸ† íƒ€ì„ì–´íƒ ìµœê³  ê¸°ë¡</span><span class="right" id="best-time-score">0ì </span></summary>
      <div class="card" style="margin:10px 0 0;">
        <div class="row">
          <span class="pill">ì ìˆ˜: <span id="bestScoreVal">0</span></span>
          <span class="pill">ì •í™•ë„: <span id="bestAccVal">0</span>%</span>
          <span class="pill">ë¶„ë‹¹: <span id="bestWpmVal">0</span></span>
        </div>
        <button class="btn btn-gray" style="margin-top:10px;" onclick="window.__voca.resetBest()">ê¸°ë¡ ì´ˆê¸°í™”</button>
      </div>
    </details>

    <details>
      <summary><span>ğŸŒ± ìµœê·¼ 28ì¼ ì”ë””</span><span class="right">í¼ì¹˜ê¸°</span></summary>
      <div class="grass-grid" id="grass-grid"></div>
    </details>

    <details>
      <summary><span>ğŸ… ë°°ì§€</span><span class="right" id="badge-summary">0/8</span></summary>
      <div class="badge-wrap" id="badge-wrap"></div>
    </details>

    <details>
      <summary><span>ğŸ“¤ í•™ìŠµê¸°ë¡ CSV ë‚´ë³´ë‚´ê¸°</span><span class="right">ê´€ë¦¬ì ëª¨ë“œ ì¶”ì²œ</span></summary>
      <div class="card" style="margin:10px 0 0;">
        <div class="mini">* ë‚ ì§œë³„ ì •ë‹µ/ì‹œë„/ì •í™•ë„/íƒ€ì„ì–´íƒ ìµœê³ ê°€ í¬í•¨ë©ë‹ˆë‹¤.</div>
        <button class="btn btn-primary" style="margin-top:10px;" onclick="window.__voca.exportCSV()">CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </details>
  </div>

  <!-- TAB: SETTINGS -->
  
  <!-- TAB: SHOP -->
  <div id="panel-shop" class="hidden">
    <div class="card" style="text-align:center; background:linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color:#fff; border:none;">
      <div style="font-size:1.2rem; font-weight:900;">ë‚´ ì§€ê°‘</div>
      <div style="font-size:2.5rem; font-weight:900; margin:10px 0;" id="shop-coin-big">ğŸ’ 0</div>
      <div class="mini" style="color:#fff; opacity:0.9;">* í•™ìŠµí•˜ê³  ë³´ìŠ¤ë¥¼ ì¡ì•„ ì½”ì¸ì„ ëª¨ìœ¼ì„¸ìš”!</div>
    </div>

    <div style="font-weight:900; margin:15px 0 8px;">ğŸ¨ í…Œë§ˆ ìŠ¤í‚¨</div>
    <div class="shop-grid" id="shop-themes">
      <!-- Generated by JS -->
    </div>
  </div>

  <div id="panel-settings" class="hidden">
    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:900; margin-bottom:6px;">ë°ì¼ë¦¬ ëª©í‘œ</div>
          <select id="dailyGoalSelect">
            <option value="5">5ë‹¨ì–´</option><option value="10" selected>10ë‹¨ì–´</option>
            <option value="20">20ë‹¨ì–´</option><option value="30">30ë‹¨ì–´</option>
          </select>
        </div>
        <div>
          <div style="font-weight:900; margin-bottom:6px;">ìë™ ë°œìŒ</div>
          <select id="autoTTSSelect"><option value="on">ON</option><option value="off">OFF</option></select>
        </div>
        </div>
        <div>
          <div style="font-weight:900; margin-bottom:6px;">ë°œìŒ ì†ë„ ğŸ¢/ğŸ‡</div>
          <div class="speed-control" id="speedControl">
            <button class="speed-btn" onclick="window.__voca.setSpeed(0.8)">0.8x</button>
            <button class="speed-btn active" onclick="window.__voca.setSpeed(1.0)">1.0x</button>
            <button class="speed-btn" onclick="window.__voca.setSpeed(1.2)">1.2x</button>
          </div>

      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <div style="font-weight:900; margin-bottom:6px;">ì˜¤íƒ€ í—ˆìš©</div>
          <select id="typoSelect"><option value="on" selected>ON</option><option value="off">OFF</option></select>
        </div>
        <div>
          <div style="font-weight:900; margin-bottom:6px;">íš¨ê³¼ìŒ</div>
          <select id="sfxSelect"><option value="on" selected>ON</option><option value="off">OFF</option></select>
        </div>
      </div>
      <div class="mini" style="margin-top:10px;">
        * ì˜¤íƒ€ í—ˆìš© ON: 4ê¸€ì ì´ìƒì—ì„œ 1ê¸€ì ì˜¤ì°¨ë¥¼ â€œì˜¤íƒ€ì§€ë§Œ ì •ë‹µ ì¸ì •â€ ì²˜ë¦¬(EXP ì¼ë¶€ ê°ì†Œ)
      </div>
    </div>
  </div>
</div>

<!-- MAKER -->
<div id="maker-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">ë‹¨ì–´ ì¶”ê°€ âœï¸</h1>
      <div class="subhint">í•œ ê°œ ì¶”ê°€ Â· ì¼ê´„ ì¶”ê°€ Â· ë°±ì—…(ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°)</div>
    </div>
    <button class="btn btn-danger" style="width:auto; padding:10px 12px;" onclick="window.__voca.closeMaker()">ë©”ì¸ ğŸ”™</button>
  </div>

  <div class="card">
    <div class="row">
      <input id="newKan" placeholder="ëœ» (ì˜ˆ: í•™êµ)" autocomplete="off">
      <input id="newEng" placeholder="ì˜ì–´ (ì˜ˆ: school)" autocomplete="off">
    </div>
    <button class="btn btn-primary" style="margin-top:10px;" onclick="window.__voca.addCustomWord()">ëª©ë¡ì— ì¶”ê°€ â•</button>
    <div class="mini" id="custom-count" style="text-align:right; margin-top:8px;">ì´ 0ê°œ</div>
    <ul id="custom-words-list" class="list"></ul>
  </div>

  <details>
    <summary><span>ğŸ“¥ ì¼ê´„ ì¶”ê°€</span><span class="right">í¼ì¹˜ê¸°</span></summary>
    <textarea id="bulkArea" rows="5" placeholder="ì˜ˆ)
í•™êµ school
ì‚¬ê³¼ apple
ê°€ë°© bag"></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="window.__voca.addBulk()">ì¼ê´„ ì¶”ê°€</button>
      <button class="btn btn-gray" onclick="window.__voca.clearBulk()">ë¹„ìš°ê¸°</button>
    </div>
    <div class="mini" style="margin-top:8px;">* í•œ ì¤„ì— â€œëœ» ì˜ì–´â€ ë˜ëŠ” â€œëœ»,ì˜ì–´â€ ë˜ëŠ” íƒ­ êµ¬ë¶„ë„ ì¸ì‹</div>
  </details>

  <details>
    <summary><span>ğŸ” ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°(ë°±ì—…)</span><span class="right">í¼ì¹˜ê¸°</span></summary>
    <textarea id="backupArea" rows="5" placeholder="ë‚´ë³´ë‚´ê¸° JSON ë˜ëŠ” ê°€ì ¸ì˜¤ê¸° JSONì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="window.__voca.exportCustom()">ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn-dark" onclick="window.__voca.copyBackup()">ë³µì‚¬</button>
      <button class="btn btn-danger" onclick="window.__voca.importCustom()">ê°€ì ¸ì˜¤ê¸°</button>
    </div>
    <div class="mini" style="margin-top:8px;">* ê°€ì ¸ì˜¤ê¸°ëŠ” ê¸°ì¡´ ëª©ë¡ì— â€œì¶”ê°€â€(ì¤‘ë³µ ìë™ ì œì™¸)</div>
  </details>
</div>

<!-- QUIZ -->
<div id="quiz-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">í€´ì¦ˆ ğŸ®</h1>
      <div class="subhint"><span id="quiz-level-text">Lv. 1</span> Â· <span id="quiz-combo-text"></span></div>
    </div>
    <div class="toggles">
      <button id="sfxBtn" onclick="window.__voca.toggleSfx()" title="íš¨ê³¼ìŒ"
        aria-label="íš¨ê³¼ìŒ ì¼œê¸° ë˜ëŠ” ë„ê¸°">ğŸ””</button>
      
      <button id="listenModeBtn" onclick="window.__voca.toggleListenMode()" title="ë¦¬ìŠ¤ë‹ ëª¨ë“œ (ê¸€ì ê°€ë¦¬ê¸°)"
        aria-label="ë¦¬ìŠ¤ë‹ ëª¨ë“œ ì „í™˜">ğŸ‘ï¸</button>
<button id="muteBtn" onclick="window.__voca.toggleMute()" title="ë°œìŒ"
        aria-label="ë°œìŒ ì¼œê¸° ë˜ëŠ” ë„ê¸°">ğŸ”Š</button>
    </div>
  </div>

  <div class="game-stats">
    <div class="exp-bar-bg"><div id="quiz-exp-bar" class="exp-bar-fill"></div></div>
  </div>

  <div class="stats">
    <span class="pill good">ì ìˆ˜: <span id="score">0</span></span>
    <span class="pill">ì‹œë„: <span id="attempts">0</span></span>
    <span class="pill">ì •í™•ë„: <span id="accuracy">0</span>%</span>
    <span class="pill warn">ë‚¨ì€: <span id="remaining">0</span></span>
    <span id="timer-display" class="pill danger hidden timer-text">â±ï¸ <span id="time-left">60</span>ì´ˆ</span>
  </div>

  
  <div id="boss-stage" class="boss-container">
    <div class="boss-visual" id="boss-emoji">ğŸ˜ˆ</div>
    <div class="boss-hp-bar">
      <div id="boss-hp" class="boss-hp-fill"></div>
      <div id="boss-hp-text" class="boss-hp-text">1000/1000</div>
    </div>
  </div>

  <div class="card-container">
    <div id="question">ë‹¨ì–´</div>
    <button class="btn-listen" onclick="window.__voca.playCurrentWordTTS()" title="ë°œìŒ ë“£ê¸°"
      aria-label="í˜„ì¬ ë‹¨ì–´ ë°œìŒ ë“£ê¸°">ğŸ—£ï¸</button>
  </div>

  
  <div style="position:relative; margin-top:10px;">
    <input id="answerInput" placeholder="ì •ë‹µ ì…ë ¥ (ë˜ëŠ” ë§ˆì´í¬ í´ë¦­)" autocomplete="off" style="padding-right:90px;">
    <!-- Mic Button (V3) -->
    <button id="micBtn" class="mic-btn" onclick="window.__voca.toggleMic()" title="ìŒì„± ì¸ì‹ (í¬ë¡¬ ì „ìš©)">ğŸ¤</button>
    <!-- Listen Mode Toggle (V2 Feature moved here for better layout, optional, or keep in topbar) -->
    <!-- Let's keep V2's topbar toggle for Listen Mode, but add a quick TTS button here inside input like V3 design -->
  </div>

  <div id="hintArea"></div>
  <div id="nearBanner" class="near-banner" role="status" aria-live="polite"></div>

  <div class="button-group">
    <button class="btn btn-main" onclick="window.__voca.handleCheck()">ì •ë‹µ í™•ì¸</button>
    <button class="btn btn-hint" onclick="window.__voca.showHint()">íŒíŠ¸ ğŸ’¡</button>
    <button class="btn btn-exit" onclick="window.__voca.showResult()">ëë‚´ê¸° ğŸ</button>
  </div>

  <div id="feedback"></div>
</div>

<!-- RESULT -->
<div id="result-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">ê²°ê³¼ ğŸ“</h1>
      <div class="subhint" id="final-score">ìµœì¢… ì ìˆ˜: 0ì </div>
    </div>
    <button class="btn btn-dark" style="width:auto; padding:10px 12px;"
      onclick="location.reload()" aria-label="í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°">í™ˆ ğŸ </button>
  </div>

  <div id="time-extra" class="card hidden">
    <div style="font-weight:900; margin-bottom:6px;">â±ï¸ íƒ€ì„ì–´íƒ ë¶„ì„</div>
    <div id="time-stats" style="font-weight:900; color:#2c3e50;"></div>
    <div id="best-badge" style="margin-top:8px; font-weight:900;"></div>
  </div>

  <div class="card" style="background:#fff3f3; border-color:rgba(231,76,60,.18);">
    <div style="font-weight:900; color:var(--danger);">ëˆ„ì  ì˜¤ë‹µ ë…¸íŠ¸ ğŸš©</div>
    <div class="mini" style="margin-top:6px;">* â€˜ìˆ™ë ¨â€™ìœ¼ë¡œ ë³´ë‚´ë©´ ê¸°ë¡ìœ¼ë¡œ ë‚¨ê³ , ì˜¤ë‹µì—ì„œ ë¹ ì§‘ë‹ˆë‹¤.</div>
    <ul id="wrong-items" class="list"></ul>
    <button class="btn btn-gray" style="margin-top:10px; padding:8px;" onclick="window.__voca.printWrongNotes()">ğŸ–¨ï¸ ì˜¤ë‹µ ë…¸íŠ¸ ì¸ì‡„ (ì‹œí—˜ì§€)</button>

  </div>

  <div class="card" style="background:#f4fbf6; border-color:rgba(39,174,96,.18);">
    <div style="font-weight:900; color:var(--success);">ìˆ™ë ¨(ë§ˆìŠ¤í„°) ğŸ†</div>
    <div class="mini" style="margin-top:6px;">* ì •ë³µí•œ ë‹¨ì–´ ëª©ë¡ì…ë‹ˆë‹¤.</div>
    <ul id="master-items" class="list"></ul>
  </div>
</div>

<!-- ADMIN (í•™ìƒì´ ì§ì ‘ ê´€ë¦¬) -->
<div id="admin-screen" class="container hidden">
  <div class="topbar">
    <div>
      <h1 class="title">ê´€ë¦¬ì ëª¨ë“œ âš™ï¸</h1>
      <div class="subhint">ì„¸íŠ¸ ë§Œë“¤ê¸° Â· ì„¸íŠ¸ ì ìš© Â· ë°°í¬(JSON) Â· ê¸°ë¡(CSV)</div>
    </div>
    <button class="btn btn-danger" style="width:auto; padding:10px 12px;"
      onclick="window.__voca.closeAdmin()" aria-label="ê´€ë¦¬ì ëª¨ë“œ ë‹«ê¸°">ë©”ì¸ ğŸ”™</button>
  </div>

  <div class="card">
    <div style="font-weight:900; margin-bottom:8px;">ğŸ“¦ ë‹¨ì–´ ì„¸íŠ¸ ë§Œë“¤ê¸°</div>
    <input id="setName" placeholder="ì„¸íŠ¸ ì´ë¦„ (ì˜ˆ: 4-1 1ë‹¨ì›)" />
    <textarea id="setBulk" rows="6" style="margin-top:10px;" placeholder="ì˜ˆ)
í•™êµ school
ì‚¬ê³¼ apple
ê°€ë°© bag"></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="window.__voca.saveSet()">ì„¸íŠ¸ ì €ì¥</button>
      <button class="btn btn-gray" onclick="window.__voca.clearSetForm()">ì´ˆê¸°í™”</button>
    </div>
    <div class="mini" style="margin-top:8px;">
      * ì €ì¥í•œ ì„¸íŠ¸ë¥¼ â€œì ìš©â€í•˜ë©´ í•´ë‹¹ ì„¸íŠ¸ ë‹¨ì–´ê°€ â€˜ë‚˜ë§Œì˜ ë‹¨ì–´ì¥â€™ì— ìë™ ì¶”ê°€ë©ë‹ˆë‹¤(ì¤‘ë³µ ì œì™¸).
    </div>
  </div>

  <details open>
    <summary><span>ğŸ“š ì €ì¥ëœ ì„¸íŠ¸</span><span class="right">ì ìš©/ë‚´ë³´ë‚´ê¸°/ì‚­ì œ</span></summary>
    <ul id="setList" class="list"></ul>
  </details>

  <details>
    <summary><span>ğŸ“¤ ì„¸íŠ¸ JSON ë‚´ë³´ë‚´ê¸°</span><span class="right">ê³µìœ /ë°±ì—…</span></summary>
    <textarea id="adminExport" rows="5" placeholder="ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ë©´ JSONì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-dark" onclick="window.__voca.copyAdminExport()">JSON ë³µì‚¬</button>
      <button class="btn btn-primary" onclick="window.__voca.exportCSV()">í•™ìŠµê¸°ë¡ CSV</button>
    </div>
  </details>

  <details>
    <summary><span>ğŸ“¥ ì„¸íŠ¸ JSON ê°€ì ¸ì˜¤ê¸°</span><span class="right">ë¶™ì—¬ë„£ê¸°</span></summary>
    <textarea id="adminImport" rows="5" placeholder="ë‹¤ë¥¸ ì‚¬ëŒì´ ì¤€ ì„¸íŠ¸ JSONì„ ë¶™ì—¬ë„£ê³  ê°€ì ¸ì˜¤ì„¸ìš”."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-primary" onclick="window.__voca.importSetJSON()">ì„¸íŠ¸ ê°€ì ¸ì˜¤ê¸°</button>
      <button class="btn btn-gray" onclick="document.getElementById('adminImport').value=''">ë¹„ìš°ê¸°</button>
    </div>
    <div class="mini" style="margin-top:8px;">* ê°€ì ¸ì˜¨ ì„¸íŠ¸ëŠ” â€œì €ì¥ëœ ì„¸íŠ¸â€ ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤.</div>
  </details>
</div>

<script>
(() => {
  "use strict";

  /* =========================
   * Storage: ì•ˆì „ ë¡œë“œ/ì„¸ì´ë¸Œ
   * ========================= */
  const Storage = {
    safeLoad(key, fallback, onRecover) {
      try {
        const raw = localStorage.getItem(key);
        if (raw === null || raw === undefined) return fallback;
        return JSON.parse(raw);
      } catch (e) {
        // ë°ì´í„° ì†ìƒ â†’ ë³µêµ¬
        try { localStorage.removeItem(key); } catch {}
        if (typeof onRecover === "function") onRecover(key);
        return fallback;
      }
    },
    safeSave(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); return true; }
      catch { return false; }
    },
    safeRemove(key) {
      try { localStorage.removeItem(key); } catch {}
    }
  };

  /* =========================
   * App Class: ìƒíƒœ/ë¡œì§ ìº¡ìŠí™”
   * ========================= */
  class VocaApp {
    constructor() {
      this.wordBank = {
        verbs: [{kan:"ë•ë‹¤",eng:"help"},{kan:"ì”»ë‹¤",eng:"wash"},{kan:"ì²­ì†Œí•˜ë‹¤",eng:"clean"},{kan:"ì—°ìŠµí•˜ë‹¤",eng:"practice"},{kan:"ê³µë¶€í•˜ë‹¤",eng:"study"}],
        nouns: [{kan:"í•™êµ",eng:"school"},{kan:"ì‚¬ê³¼",eng:"apple"},{kan:"ê°€ë°©",eng:"bag"},{kan:"ì±…ìƒ",eng:"desk"},{kan:"ë¬¼",eng:"water"}],
        adjectives: [{kan:"í–‰ë³µí•œ",eng:"happy"},{kan:"ìŠ¬í”ˆ",eng:"sad"},{kan:"ê°•í•œ",eng:"strong"},{kan:"ë°”ìœ",eng:"busy"},{kan:"ì˜ˆìœ",eng:"pretty"}]
      };

      // ìƒíƒœ(State) ë‹¨ì¼ ê°ì²´ë¡œ í†µí•©
      this.state = {
        data: {
          customWords: [],
          wrongWords: [],
          masterWords: [],
          playerLevel: 1,
          playerExp: 0,
          attendanceData: {},
          settings: { dailyGoal: 10, autoTTS: true, typoHelp: true, sfx: true, ttsSpeed: 1.0 },
          bestTimeAttack: { bestScore: 0, bestWpm: 0, bestAccuracy: 0 },
          progress: { daily:{}, history:[] },
          sets: [],
          badges: {},
          coins: 0,
          inventory: ['default'],
          equippedTheme: 'default'
        },
        runtime: {
          currentList: [],
          currentWord: null,
          combo: 0,
          score: 0,
          attempts: 0,
          correctCount: 0,
          isMuted: false, isListeningMode: false,
          isTimeMode: false,
          timerInterval: null,
          timeLeft: 60,
          timeModeStart: 0,
          audioCtx: null,
          isBossMode: false,
          bossHP: 0,
          maxBossHP: 0
        }
      };

      this.BADGE_DEF = [
        {id:'streak_3',  icon:'ğŸ”¥', name:'3ì¼ ì—°ì†',  desc:'ì—°ì† í•™ìŠµ 3ì¼'},
        {id:'streak_7',  icon:'ğŸ”¥', name:'7ì¼ ì—°ì†',  desc:'ì—°ì† í•™ìŠµ 7ì¼'},
        {id:'streak_14', icon:'ğŸ”¥', name:'14ì¼ ì—°ì†', desc:'ì—°ì† í•™ìŠµ 14ì¼'},
        {id:'goal_1',    icon:'ğŸ…', name:'ì˜¤ëŠ˜ ëª©í‘œ',  desc:'ì˜¤ëŠ˜ ëª©í‘œ ë‹¬ì„±'},
        {id:'goal_7',    icon:'ğŸ…', name:'ëª©í‘œ 7íšŒ',   desc:'ëª©í‘œ ë‹¬ì„± 7íšŒ'},
        {id:'master_10', icon:'ğŸ†', name:'ì •ë³µ 10',    desc:'ìˆ™ë ¨ 10ê°œ ë‹¬ì„±'},
        {id:'time_15',   icon:'â±ï¸', name:'íƒ€ì„ 15ì ',  desc:'íƒ€ì„ì–´íƒ 15ì  ë‹¬ì„±'},
        {id:'time_best', icon:'ğŸ‰', name:'ì‹ ê¸°ë¡',     desc:'íƒ€ì„ì–´íƒ ìµœê³ ê¸°ë¡ ê°±ì‹ '}
      ];
    }

    /* ---------- UI Helpers ---------- */
    $(id){ return document.getElementById(id); }

    toast(msg){
      const t = this.$('toast');
      if(!t) return;
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(this._toastTimer);
      this._toastTimer = setTimeout(()=>t.classList.remove('show'), 1700);
    }

    /* ---------- Data Load/Save ---------- */
    loadAll() {
      const onRecover = (k)=>this.toast(`ì €ì¥ ë°ì´í„°(${k})ê°€ ì†ìƒë˜ì–´ ì´ˆê¸°í™”í–ˆì–´ìš” ğŸ›¡ï¸`);
      const D = this.state.data;

      D.customWords    = Storage.safeLoad('myVocaCustom', [], onRecover);
      D.wrongWords     = Storage.safeLoad('myVocaWrongWords', [], onRecover);
      D.masterWords    = Storage.safeLoad('myVocaMasterWords', [], onRecover);
      D.playerLevel    = parseInt(Storage.safeLoad('myVocaLevel', 1, onRecover)) || 1;
      D.playerExp      = parseInt(Storage.safeLoad('myVocaExp', 0, onRecover)) || 0;
      D.attendanceData = Storage.safeLoad('myVocaAttendance', {}, onRecover);
      D.settings       = Storage.safeLoad('myVocaSettings', { dailyGoal:10, autoTTS:true, typoHelp:true, sfx:true, ttsSpeed:1.0 }, onRecover);
      D.bestTimeAttack = Storage.safeLoad('myVocaBestTimeAttack', { bestScore:0, bestWpm:0, bestAccuracy:0 }, onRecover);
      D.progress       = Storage.safeLoad('myVocaProgress', { daily:{}, history:[] }, onRecover);
      D.sets           = Storage.safeLoad('myVocaSets', [], onRecover);
      D.badges = Storage.safeLoad('myVocaBadges', {}, onRecover);
      D.coins = parseInt(Storage.safeLoad('myVocaCoins', 0, onRecover)) || 0;
      D.inventory = Storage.safeLoad('myVocaInventory', ['default'], onRecover);
      D.equippedTheme = Storage.safeLoad('myVocaTheme', 'default', onRecover);
      if(D.equippedTheme && D.equippedTheme !== 'default') document.body.classList.add(`theme-${D.equippedTheme}`);


      // ë°ì´í„° ì •ê·œí™”(ìµœì†Œ ì•ˆì „ì¥ì¹˜)
      if(!Array.isArray(D.customWords)) D.customWords = [];
      if(!Array.isArray(D.wrongWords)) D.wrongWords = [];
      if(!Array.isArray(D.masterWords)) D.masterWords = [];
      if(!Array.isArray(D.sets)) D.sets = [];
      if(typeof D.attendanceData !== 'object' || D.attendanceData === null) D.attendanceData = {};
      if(typeof D.badges !== 'object' || D.badges === null) D.badges = {};
      if(typeof D.progress !== 'object' || D.progress === null) D.progress = { daily:{}, history:[] };

      // settings ì •ê·œí™”
      D.settings.dailyGoal = parseInt(D.settings.dailyGoal || 10);
      D.settings.autoTTS = !!D.settings.autoTTS;
      D.settings.typoHelp = !!D.settings.typoHelp;
      D.settings.sfx = !!D.settings.sfx;

      D.settings.ttsSpeed = parseFloat(D.settings.ttsSpeed || 1.0);

      return true;
    }

    saveKey(key, value){
      return Storage.safeSave(key, value);
    }

    persistCore(){
      const D = this.state.data;
      this.saveKey('myVocaCustom', D.customWords);
      this.saveKey('myVocaWrongWords', D.wrongWords);
      this.saveKey('myVocaMasterWords', D.masterWords);
      this.saveKey('myVocaLevel', D.playerLevel);
      this.saveKey('myVocaExp', D.playerExp);
      this.saveKey('myVocaAttendance', D.attendanceData);
      this.saveKey('myVocaSettings', D.settings);
      this.saveKey('myVocaBestTimeAttack', D.bestTimeAttack);
      this.saveKey('myVocaProgress', D.progress);
      this.saveKey('myVocaSets', D.sets);
      this.saveKey('myVocaBadges', D.badges);
          this.saveKey('myVocaCoins', D.coins||0);
      this.saveKey('myVocaInventory', D.inventory||['default']);
      this.saveKey('myVocaTheme', D.equippedTheme||'default');
    }

    /* ---------- Utils ---------- */
    normalizeEng(s){ return String(s||"").trim().toLowerCase(); }
    dateStrOf(d){
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    ensureAudio(){
      const R = this.state.runtime;
      if(!R.audioCtx) R.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return R.audioCtx;
    }

    playSound(type){
      const { settings } = this.state.data;
      if(!settings.sfx) return;
      const ctx = this.ensureAudio();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);

      if(type==='correct'){ osc.frequency.setValueAtTime(880, ctx.currentTime); osc.type='sine'; }
      else if(type==='levelup'){ osc.frequency.setValueAtTime(1046.5, ctx.currentTime); osc.type='sine'; }
      else if(type==='tick'){ osc.frequency.setValueAtTime(600, ctx.currentTime); osc.type='triangle'; gain.gain.setValueAtTime(0.5, ctx.currentTime); }
      else { osc.frequency.setValueAtTime(220, ctx.currentTime); osc.type='square'; }

      osc.start();
      const dur = (type==='tick') ? 0.1 : 0.25;
      gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + dur);
      osc.stop(ctx.currentTime + dur);
    }

    speakWord(text, slow=false){
      const R = this.state.runtime;
      if(R.isMuted) return;

      // ì§€ì› ì—¬ë¶€
      if(!('speechSynthesis' in window) || typeof SpeechSynthesisUtterance === 'undefined'){
        this.toast('ì´ ê¸°ê¸°/ë¸Œë¼ìš°ì €ëŠ” ë°œìŒì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.');
        return;
      }

      const self = this;
      const msg = String(text || '').trim();
      if(!msg) return;

      let u;
      try{
        // iOSì—ì„œ ì”ì—¬ íê°€ ê¼¬ì¼ ìˆ˜ ìˆì–´ í•­ìƒ ì •ë¦¬
        try{ window.speechSynthesis.cancel(); }catch{}
        u = new SpeechSynthesisUtterance(msg);
      }catch(e){
        this.toast('ë°œìŒ ì¤€ë¹„ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        return;
      }

      u.lang = 'en-US';
      u.rate = slow ? 0.8 : (this.state.data.settings.ttsSpeed || 1.0);

      let started = false;
      let done = false;

      const notifyBlocked = (detail)=>{
        if(done) return;
        done = true;
        // iOS ë¬´ìŒëª¨ë“œ/ê¶Œí•œ/ì •ì±…ìœ¼ë¡œ ë§‰í˜€ë„ ì•±ì€ ê³„ì† ë™ì‘
        self.toast(detail || 'ğŸ”‡ ë°œìŒì´ ì°¨ë‹¨ë˜ì—ˆì–´ìš”. (ë¬´ìŒëª¨ë“œ/ë³¼ë¥¨/ì‚¬íŒŒë¦¬ ì •ì±…) ì†Œë¦¬ë¥¼ ì¼œê³  ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      };

      const startGuard = setTimeout(()=>{
        if(!started && !done){
          notifyBlocked('ğŸ”‡ ë°œìŒì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ì–´ìš”. iOS ë¬´ìŒëª¨ë“œ/ì‚¬íŒŒë¦¬ ì •ì±… ë•Œë¬¸ì— ë§‰í ìˆ˜ ìˆì–´ìš”.');
        }
      }, 1300);

      u.onstart = ()=>{ started = true; clearTimeout(startGuard); };
      u.onend   = ()=>{ done = true; clearTimeout(startGuard); };
      u.onerror = ()=>{ clearTimeout(startGuard); notifyBlocked(); };

      try{
        window.speechSynthesis.speak(u);
      }catch(e){
        clearTimeout(startGuard);
        notifyBlocked('ğŸ”‡ ë°œìŒ ì‹¤í–‰ì´ ì‹¤íŒ¨í–ˆì–´ìš”. ì†Œë¦¬/ê¶Œí•œì„ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }
    }

    showParticles(emoji){
      for(let i=0;i<14;i++){
        const p=document.createElement('div');
        p.innerText=emoji;
        p.className='particle';
        p.style.left=(50+(Math.random()*40-20))+'vw';
        p.style.top=(50+(Math.random()*40-20))+'vh';
        p.style.fontSize=(Math.random()*18+18)+'px';
        document.body.appendChild(p);
        setTimeout(()=>p.remove(), 1200);
      }
    }

    levenshtein(a,b){
      a=a||""; b=b||"";
      const n=a.length, m=b.length;
      const dp=Array.from({length:n+1},()=>Array(m+1).fill(0));
      for(let i=0;i<=n;i++) dp[i][0]=i;
      for(let j=0;j<=m;j++) dp[0][j]=j;
      for(let i=1;i<=n;i++){
        for(let j=1;j<=m;j++){
          const cost=(a[i-1]===b[j-1])?0:1;
          dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[n][m];
    }


    shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    /* ---------- Tabs ---------- */
    
    /* --- V2 Features --- */
    
    /* --- V3 God Mode Logic --- */
    addCoin(n) {
      const D = this.state.data;
      D.coins = (D.coins || 0) + n;
      this.saveKey('myVocaCoins', D.coins);
      this.renderCoin();
    }
    renderCoin() {
      const c = this.state.data.coins || 0;
      const el1 = document.getElementById('global-coin');
      const el2 = document.getElementById('shop-coin-big');
      if(el1) el1.innerText = `ğŸ’ ${c}`;
      if(el2) el2.innerText = `ğŸ’ ${c}`;
    }
    initShop() {
      const themes = [
        {id:'default', name:'ê¸°ë³¸ (í™”ì´íŠ¸)', price:0, color:'#fff'},
        {id:'dark', name:'ë‹¤í¬ ëª¨ë“œ', price:500, color:'#2c3e50'},
        {id:'pink', name:'í•‘í¬ ëŸ¬ë¸”ë¦¬', price:1000, color:'#ff9ff3'},
        {id:'cyber', name:'ì‚¬ì´ë²„ í‘í¬', price:2000, color:'#000'}
      ];
      const grid = document.getElementById('shop-themes');
      if(!grid) return;
      grid.innerHTML = '';
      const myItems = this.state.data.inventory || ['default'];
      const current = this.state.data.equippedTheme || 'default';

      themes.forEach(t => {
        const has = myItems.includes(t.id);
        const equipped = (current === t.id);
        const div = document.createElement('div');
        div.className = `shop-item ${has ? 'bought' : ''} ${equipped ? 'equipped' : ''}`;
        div.innerHTML = `
          <div style="width:30px; height:30px; background:${t.color}; border-radius:50%; margin:0 auto 5px; border:1px solid #ddd;"></div>
          <div style="font-weight:bold;">${t.name}</div>
          <div style="font-size:0.9rem; margin-top:5px;">${has ? (equipped?'ì¥ì°©ì¤‘':'ë³´ìœ ì¤‘') : 'ğŸ’ '+t.price}</div>
        `;
        div.onclick = () => {
          if(equipped) return;
          if(has) { this.equipTheme(t.id); }
          else {
            if((this.state.data.coins||0) >= t.price) {
              if(confirm(`${t.name} í…Œë§ˆë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
                this.addCoin(-t.price);
                this.state.data.inventory.push(t.id);
                this.saveKey('myVocaInventory', this.state.data.inventory);
                this.equipTheme(t.id);
              }
            } else { alert('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! í•™ìŠµì„ í†µí•´ ëª¨ì•„ë³´ì„¸ìš” ğŸ’°'); }
          }
        };
        grid.appendChild(div);
      });
    }
    equipTheme(id) {
      this.state.data.equippedTheme = id;
      this.saveKey('myVocaTheme', id);
      // Remove all theme classes first
      document.body.classList.remove('theme-dark', 'theme-pink', 'theme-cyber');
      if(id !== 'default') document.body.classList.add(`theme-${id}`);
      this.initShop();
      this.toast('í…Œë§ˆê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¨');
    }

    // Boss
    initBossRaid() {
      this.state.runtime.isBossMode = true;
      this.state.runtime.bossHP = 1000;
      this.state.runtime.maxBossHP = 1000;
      this.$('boss-stage').style.display = 'block';
      this.initQuiz('time'); // íƒ€ì„ì–´íƒ ê¸°ë°˜
      this.toast('ğŸ˜ˆ ë³´ìŠ¤ ì¶œí˜„! ì •ë‹µì„ ë§ì¶° ê³µê²©í•˜ì„¸ìš”!');
    }
    bossAttack(dmg) {
      const R = this.state.runtime;
      if(!R.isBossMode) return;
      R.bossHP -= dmg;
      const pct = Math.max(0, (R.bossHP/R.maxBossHP)*100);
      this.$('boss-hp').style.width = `${pct}%`;
      this.$('boss-hp-text').innerText = `${R.bossHP}/${R.maxBossHP}`;

      // Damage Effect
      const eff = document.createElement('div');
      eff.innerText = `-${dmg}`;
      eff.style.position='fixed'; eff.style.left='50%'; eff.style.top='40%'; 
      eff.style.color='#e74c3c'; eff.style.fontWeight='900'; eff.style.fontSize='2rem'; 
      eff.style.pointerEvents='none'; eff.style.animation='floatUp 0.8s forwards';
      document.body.appendChild(eff);
      setTimeout(()=>eff.remove(), 800);

      if(R.bossHP <= 0) {
        this.state.runtime.timeLeft = 0; // End Game
        clearInterval(this.state.runtime.timerInterval);
        alert('ğŸ‰ ë³´ìŠ¤ í† ë²Œ ì„±ê³µ!! ë³´ìƒ: ğŸ’ 300');
        this.addCoin(300);
        this.showResult();
      }
    }

    // Mic
    toggleMic() {
      if(!('webkitSpeechRecognition' in window)) return alert('í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ê°€ëŠ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
      if(this.micListening) { this.rec.stop(); return; }

      const rec = new window.webkitSpeechRecognition();
      rec.lang = 'en-US'; 
      rec.interimResults = false; 
      rec.maxAlternatives = 1;

      this.micListening = true;
      this.$('micBtn').classList.add('listening');

      rec.onstart = () => { this.toast('ğŸ¤ ë“£ê³  ìˆì–´ìš”...'); };
      rec.onresult = (e) => {
        const txt = e.results[0][0].transcript;
        this.$('answerInput').value = txt;
        this.handleCheck(); // Auto submit
      };
      rec.onend = () => { this.micListening = false; this.$('micBtn').classList.remove('listening'); };
      rec.onerror = () => { this.micListening = false; this.$('micBtn').classList.remove('listening'); };

      rec.start();
      this.rec = rec;
    }

    setSpeed(val) {
      this.state.data.settings.ttsSpeed = val;
      this.saveKey('myVocaSettings', this.state.data.settings);
      this.updateSpeedUI();
      this.toast(`ë°œìŒ ì†ë„: ${val}x`);
      this.speakWord("Speed check", true); // Test sound
    }

    updateSpeedUI() {
      const s = this.state.data.settings.ttsSpeed || 1.0;
      const btns = document.querySelectorAll('.speed-btn');
      btns.forEach(b => {
        b.classList.toggle('active', parseFloat(b.innerText) === s);
      });
    }

    toggleListenMode() {
      const R = this.state.runtime;
      R.isListeningMode = !R.isListeningMode;

      // âœ… CSS(.listening-mode â€¦)ì™€ JS ìƒíƒœë¥¼ í•œ ë°©ì‹ìœ¼ë¡œ í†µì¼: body í´ë˜ìŠ¤ í† ê¸€
      document.body.classList.toggle('listening-mode', R.isListeningMode);

      const btn = this.$('listenModeBtn');
      const qBox = this.$('question');

      if (R.isListeningMode) {
        btn.innerText = 'ğŸ‘‚';
        btn.style.background = '#e84393';
        btn.style.color = '#fff';
        // ì§ˆë¬¸ í…ìŠ¤íŠ¸ëŠ” ìœ ì§€(ìˆ¨ê¹€ì€ CSSì—ì„œ ì²˜ë¦¬) â€” ë‹¤ìŒì— OFFë¡œ ëŒì•„ì˜¬ ë•Œ ë³µêµ¬ê°€ ì•ˆì „í•¨
        if (R.currentWord) qBox.innerText = R.currentWord.kan;
        this.playCurrentWordTTS();
      } else {
        btn.innerText = 'ğŸ‘ï¸';
        btn.style.background = '';
        btn.style.color = '';
        if (R.currentWord) qBox.innerText = R.currentWord.kan;
      }
      this.toast(R.isListeningMode ? 'ë¦¬ìŠ¤ë‹ ëª¨ë“œ: ON ğŸ§' : 'ë¦¬ìŠ¤ë‹ ëª¨ë“œ: OFF ğŸ‘ï¸');
    }

    printWrongNotes() {
      const D = this.state.data;
      if (D.wrongWords.length === 0) return alert('ì˜¤ë‹µ ë…¸íŠ¸ê°€ ë¹„ì–´ìˆì–´ìš”!');

      const printDiv = this.$('print-area');
      const today = new Date().toLocaleDateString();

      let html = `
        <h1 style="text-align:center; border-bottom:2px solid #333; padding-bottom:10px;">ğŸ“‘ ì˜¤ë‹µ ë…¸íŠ¸ / í…ŒìŠ¤íŠ¸ì§€</h1>
        <div style="text-align:right; margin-bottom:20px; font-weight:bold;">ë‚ ì§œ: ${today} &nbsp;&nbsp; ì´ë¦„: ____________</div>
        <table style="width:100%; border-collapse:collapse; margin-top:20px;">
          <tr style="background:#eee;">
            <th style="border:1px solid #333; padding:10px; width:10%;">No.</th>
            <th style="border:1px solid #333; padding:10px; width:40%;">ëœ» (Meaning)</th>
            <th style="border:1px solid #333; padding:10px; width:50%;">ë‹¨ì–´ ì“°ê¸° (Spelling)</th>
          </tr>
      `;

      D.wrongWords.forEach((w, i) => {
        html += `
          <tr>
            <td style="border:1px solid #333; padding:12px; text-align:center;">${i+1}</td>
            <td style="border:1px solid #333; padding:12px; font-weight:bold;">${w.kan}</td>
            <td style="border:1px solid #333; padding:12px;"></td> 
          </tr>
        `; // ë¹ˆì¹¸ìœ¼ë¡œ ì¶œë ¥
      });

      html += '</table><div style="margin-top:30px; text-align:center; color:#888;">- VOCA ë§ˆìŠ¤í„° PRO ì¸ì‡„ ëª¨ë“œ -</div>';

      printDiv.innerHTML = html;
      window.print();
    }
switchTab(key){
      this.$('panel-learn').classList.toggle('hidden', key!=='learn');
      this.$('panel-record').classList.toggle('hidden', key!=='record');
      this.$('panel-settings').classList.toggle('hidden', key!=='settings');
      this.$('panel-shop').classList.toggle('hidden', key!=='shop');
      this.$('tab-shop').classList.toggle('active', key==='shop');
      this.$('tab-shop').setAttribute('aria-selected', key==='shop');
      if(key==='shop') this.initShop();


      this.$('tab-learn').classList.toggle('active', key==='learn');
      this.$('tab-record').classList.toggle('active', key==='record');
      this.$('tab-settings').classList.toggle('active', key==='settings');

      this.$('tab-learn').setAttribute('aria-selected', key==='learn');
      this.$('tab-record').setAttribute('aria-selected', key==='record');
      this.$('tab-settings').setAttribute('aria-selected', key==='settings');

      if(key==='record'){ this.renderGrass(); this.renderBadges(); this.renderBest(); }
    }

    /* ---------- Home UI ---------- */
    calculateStreak(){
      const { attendanceData } = this.state.data;
      let streak=0;
      let d=new Date();
      const todayStr=this.dateStrOf(d);

      if(attendanceData[todayStr] && attendanceData[todayStr]>0){
        streak++; d.setDate(d.getDate()-1);
        while(attendanceData[this.dateStrOf(d)]>0){ streak++; d.setDate(d.getDate()-1); }
      }else{
        d.setDate(d.getDate()-1);
        if(attendanceData[this.dateStrOf(d)]>0){
          streak++; d.setDate(d.getDate()-1);
          while(attendanceData[this.dateStrOf(d)]>0){ streak++; d.setDate(d.getDate()-1); }
        }
      }
      return streak;
    }

    recordGrassOneWord(){
      const D = this.state.data;
      const ds = this.dateStrOf(new Date());
      D.attendanceData[ds] = (D.attendanceData[ds]||0) + 1;
      this.saveKey('myVocaAttendance', D.attendanceData);

      // ëª©í‘œ ë³´ìƒ(í•˜ë£¨ 1íšŒ)
      const goalKey = 'myVocaGoalReward_' + ds;
      if(D.attendanceData[ds] >= D.settings.dailyGoal && !localStorage.getItem(goalKey)){
        D.playerExp += 30;
        if(D.playerExp >= 100){ D.playerLevel++; D.playerExp -= 100; this.showParticles('ğŸ…'); }
        this.saveKey('myVocaLevel', D.playerLevel);
        this.saveKey('myVocaExp', D.playerExp);
        localStorage.setItem(goalKey, '1');
        this.unlockBadge('goal_1');
      }
      this.updateGoal7Badge();
    }

    renderHomeMini(){
      const D = this.state.data;
      const ds = this.dateStrOf(new Date());
      const todayCount = D.attendanceData[ds] || 0;
      const streak = this.calculateStreak();

      this.$('streak-pill').innerText = `ğŸ”¥ ì—°ì†: ${streak}ì¼`;
      this.$('today-pill').innerText = `ì˜¤ëŠ˜: ${todayCount}ë‹¨ì–´`;
      this.$('goal-pill').innerText = `ëª©í‘œ: ${D.settings.dailyGoal}`;

      if(streak >= 3) this.unlockBadge('streak_3');
      if(streak >= 7) this.unlockBadge('streak_7');
      if(streak >= 14) this.unlockBadge('streak_14');

      this.updateGameUI();
      this.checkMainButtons();
    }

    renderGrass(){
      const grid = this.$('grass-grid');
      if(!grid) return;
      const { attendanceData } = this.state.data;
      grid.innerHTML='';
      const today = new Date();
      for(let i=27;i>=0;i--){
        const d=new Date();
        d.setDate(today.getDate()-i);
        const ds=this.dateStrOf(d);
        const count=attendanceData[ds]||0;
        const box=document.createElement('div');
        box.className='grass-box';
        if(count>=15) box.classList.add('grass-lvl-4');
        else if(count>=10) box.classList.add('grass-lvl-3');
        else if(count>=5) box.classList.add('grass-lvl-2');
        else if(count>0) box.classList.add('grass-lvl-1');
        box.setAttribute('data-info', `${d.getMonth()+1}ì›” ${d.getDate()}ì¼: ${count}ê°œ`);
        grid.appendChild(box);
      }
    }

    updateGameUI(){
      const D = this.state.data;
      const R = this.state.runtime;
      const pct = Math.min((D.playerExp/100)*100, 100);

      this.$('home-level-text').innerText = `Lv. ${D.playerLevel}`;
      this.$('home-exp-text').innerText = `${D.playerExp} / 100 EXP`;
      this.$('home-exp-bar').style.width = pct + '%';

      this.$('quiz-level-text').innerText = `Lv. ${D.playerLevel}`;
      this.$('quiz-exp-bar').style.width = pct + '%';

      this.$('muteBtn').innerText = R.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      this.$('sfxBtn').innerText = D.settings.sfx ? 'ğŸ””' : 'ğŸ”•';

      // ì½¤ë³´/í”¼ë²„
      const comboEl = this.$('quiz-combo-text');
      if(R.combo >= 3){
        document.body.classList.add('fever');
        this.$('quiz-screen').classList.add('fever-glow');
        comboEl.innerText = `${R.combo} Combo! ğŸ”¥`;
      }else{
        document.body.classList.remove('fever');
        this.$('quiz-screen').classList.remove('fever-glow');
        comboEl.innerText = (R.combo > 1) ? `${R.combo} Combo!` : '';
      }
    }

    checkMainButtons(){
      const D = this.state.data;
      this.$('btn-play-custom').classList.toggle('hidden', D.customWords.length===0);
      this.$('btn-play-review').classList.toggle('hidden', D.wrongWords.length===0);
    }

    /* ---------- Badges ---------- */
    unlockBadge(id){
      const D = this.state.data;
      if(D.badges[id]) return;
      D.badges[id] = true;
      this.saveKey('myVocaBadges', D.badges);
      // ìƒˆ ë°°ì§€ëŠ” ê³¼í•˜ì§€ ì•Šê²Œ í† ìŠ¤íŠ¸
      this.toast(`ë°°ì§€ íšë“! ğŸ…`);
    }

    renderBadges(){
      const D = this.state.data;
      const wrap = this.$('badge-wrap');
      if(!wrap) return;
      wrap.innerHTML='';
      let unlocked=0;
      this.BADGE_DEF.forEach(b=>{
        const on=!!D.badges[b.id];
        if(on) unlocked++;
        const el=document.createElement('div');
        el.className='badge'+(on?'':' lock');
        el.title=b.desc;
        el.innerHTML=`${b.icon} <strong>${b.name}</strong>`;
        wrap.appendChild(el);
      });
      this.$('badge-summary').innerText = `${unlocked}/${this.BADGE_DEF.length}`;
    }

    updateGoal7Badge(){
      const D = this.state.data;
      const keys = Object.keys(D.attendanceData);
      let cnt=0;
      for(const k of keys){
        if((D.attendanceData[k]||0) >= D.settings.dailyGoal) cnt++;
      }
      if(cnt >= 7) this.unlockBadge('goal_7');
    }

    /* ---------- Settings ---------- */
    initSettingsUI(){
      const D = this.state.data;
      const goalSel=this.$('dailyGoalSelect');
      const autoSel=this.$('autoTTSSelect');
      const typoSel=this.$('typoSelect');
      const sfxSel=this.$('sfxSelect');

      goalSel.value=String(D.settings.dailyGoal||10);
      autoSel.value=D.settings.autoTTS?'on':'off';
      typoSel.value=D.settings.typoHelp?'on':'off';
      sfxSel.value=D.settings.sfx?'on':'off';

      goalSel.addEventListener('change',()=>{
        D.settings.dailyGoal=parseInt(goalSel.value);
        this.saveKey('myVocaSettings', D.settings);
        this.renderHomeMini();
        this.updateGoal7Badge();
      });
      autoSel.addEventListener('change',()=>{
        D.settings.autoTTS=(autoSel.value==='on');
        this.saveKey('myVocaSettings', D.settings);
      });
      typoSel.addEventListener('change',()=>{
        D.settings.typoHelp=(typoSel.value==='on');
        this.saveKey('myVocaSettings', D.settings);
      });
      sfxSel.addEventListener('change',()=>{
        D.settings.sfx=(sfxSel.value==='on');
        this.saveKey('myVocaSettings', D.settings);
        this.updateGameUI();
      });
    }

    /* ---------- Maker ---------- */
    openMaker(){
      this.$('setup-screen').classList.add('hidden');
      this.$('maker-screen').classList.remove('hidden');
      this.renderCustomList();
      this.$('newKan').focus();
    }
    closeMaker(){
      this.$('maker-screen').classList.add('hidden');
      this.$('setup-screen').classList.remove('hidden');
      this.renderHomeMini();
    }

    addCustomWord(){
      const D = this.state.data;
      const kan=this.$('newKan').value.trim();
      const eng=this.normalizeEng(this.$('newEng').value);
      if(!kan || !eng) return alert('ëœ»ê³¼ ì˜ë‹¨ì–´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      if(D.customWords.some(w=>this.normalizeEng(w.eng)===eng)) return alert('ì´ë¯¸ ìˆëŠ” ë‹¨ì–´ì˜ˆìš”(ì˜ì–´ ê¸°ì¤€).');
      D.customWords.push({kan,eng});
      this.saveKey('myVocaCustom', D.customWords);
      this.$('newKan').value=''; this.$('newEng').value='';
      this.renderCustomList();
      this.checkMainButtons();
    }

    renderCustomList(){
      const D = this.state.data;
      this.$('custom-count').innerText = `ì´ ${D.customWords.length}ê°œ`;
      const ul=this.$('custom-words-list');
      ul.innerHTML='';
      if(D.customWords.length===0){
        ul.innerHTML="<li style='justify-content:center; padding:14px;'>ì•„ì§ ë‹¨ì–´ê°€ ì—†ì–´ìš”.</li>";
        return;
      }
      D.customWords.forEach((w,i)=>{
        const li=document.createElement('li');
        li.innerHTML=`
          <span><b>${w.kan}</b> : ${w.eng}</span>
          <button class="mini-btn btn-danger" onclick="window.__voca.deleteCustomWord(${i})">ì‚­ì œ</button>
        `;
        ul.appendChild(li);
      });
    }

    deleteCustomWord(i){
      const D = this.state.data;
      D.customWords.splice(i,1);
      this.saveKey('myVocaCustom', D.customWords);
      this.renderCustomList();
      this.checkMainButtons();
    }

    parseBulkLine(line){
      const t=line.trim();
      if(!t) return null;
      let parts=t.split(/[\t,]/).map(x=>x.trim()).filter(Boolean);
      if(parts.length<2) parts=t.split(/\s+/);
      if(parts.length<2) return null;
      return {kan:parts[0], eng:this.normalizeEng(parts[1])};
    }

    addBulk(){
      const D = this.state.data;
      const text=this.$('bulkArea').value;
      const lines=text.split('\n');
      let added=0, skipped=0;
      for(const line of lines){
        const item=this.parseBulkLine(line);
        if(!item){ skipped++; continue; }
        if(D.customWords.some(w=>this.normalizeEng(w.eng)===item.eng)){ skipped++; continue; }
        D.customWords.push({kan:item.kan.trim(), eng:item.eng});
        added++;
      }
      this.saveKey('myVocaCustom', D.customWords);
      this.renderCustomList();
      this.checkMainButtons();
      alert(`ì™„ë£Œ! ì¶”ê°€ ${added}ê°œ / ê±´ë„ˆëœ€ ${skipped}ê°œ`);
    }

    clearBulk(){ this.$('bulkArea').value=''; }

    exportCustom(){
      const D = this.state.data;
      const payload={ type:"customWords", customWords:D.customWords, exportedAt:new Date().toISOString() };
      this.$('backupArea').value=JSON.stringify(payload);
    }

    async copyBackup(){
      const val=this.$('backupArea').value.trim();
      if(!val) return alert('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ì–´ìš”.');
      try{ await navigator.clipboard.writeText(val); alert('ë³µì‚¬ ì™„ë£Œ!'); }
      catch{ alert('ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ). ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.'); }
    }

    importCustom(){
      const D = this.state.data;
      const val=this.$('backupArea').value.trim();
      if(!val) return alert('ê°€ì ¸ì˜¬ JSONì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.');
      try{
        const obj=JSON.parse(val);
        const list=obj.customWords || obj.words || [];
        if(!Array.isArray(list)) throw new Error();
        let added=0;
        for(const w of list){
          if(!w?.kan || !w?.eng) continue;
          const eng=this.normalizeEng(w.eng);
          if(D.customWords.some(x=>this.normalizeEng(x.eng)===eng)) continue;
          D.customWords.push({kan:String(w.kan).trim(), eng});
          added++;
        }
        this.saveKey('myVocaCustom', D.customWords);
        this.renderCustomList();
        this.checkMainButtons();
        alert(`ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! ì¶”ê°€ ${added}ê°œ`);
      }catch{
        alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.');
      }
    }

    /* ---------- Quiz ---------- */
    buildWrongReviewList(){
      const D = this.state.data;
      const sorted=[...D.wrongWords].sort((a,b)=>{
        const aw=a.wrongCount||1, bw=b.wrongCount||1;
        const al=a.lastWrong||0, bl=b.lastWrong||0;
        if(bw!==aw) return bw-aw;
        return bl-al;
      });
      return sorted.slice(0,40).map(w=>({kan:w.kan, eng:w.eng}));
    }

    initQuiz(category){
      const D = this.state.data;
      const R = this.state.runtime;

      clearInterval(R.timerInterval);
      this.$('timer-display').classList.add('hidden');
      this.$('timer-display').classList.remove('danger');

      this.$('hintArea').style.display='none';
      this.$('hintArea').innerHTML='';
      this.$('feedback').innerText='';
      this.$('nearBanner').style.display='none';
      this.$('nearBanner').innerText='';

      R.attempts=0; R.correctCount=0; R.combo=0; R.score=0;
      R.isTimeMode = (category==='time');

      if(category==='time') R.currentList=[...this.wordBank.verbs,...this.wordBank.nouns,...this.wordBank.adjectives,...D.customWords];
      else if(category==='dictation') {
        R.currentList=[...this.wordBank.verbs,...this.wordBank.nouns,...this.wordBank.adjectives,...D.customWords];
        R.isListeningMode = true;
      }
      else if(category==='custom') R.currentList=[...D.customWords];
      else if(category==='wrong') R.currentList=this.buildWrongReviewList();
      else R.currentList=[...this.wordBank[category]];

      // í•œë²ˆ ì„ê³ (ì¤‘ë³µ ì¶œì œ ë°©ì§€) ìˆœì„œëŒ€ë¡œ ì§„í–‰
      this.shuffle(R.currentList);

      if(!R.currentList.length){
        alert('ë‹¨ì–´ê°€ ì—†ì–´ìš”! ë¨¼ì € ë‹¨ì–´ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ë‹¤ë¥¸ ëª¨ë“œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      this.$('setup-screen').classList.add('hidden');
      this.$('quiz-screen').classList.remove('hidden');

      this.updateGameUI();
      this.updateStatsUI();

      // ë¦¬ìŠ¤ë‹ ëª¨ë“œ(ë°›ì•„ì“°ê¸° ë“±)ì¼ ë•Œ ë²„íŠ¼ UI ë°˜ì˜
      if(R.isListeningMode){
        const btn = this.$('listenModeBtn');
        if(btn){ btn.innerText='ğŸ‘‚'; btn.style.background='#e84393'; btn.style.color='#fff'; }
      }else{
        const btn = this.$('listenModeBtn');
        if(btn){ btn.innerText='ğŸ‘ï¸'; btn.style.background=''; btn.style.color=''; }
      }

      if(R.isTimeMode) this.startTimer();
      this.nextQuestion(true);
    }

    startTimer(){
      const R = this.state.runtime;
      R.timeLeft=60;
      R.timeModeStart=Date.now();
      const el=this.$('timer-display');
      el.classList.remove('hidden');
      this.$('time-left').innerText=R.timeLeft;

      R.timerInterval=setInterval(()=>{
        R.timeLeft--;
        this.$('time-left').innerText=R.timeLeft;
        if(R.timeLeft<=10) el.classList.add('danger');
        if(R.timeLeft<=5 && R.timeLeft>0) this.playSound('tick');
        if(R.timeLeft<=0){
          this.playSound('wrong');
          alert('â° íƒ€ì„ ì˜¤ë²„! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.');
          this.showResult();
        }
      },1000);
    }

    nextQuestion(isFirst=false){
      const D = this.state.data;
      const R = this.state.runtime;
      if(R.currentList.length===0) return this.showResult();
      R.currentWord = R.currentList[0];

      const q=this.$('question');
      q.classList.add('flip-out');
      setTimeout(()=>{
        
    if (R.isListeningMode) {
        q.innerHTML = '<div style="font-size:3rem;">ğŸ”Š</div><div style="font-size:1rem; color:#666;">ë“£ê³  ì“°ê¸°</div>';
        setTimeout(() => this.playCurrentWordTTS(), 300);
    } else {
        q.innerText = R.currentWord.kan;
    }
;
        q.classList.remove('flip-out');
        q.classList.add('flip-in');
        setTimeout(()=>q.classList.remove('flip-in'), 200);
      }, 200);

      this.$('remaining').innerText=R.currentList.length;
      this.$('answerInput').value='';
      this.$('answerInput').focus();
      this.$('feedback').innerText='';
      this.$('hintArea').style.display='none';
      this.$('hintArea').innerHTML='';
      this.$('nearBanner').style.display='none';
      this.$('nearBanner').innerText='';

      if(D.settings.autoTTS){
        if(isFirst) setTimeout(()=>this.speakWord(R.currentWord.eng), 250);
        else this.speakWord(R.currentWord.eng);
      }
    }

    updateStatsUI(){
      const R = this.state.runtime;
      this.$('score').innerText=R.score;
      this.$('attempts').innerText=R.attempts;
      const acc = R.attempts===0 ? 0 : Math.round((R.correctCount/R.attempts)*100);
      this.$('accuracy').innerText=acc;
    }

    playCurrentWordTTS(){
      const R = this.state.runtime;
      if(R.currentWord) this.speakWord(R.currentWord.eng);
      this.$('answerInput').focus();
    }

    showHint(){
      const R = this.state.runtime;
      if(!R.currentWord) return;
      const correct=this.normalizeEng(R.currentWord.eng);
      const masked=correct.split('').map((ch,i)=> (i===0?ch:'_')).join(' ');
      const hint=this.$('hintArea');
      hint.style.display='block';
      hint.innerHTML=`íŒíŠ¸: <span style="font-size:1.08rem;">${masked}</span>
        <small>ì²« ê¸€ì '${correct[0]}' Â· ê¸€ì ìˆ˜ ${correct.length} (íŒíŠ¸ ì‚¬ìš© ì‹œ EXP ê°ì†Œ)</small>`;
    }

    upsertWrong(word){
      const D = this.state.data;
      const eng=this.normalizeEng(word.eng);
      const now=Date.now();
      if(D.masterWords.some(w=>this.normalizeEng(w.eng)===eng)) return;

      const idx=D.wrongWords.findIndex(w=>this.normalizeEng(w.eng)===eng);
      if(idx===-1){
        D.wrongWords.push({kan:word.kan, eng, wrongCount:1, lastWrong:now});
      }else{
        D.wrongWords[idx].wrongCount=(D.wrongWords[idx].wrongCount||1)+1;
        D.wrongWords[idx].lastWrong=now;
        D.wrongWords[idx].kan=word.kan;
      }
      this.saveKey('myVocaWrongWords', D.wrongWords);
      this.checkMainButtons();
    }

    handleCheck(){
      const D = this.state.data;
      const R = this.state.runtime;
      if(!R.currentWord) return;

      const input=this.normalizeEng(this.$('answerInput').value);
      const correct=this.normalizeEng(R.currentWord.eng);
      const feedback=this.$('feedback');

      R.attempts++;

      let isCorrect=(input===correct);
      let isNear=false;
      if(!isCorrect && D.settings.typoHelp && input.length>0){
        const dist=this.levenshtein(input, correct);
        if(dist===1 && Math.max(input.length, correct.length)>=4) isNear=true;
      }

      const usedHint = (this.$('hintArea').style.display !== 'none');

      if(isCorrect || isNear){
        R.correctCount++;
        R.combo++;

        let earnedExp = 20 + (R.combo*5);
        if(usedHint) earnedExp = Math.floor(earnedExp*0.3);
        if(isNear) earnedExp = Math.floor(earnedExp*0.7);

        D.playerExp += earnedExp;
        const coin = (isNear ? 1 : 2) * (R.isBossMode ? 5 : 1);
        this.addCoin(coin);
        if(R.isBossMode) this.bossAttack(100 + (R.combo * 10));

        R.score++;

        this.recordGrassOneWord();

        if(D.playerExp >= 100){
          D.playerLevel++;
          D.playerExp -= 100;
          this.playSound('levelup');
          this.showParticles('ğŸŒŸ');
        }else{
          this.playSound('correct');
          this.showParticles(isNear ? 'ğŸŸ¡' : 'âœ¨');
        }

        this.saveKey('myVocaLevel', D.playerLevel);
        this.saveKey('myVocaExp', D.playerExp);

        this.updateGameUI();
        this.updateStatsUI();
        this.speakWord(correct);

        if(isNear){
          // âœ… ìš”ì²­ ë°˜ì˜: ì˜¤íƒ€ ì •ë‹µ ì‹œê°ì  í”¼ë“œë°± ê°•í™”
          const banner=this.$('nearBanner');
          banner.style.display='block';
          banner.innerText = "âš ï¸ ì˜¤íƒ€ê°€ ìˆì§€ë§Œ ì •ë‹µìœ¼ë¡œ ì¸ì •ë©ë‹ˆë‹¤!";
          feedback.innerHTML = `ê±°ì˜ ì •ë‹µ! âœ… (+${earnedExp} EXP)`;
          feedback.className='near';
        }else{
          feedback.innerHTML = `ì •ë‹µì…ë‹ˆë‹¤! (+${earnedExp} EXP) âœ¨`;
          feedback.className='correct';
        }
        // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°(ìˆœì„œ ì§„í–‰)
        R.currentList.shift();

        this.updateGoal7Badge();
        this.renderHomeMini();

        setTimeout(()=>this.nextQuestion(), 450);

      }else{
        R.combo=0;
        this.updateGameUI();
        this.updateStatsUI();
        this.playSound('wrong');
        this.speakWord(correct, true);
        if(R.isBossMode) {
          R.timeLeft = Math.max(0, R.timeLeft - 5);
          this.toast('ë³´ìŠ¤ ê³µê²©! ì‹œê°„ -5ì´ˆ ğŸ˜±');
        }


        this.$('quiz-screen').classList.add('shake-animation');
        setTimeout(()=>this.$('quiz-screen').classList.remove('shake-animation'), 400);

        feedback.innerHTML = `í‹€ë ¸ì–´ìš”! ì •ë‹µì€ <b>${correct}</b>`;
        feedback.className='wrong';

        this.upsertWrong(R.currentWord);

        setTimeout(()=>this.nextQuestion(), 900);
      }
    }

    toggleMute(){
      const R = this.state.runtime;
      R.isMuted=!R.isMuted;
      this.updateGameUI();
      if(R.isMuted) window.speechSynthesis.cancel();
    }

    toggleSfx(){
      const D = this.state.data;
      D.settings.sfx=!D.settings.sfx;
      this.saveKey('myVocaSettings', D.settings);
      this.updateGameUI();
    }

    /* ---------- Result + Logging ---------- */
    logSession(mode, score, attempts, accuracy, wpm){
      const D = this.state.data;
      const ts=Date.now();
      D.progress.history.unshift({ts, mode, score, attempts, accuracy, wpm});
      const ds=this.dateStrOf(new Date());
      D.progress.daily[ds]=D.progress.daily[ds] || {correct:0, attempts:0, timeAttackBest:0};
      D.progress.daily[ds].correct += score;
      D.progress.daily[ds].attempts += attempts;
      if(mode==='time') D.progress.daily[ds].timeAttackBest = Math.max(D.progress.daily[ds].timeAttackBest||0, score);
      this.saveKey('myVocaProgress', D.progress);
    }

    showResult(){
      const D = this.state.data;
      const R = this.state.runtime;

      clearInterval(R.timerInterval);
      document.body.classList.remove('fever');

      this.$('quiz-screen').classList.add('hidden');
      this.$('result-screen').classList.remove('hidden');
      this.$('final-score').innerText = `ìµœì¢… ì ìˆ˜: ${R.score}ì `;

      const acc = R.attempts===0 ? 0 : Math.round((R.correctCount/R.attempts)*100);
      const wpm = R.isTimeMode ? Math.round((R.score / Math.max(1, Math.round((Date.now()-R.timeModeStart)/1000))) * 60) : 0;
      this.logSession(R.isTimeMode ? 'time' : 'normal', R.score, R.attempts, acc, wpm);

      this.renderWrongList();
      this.renderMasterList();

      if(R.isTimeMode){
        const elapsedSec = Math.max(1, Math.round((Date.now()-R.timeModeStart)/1000));
        const wpm2 = Math.round((R.score/elapsedSec)*60);

        this.$('time-extra').classList.remove('hidden');
        this.$('time-stats').innerHTML =
          `- ì´ ì‹œë„: ${R.attempts}íšŒ<br/>- ì •ë‹µ: ${R.correctCount}íšŒ<br/>- ì •í™•ë„: ${acc}%<br/>- ë¶„ë‹¹ ì •ë‹µ: ${wpm2}ê°œ/ë¶„`;

        let isBest=false;
        if(R.score > (D.bestTimeAttack.bestScore||0)){
          D.bestTimeAttack.bestScore=R.score;
          D.bestTimeAttack.bestAccuracy=acc;
          D.bestTimeAttack.bestWpm=wpm2;
          isBest=true;
        }
        this.saveKey('myVocaBestTimeAttack', D.bestTimeAttack);

        if(R.score >= 15) this.unlockBadge('time_15');
        if(isBest) this.unlockBadge('time_best');

        this.$('best-badge').innerHTML = isBest
          ? `ğŸ‰ <span style="color:var(--danger);">ìµœê³  ê¸°ë¡ ê°±ì‹ !</span>`
          : `ìµœê³  ê¸°ë¡: ${D.bestTimeAttack.bestScore}ì  (ì •í™•ë„ ${D.bestTimeAttack.bestAccuracy}% Â· ${D.bestTimeAttack.bestWpm}ê°œ/ë¶„)`;
      }else{
        this.$('time-extra').classList.add('hidden');
      }

      if(D.masterWords.length >= 10) this.unlockBadge('master_10');

      this.renderHomeMini();
    }

    renderWrongList(){
      const D = this.state.data;
      const ul=this.$('wrong-items');
      ul.innerHTML='';
      if(D.wrongWords.length===0){
        ul.innerHTML="<li style='justify-content:center; padding:14px;'>ëˆ„ì  ì˜¤ë‹µì´ ì—†ì–´ìš”! ğŸ†</li>";
        return;
      }
      const sorted=[...D.wrongWords].sort((a,b)=>(b.wrongCount||1)-(a.wrongCount||1));
      sorted.forEach(w=>{
        const li=document.createElement('li');
        li.innerHTML=`
          <span><b>${w.kan}</b> : ${w.eng} <span style="opacity:.7; font-weight:900;">(ì˜¤ë‹µ ${w.wrongCount||1}íšŒ)</span></span>
          <div style="display:flex; gap:8px;">
            <button class="mini-btn btn-primary" onclick="window.__voca.moveToMaster('${w.eng}')">ìˆ™ë ¨ ğŸ†</button>
            <button class="mini-btn btn-danger" onclick="window.__voca.removeWrongWord('${w.eng}')">ì‚­ì œ</button>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    renderMasterList(){
      const D = this.state.data;
      const ul=this.$('master-items');
      ul.innerHTML='';
      if(D.masterWords.length===0){
        ul.innerHTML="<li style='justify-content:center; padding:14px;'>ì•„ì§ ìˆ™ë ¨ ë‹¨ì–´ê°€ ì—†ì–´ìš”.</li>";
        return;
      }
      D.masterWords.forEach(w=>{
        const li=document.createElement('li');
        li.innerHTML=`
          <span><b>${w.kan}</b> : ${w.eng}</span>
          <button class="mini-btn btn-gray" onclick="window.__voca.removeMaster('${w.eng}')">ì œê±°</button>
        `;
        ul.appendChild(li);
      });
    }

    removeWrongWord(eng){
      const D = this.state.data;
      const e=this.normalizeEng(eng);
      D.wrongWords=D.wrongWords.filter(w=>this.normalizeEng(w.eng)!==e);
      this.saveKey('myVocaWrongWords', D.wrongWords);
      this.renderWrongList();
      this.checkMainButtons();
    }

    moveToMaster(eng){
      const D = this.state.data;
      const e=this.normalizeEng(eng);
      const w=D.wrongWords.find(x=>this.normalizeEng(x.eng)===e);
      if(!w) return;
      if(!D.masterWords.some(x=>this.normalizeEng(x.eng)===e)){
        D.masterWords.push({kan:w.kan, eng:e, masteredAt:Date.now()});
        this.saveKey('myVocaMasterWords', D.masterWords);
        this.showParticles('ğŸ†');
      }
      D.wrongWords=D.wrongWords.filter(x=>this.normalizeEng(x.eng)!==e);
      this.saveKey('myVocaWrongWords', D.wrongWords);

      if(D.masterWords.length>=10) this.unlockBadge('master_10');

      this.renderWrongList();
      this.renderMasterList();
      this.checkMainButtons();
    }

    removeMaster(eng){
      const D = this.state.data;
      const e=this.normalizeEng(eng);
      D.masterWords=D.masterWords.filter(w=>this.normalizeEng(w.eng)!==e);
      this.saveKey('myVocaMasterWords', D.masterWords);
      this.renderMasterList();
    }

    /* ---------- Best + CSV ---------- */
    renderBest(){
      const D = this.state.data;
      this.$('best-time-score').innerText = `${D.bestTimeAttack.bestScore||0}ì `;
      this.$('bestScoreVal').innerText = D.bestTimeAttack.bestScore||0;
      this.$('bestAccVal').innerText = D.bestTimeAttack.bestAccuracy||0;
      this.$('bestWpmVal').innerText = D.bestTimeAttack.bestWpm||0;
    }

    resetBest(){
      const D = this.state.data;
      D.bestTimeAttack={bestScore:0,bestWpm:0,bestAccuracy:0};
      this.saveKey('myVocaBestTimeAttack', D.bestTimeAttack);
      this.renderBest();
      alert('ìµœê³  ê¸°ë¡ì„ ì´ˆê¸°í™”í–ˆì–´ìš”!');
    }

    exportCSV(){
      const D = this.state.data;
      const rows=[["date","correct","attempts","accuracy","timeAttackBest"]];
      const keys=Object.keys(D.progress.daily).sort();
      for(const k of keys){
        const d=D.progress.daily[k];
        const acc = d.attempts ? Math.round((d.correct/d.attempts)*100) : 0;
        rows.push([k, d.correct||0, d.attempts||0, acc, d.timeAttackBest||0]);
      }
      const csv=rows.map(r=>r.join(",")).join("\n");
      const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download="voca_progress.csv";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      this.toast("CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘!");
    }

    /* ---------- Admin (í•™ìƒì´ ì§ì ‘ ê´€ë¦¬) ---------- */
    openAdmin(){
      this.$('setup-screen').classList.add('hidden');
      this.$('admin-screen').classList.remove('hidden');
      this.renderSetList();
    }

    closeAdmin(){
      this.$('admin-screen').classList.add('hidden');
      this.$('setup-screen').classList.remove('hidden');
      this.renderHomeMini();
    }

    clearSetForm(){
      this.$('setName').value='';
      this.$('setBulk').value='';
    }

    parseSetBulk(text){
      const lines=(text||'').split('\n');
      const words=[];
      for(const line of lines){
        const item=this.parseBulkLine(line);
        if(item && !words.some(w=>this.normalizeEng(w.eng)===this.normalizeEng(item.eng))){
          words.push({kan:String(item.kan).trim(), eng:this.normalizeEng(item.eng)});
        }
      }
      return words;
    }

    saveSet(){
      const D = this.state.data;
      const name=this.$('setName').value.trim();
      const bulk=this.$('setBulk').value;
      if(!name) return alert('ì„¸íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      const words=this.parseSetBulk(bulk);
      if(words.length===0) return alert('ë‹¨ì–´ê°€ 1ê°œ ì´ìƒ í•„ìš”í•´ìš”.');

      const set={ id:'set_'+Date.now(), name, createdAt:Date.now(), words };
      D.sets.unshift(set);
      this.saveKey('myVocaSets', D.sets);
      this.renderSetList();
      this.clearSetForm();
      this.toast(`ì„¸íŠ¸ ì €ì¥ ì™„ë£Œ! (${words.length}ê°œ)`);
    }

    renderSetList(){
      const D = this.state.data;
      const ul=this.$('setList');
      ul.innerHTML='';
      if(D.sets.length===0){
        ul.innerHTML="<li style='justify-content:center; padding:14px;'>ì €ì¥ëœ ì„¸íŠ¸ê°€ ì—†ì–´ìš”.</li>";
        return;
      }
      D.sets.forEach(s=>{
        const li=document.createElement('li');
        li.innerHTML=`
          <span>
            <b>${s.name}</b>
            <div class="mini" style="margin-top:4px;">${(s.words||[]).length}ê°œ</div>
          </span>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="mini-btn btn-primary" onclick="window.__voca.applySet('${s.id}')">ì ìš©</button>
            <button class="mini-btn btn-dark" onclick="window.__voca.selectSet('${s.id}')">ë‚´ë³´ë‚´ê¸°</button>
            <button class="mini-btn btn-danger" onclick="window.__voca.deleteSet('${s.id}')">ì‚­ì œ</button>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    selectSet(id){
      const D = this.state.data;
      const s=D.sets.find(x=>x.id===id);
      if(!s) return;
      const payload={ type:"vocaSet", name:s.name, words:s.words, exportedAt:new Date().toISOString() };
      this.$('adminExport').value=JSON.stringify(payload);
      this.toast("ë‚´ë³´ë‚´ê¸° JSON ìƒì„±!");
    }

    deleteSet(id){
      const D = this.state.data;
      D.sets=D.sets.filter(x=>x.id!==id);
      this.saveKey('myVocaSets', D.sets);
      this.renderSetList();
      this.toast("ì„¸íŠ¸ë¥¼ ì‚­ì œí–ˆì–´ìš”.");
    }

    applySet(id){
      const D = this.state.data;
      const s=D.sets.find(x=>x.id===id);
      if(!s) return;
      const before = D.customWords.length;
      const addList = Array.isArray(s.words) ? s.words : [];
      for(const w of addList){
        if(!w?.kan || !w?.eng) continue;
        const eng=this.normalizeEng(w.eng);
        if(D.customWords.some(x=>this.normalizeEng(x.eng)===eng)) continue;
        D.customWords.push({ kan:String(w.kan).trim(), eng });
      }
      const added = D.customWords.length - before;
      this.saveKey('myVocaCustom', D.customWords);
      this.checkMainButtons();
      this.toast(`ì„¸íŠ¸ ì ìš©: ${added}ê°œ ì¶”ê°€ë¨`);
    }

    async copyAdminExport(){
      const val=this.$('adminExport').value.trim();
      if(!val) return alert('ë¨¼ì € ì„¸íŠ¸ë¥¼ â€œë‚´ë³´ë‚´ê¸°â€ë¡œ ì„ íƒí•´ JSONì„ ìƒì„±í•˜ì„¸ìš”.');
      try{ await navigator.clipboard.writeText(val); this.toast('JSON ë³µì‚¬ ì™„ë£Œ!'); }
      catch{ alert('ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ). ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.'); }
    }

    importSetJSON(){
      const D = this.state.data;
      const val=this.$('adminImport').value.trim();
      if(!val) return alert('ê°€ì ¸ì˜¬ ì„¸íŠ¸ JSONì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.');
      try{
        const obj=JSON.parse(val);
        if(obj.type !== 'vocaSet') return alert('ì„¸íŠ¸ JSON í˜•ì‹ì´ ì•„ë‹ˆì—ìš”.');
        const name = String(obj.name||'ê°€ì ¸ì˜¨ ì„¸íŠ¸').trim();
        const words = Array.isArray(obj.words) ? obj.words : [];
        const cleaned = [];
        for(const w of words){
          if(!w?.kan || !w?.eng) continue;
          const eng=this.normalizeEng(w.eng);
          if(cleaned.some(x=>this.normalizeEng(x.eng)===eng)) continue;
          cleaned.push({ kan:String(w.kan).trim(), eng });
        }
        if(cleaned.length===0) return alert('ì„¸íŠ¸ì— ë‹¨ì–´ê°€ ì—†ì–´ìš”.');
        const set={ id:'set_'+Date.now(), name, createdAt:Date.now(), words:cleaned };
        D.sets.unshift(set);
        this.saveKey('myVocaSets', D.sets);
        this.renderSetList();
        this.toast(`ì„¸íŠ¸ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! (${cleaned.length}ê°œ)`);
      }catch{
        alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.');
      }
    }

    /* ---------- Init ---------- */
    init(){
      this.loadAll();
      this.initSettingsUI();
      this.renderBest();
      this.renderHomeMini();
      this.renderGrass();
      this.renderBadges();

      // iOS ì…ë ¥ ì•ˆì •í™”(ìë™ ëŒ€ë¬¸ì/ìë™ ìˆ˜ì • ìµœì†Œí™”)
      document.querySelectorAll('input,textarea,select').forEach((el)=>{
        el.setAttribute('autocapitalize','none');
        el.setAttribute('autocorrect','off');
        el.setAttribute('spellcheck','false');
      });

      // ì—”í„° ì œì¶œ
      this.$('answerInput').addEventListener('keydown',(e)=>{
        if(e.key==='Enter') this.handleCheck();
      });

      // ì²« ì‹¤í–‰ ì•ˆë‚´(ë°ì´í„° ë³µêµ¬ ì•Œë¦¼ê³¼ ë¶„ë¦¬)
      this.toast("ì¤€ë¹„ ì™„ë£Œ! ì˜¤ëŠ˜ ëª©í‘œë¶€í„° ê°€ë³¼ê¹Œìš”? ğŸš€");
    }
  }

  // ì•± ì¸ìŠ¤í„´ìŠ¤ ìƒì„± + ì „ì—­ ì ‘ê·¼ ìµœì†Œí™”(ë”± 1ê°œë§Œ)
  window.__voca = new VocaApp();
  window.__voca.init();

})();
</script>
<div id="print-area"></div>
  <script>
    const manifestData={name:"VOCA ë§ˆìŠ¤í„° PRO V3 GodMode",short_name:"VOCA PRO",start_url:"./",display:"standalone",background_color:"#f0f2f5",theme_color:"#3498db",icons:[{src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%233498db' width='100' height='100'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3EğŸ§%3C/text%3E%3C/svg%3E",sizes:"512x512",type:"image/svg+xml"}]};
    const b=new Blob([JSON.stringify(manifestData)],{type:'application/json'});
    document.getElementById('manifest-placeholder').setAttribute('href',URL.createObjectURL(b));

    if('serviceWorker' in navigator){
      const sw=`const C='voca-v2-cache';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['./'])));self.skipWaiting()});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{return caches.open(C).then(c=>{if(e.request.method==='GET')c.put(e.request,res.clone());return res})}).catch(()=>caches.match('./'))))});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(k=>Promise.all(k.map(n=>n!==C&&caches.delete(n)))));return self.clients.claim()});`;
      navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'})));
    }
    // Init Speed UI on load
    window.addEventListener('load', ()=>{ try{ window.__voca.updateSpeedUI(); }catch{} });
  </script>
</body>
</html>
